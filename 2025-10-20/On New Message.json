{"createdAt":"2025-10-14T22:21:22.998Z","updatedAt":"2025-10-20T22:30:17.331Z","id":"NOs8uISgMND4NjBf","name":"On New Message","active":true,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[0,32],"id":"88f8c517-5375-4864-adfb-09bf7c3fff88","name":"When clicking â€˜Execute workflowâ€™","disabled":true},{"parameters":{"phoneNumberId":"749915891538765","recipientPhoneNumber":"+573195884149","template":"hello_world|en_US"},"type":"n8n-nodes-base.whatsApp","typeVersion":1.1,"position":[448,32],"id":"c9605214-b3c1-4ba1-b8bf-bb786158a0c4","name":"Send message and wait for response","webhookId":"aa8e5c28-b27c-4340-bdef-e0a22c788e94","credentials":{"whatsAppApi":{"id":"hn7HYT0djID7QTau","name":"WhatsApp account"}},"disabled":true},{"parameters":{"updates":["messages"],"options":{}},"type":"n8n-nodes-base.whatsAppTrigger","typeVersion":1,"position":[0,-192],"id":"f15e8ff2-6e90-4a5b-8fb1-eeb74b115934","name":"WhatsApp Trigger","webhookId":"9c276208-4753-4cad-9db7-3f9aea7b200c","credentials":{"whatsAppTriggerApi":{"id":"E6zgzaiMKkzeqacR","name":"WhatsApp OAuth account"}}},{"parameters":{"operation":"send","phoneNumberId":"749915891538765","recipientPhoneNumber":"+573195884149","textBody":":)","additionalFields":{}},"type":"n8n-nodes-base.whatsApp","typeVersion":1.1,"position":[224,32],"id":"32114d1b-d6fb-4d65-8595-cf2fef8305df","name":"Send message","webhookId":"6cdfa395-548b-477e-b41d-ae5117358a8a","credentials":{"whatsAppApi":{"id":"hn7HYT0djID7QTau","name":"WhatsApp account"}},"disabled":true},{"parameters":{"operation":"executeQuery","query":"SELECT dev.get_whatsapp_user('{{ $json.contacts[0].wa_id }}');","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[448,-192],"id":"895df53b-f14c-475c-8386-90d999e54037","name":"Find User by WhatsApp ID","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4e2daa52-5c2f-46ab-a36d-9801b6a117dd","leftValue":"={{ $json.get_whatsapp_user }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[672,-192],"id":"f7d4615b-fa66-4f20-b8d6-e4a3ae21e639","name":"Found?"},{"parameters":{"claims":{"audience":"={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}","expiresIn":3600,"issuer":"https://cal.hellotomo.ai","subject":"Sign Up Token"},"options":{}},"type":"n8n-nodes-base.jwt","typeVersion":1,"position":[896,-192],"id":"0b8d8422-1d1e-48ae-b490-5561600454b0","name":"JWT","credentials":{"jwtAuth":{"id":"If5sPQiUpF5hHoiV","name":"JWT Auth account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b2971a46-fdc6-41c9-bceb-6573a287f960","leftValue":"={{ $json.keys().includes(\"statuses\") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[224,-192],"id":"b7e98794-fd5d-4553-b52e-307e6c4dd9e9","name":"Ignore?"},{"parameters":{"jsCode":"// In N8N - Enhanced OAuth URL\nconst scope = 'email profile https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/contacts.readonly';\nconst state = $('JWT').first().json.token;\n\nconst oauthUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +\n  `client_id=${$input.first().json.client_id}&` +\n  `redirect_uri=${encodeURIComponent($input.first().json.redirect_url)}&` +\n  `response_type=code&` +\n  `scope=${encodeURIComponent(scope)}&` +\n  `state=${state}&` +\n  `access_type=offline&` +\n  `prompt=consent&` +\n  `include_granted_scopes=true`;\n\nreturn {\n  json: { oauthUrl }\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1376,-192],"id":"693e15ab-80cc-457e-9558-abf3cf902e98","name":"Build OAuth URL"},{"parameters":{"operation":"get","dataTableId":{"__rl":true,"value":"f7S9Bc3z5vlZ9piZ","mode":"list","cachedResultName":"google_oauth_config","cachedResultUrl":"/projects/8nyfoRCh3nEYWaKJ/datatables/f7S9Bc3z5vlZ9piZ"},"limit":1},"type":"n8n-nodes-base.dataTable","typeVersion":1,"position":[1104,-192],"id":"53369f9d-e564-4a4b-8ed1-0dc817cc2cff","name":"Get Google OAuth Config"},{"parameters":{"operation":"send","phoneNumberId":"749915891538765","recipientPhoneNumber":"=+{{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}","textBody":"=Please sign up here: {{ $json.oauthUrl }}","additionalFields":{}},"type":"n8n-nodes-base.whatsApp","typeVersion":1.1,"position":[1600,-192],"id":"a2b6b7ea-db35-4e08-98e6-032ef62bc0e3","name":"Send Sign Up URL","webhookId":"6cdfa395-548b-477e-b41d-ae5117358a8a","credentials":{"whatsAppApi":{"id":"hn7HYT0djID7QTau","name":"WhatsApp account"}}}],"connections":{"When clicking â€˜Execute workflowâ€™":{"main":[[{"node":"Send message","type":"main","index":0}]]},"Send message":{"main":[[{"node":"Send message and wait for response","type":"main","index":0}]]},"WhatsApp Trigger":{"main":[[{"node":"Ignore?","type":"main","index":0}]]},"Find User by WhatsApp ID":{"main":[[{"node":"Found?","type":"main","index":0}]]},"Found?":{"main":[[],[{"node":"JWT","type":"main","index":0}]]},"JWT":{"main":[[{"node":"Get Google OAuth Config","type":"main","index":0}]]},"Ignore?":{"main":[[],[{"node":"Find User by WhatsApp ID","type":"main","index":0}]]},"Build OAuth URL":{"main":[[{"node":"Send Sign Up URL","type":"main","index":0}]]},"Get Google OAuth Config":{"main":[[{"node":"Build OAuth URL","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"WhatsApp Trigger":[{"json":{"messaging_product":"whatsapp","metadata":{"display_phone_number":"15551366684","phone_number_id":"749915891538765"},"contacts":[{"profile":{"name":"AM III ðŸ‘‘"},"wa_id":"573195884149"}],"messages":[{"from":"573195884149","id":"wamid.HBgMNTczMTk1ODg0MTQ5FQIAEhggQUNGMTE0NTM2QTJDRDM2QTc1QjNENTk3NTNENEQwOTQA","timestamp":"1760991583","text":{"body":"Hello?"},"type":"text"}],"field":"messages"}}]},"versionId":"11a3b24d-b2a5-4bc6-a9bd-3ba2ead4435c","triggerCount":1,"shared":[{"createdAt":"2025-10-14T22:21:22.998Z","updatedAt":"2025-10-14T22:21:22.998Z","role":"workflow:owner","workflowId":"NOs8uISgMND4NjBf","projectId":"8nyfoRCh3nEYWaKJ"}],"tags":[]}