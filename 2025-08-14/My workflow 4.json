{"createdAt":"2025-08-14T22:23:17.437Z","updatedAt":"2025-08-14T22:40:53.649Z","id":"wAHFZlhKjbl0UA56","name":"My workflow 4","active":false,"isArchived":false,"nodes":[{"parameters":{"operation":"getAll","tableId":"users","returnAll":true},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[224,320],"id":"ff4d49c0-5e21-41ba-83cb-d0c3ea061e62","name":"Get Users","credentials":{"supabaseApi":{"id":"PwJN4yKDRZqivq2f","name":"Supabase account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"79e8b3d9-b0d1-4837-b9c0-3b43628d6ee4","leftValue":"={{ $json.access_token_2 }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"ec44bd2f-ef92-4739-ad92-206eac8e9396","leftValue":"={{ $json.access_token_2 }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}},{"id":"9df1debe-14b3-476c-92e6-06f3eb9e0d9e","leftValue":"={{ $json.refresh_token_2 }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"20fa9d20-abb4-44ad-86c1-3da1d45e9b8e","leftValue":"={{ $json.refresh_token_2 }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}},{"id":"859e0653-6403-4471-8b4c-cf1da741265b","leftValue":"={{ $json.client_id_2 }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"b6bc3d3a-b594-49d5-8139-c0b77c4cc781","leftValue":"={{ $json.client_id_2 }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}},{"id":"7f739a64-dfb4-480e-be1f-55a5b6ca32ce","leftValue":"={{ $json.client_secret_2 }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"3288274a-5dab-4106-b9b8-0cd52fbf89a3","leftValue":"={{ $json.client_secret_2 }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}},{"id":"4fe756a0-299e-4dfd-856f-e1c95d230648","leftValue":"={{ $json.telegram_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"67fe63f6-bf25-46f9-b32e-cd79349a607f","leftValue":"={{ $json.telegram_id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[448,320],"id":"a4d75ddf-5746-4035-ac4a-4852ce443f15","name":"Keep Authenticated Users"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[672,320],"id":"4c91fa13-87b7-4290-bc69-9201c646bf87","name":"Loop Over Items"},{"parameters":{"workflowId":{"__rl":true,"value":"uu7semjX1n1iWDt6","mode":"list","cachedResultName":"[Signal] Vectorize Single User Contacts"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $json.id }}"},"matchingColumns":["user_id"],"schema":[{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"mode":"each","options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2064,-32],"id":"63b4f20c-b261-4c45-84e7-1d9ce8c43838","name":"Vectorize User Contacts","disabled":true},{"parameters":{"amount":10},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[2288,144],"id":"1cf47244-6a73-48b3-8eec-4864a32450f5","name":"Wait 10 seconds","webhookId":"19a66f32-6da0-4bcb-81d9-1cda8ac810bc","disabled":true},{"parameters":{"rule":{"interval":[{"field":"hours","hoursInterval":2}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,320],"id":"bd949e50-77c1-4899-b7ae-4629d4d813d8","name":"Run Every 2 Hours"},{"parameters":{"operation":"executeQuery","query":"SELECT\n  telegram_date_utc AS date,\n  text AS message,\n  tool_activity as toolActivity,\n  CASE\n    WHEN direction = 'inbound' THEN 'user'\n    ELSE 'ai'\n  END AS role\nFROM\n  telegram_messages\nWHERE (recipient_id = '{{ $json.telegram_id }}' OR sender_id = '{{ $json.telegram_id }}')\nAND telegram_date >= {{ $now.minus(2, 'day').toSeconds().round() }}\nORDER BY telegram_date DESC;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[896,-32],"id":"b69e471b-4241-4bac-bfa4-40987a9d8de9","name":"Get Messages","alwaysOutputData":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2aa8fae4-89bf-486a-beec-671b4a35a536","leftValue":"={{ $json }}","rightValue":"","operator":{"type":"object","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1120,-32],"id":"2f457357-f4b6-4c68-ab63-223ef1d3bf0c","name":"Results?"},{"parameters":{"aggregate":"aggregateAllItemData","include":"allFieldsExcept","fieldsToExclude":"toolactivity","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1344,-32],"id":"f55cfd73-71ae-4734-81d0-4fc50be79bae","name":"Aggregate"},{"parameters":{"jsonSchemaExample":"{\"contacts\": [\n  {\"name\": \"John McCain\",\n  \"phone\": \"+12354656\",\n  \"email\": \"email@email.com\"\n}]\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[1696,192],"id":"f4c061b0-32c9-4eff-8fd2-5d618511e95e","name":"Structured Output Parser"},{"parameters":{"model":"openai/o3","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1568,192],"id":"1e96e6c7-3dea-437b-862e-253ff5183ceb","name":"o3","credentials":{"openRouterApi":{"id":"SeBKTiKFu0nP1GsL","name":"OpenRouter account"}}},{"parameters":{"model":"openai/gpt-5-mini","options":{"temperature":0}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1776,400],"id":"61df36a0-5e08-4b3d-bf8c-923e143a1507","name":"GPT 5 MINI","credentials":{"openRouterApi":{"id":"SeBKTiKFu0nP1GsL","name":"OpenRouter account"}}},{"parameters":{"promptType":"define","text":"=## Chat history:\n{{ JSON.stringify($json.data, 2) }}","hasOutputParser":true,"options":{"systemMessage":"=You are an expert data extraction assistant. \n\nYour task is to analyze the provided text and extract all contact details. \n\nFormat your response as a valid JSON array of objects. \n\nEach object must contain \"name\", \"email\", and \"phone\" keys. If a piece of information is missing for a contact, use null as the value. If no contacts are found at all, return an empty array []. \n\nDo not include any explanatory text outside of the JSON array.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1600,-32],"id":"1c98fbb6-7268-4bea-8089-5b4cdae17053","name":"Contact Extractor"}],"connections":{"Get Users":{"main":[[{"node":"Keep Authenticated Users","type":"main","index":0}]]},"Keep Authenticated Users":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Get Messages","type":"main","index":0}]]},"Vectorize User Contacts":{"main":[[{"node":"Wait 10 seconds","type":"main","index":0}]]},"Wait 10 seconds":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Run Every 2 Hours":{"main":[[{"node":"Get Users","type":"main","index":0}]]},"Get Messages":{"main":[[{"node":"Results?","type":"main","index":0}]]},"Results?":{"main":[[{"node":"Aggregate","type":"main","index":0}],[{"node":"Loop Over Items","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Contact Extractor","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"Contact Extractor","type":"ai_outputParser","index":0}]]},"o3":{"ai_languageModel":[[{"node":"Contact Extractor","type":"ai_languageModel","index":0}]]},"GPT 5 MINI":{"ai_languageModel":[[{"node":"Structured Output Parser","type":"ai_languageModel","index":0}]]},"Contact Extractor":{"main":[[{"node":"Vectorize User Contacts","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"eb3bf7b7-f9dd-4a88-ab52-8471aa7fd9a5","triggerCount":0,"tags":[]}