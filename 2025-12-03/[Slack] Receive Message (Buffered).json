{"updatedAt":"2025-12-03T22:39:24.579Z","createdAt":"2025-11-18T16:44:18.875Z","id":"vqv9sxjCKexF60mn","name":"[Slack] Receive Message (Buffered)","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"slack-events","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[0,16],"id":"2a3fdaab-d313-482a-b518-6c17e3969168","name":"Webhook","webhookId":"d0ead3d8-7c5f-4c5e-97af-5f05871d9a29"},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"59a9a31b-754a-4275-b8bf-fb407604484a","leftValue":"={{ $json.body.event.type }}","rightValue":"message","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{"ignoreCase":true}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[224,16],"id":"ce5b615c-b40a-4c94-8c0a-412896340eda","name":"Message?"},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_slack_user('{{ $json.body.event.user}}');","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[448,16],"id":"ad085d70-cf26-4a43-b2be-1790b39c1bca","name":"Find User by Slack ID","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c4989d88-5d11-409b-8aee-1ba1fbb0484e","leftValue":"={{ $json.get_slack_user === null}}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[672,16],"id":"dd96deb7-bc7f-4b28-a412-007d4ae261c8","name":"Found?"},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_slack_integration_by_team('{{ $('Webhook').item.json.body.team_id}}');","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[896,112],"id":"ffd4762f-265b-4042-aaf3-7577d09a745f","name":"Find Token by Team ID","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"assignments":{"assignments":[{"id":"994defb3-f232-4a03-a0c8-248ff454b522","name":"timetampUTC","value":"={{ $('Webhook').item.json.body.event.event_ts.toDateTime('s').toUTC().toISO() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[896,-80],"id":"7bee0268-553a-4936-9069-3b505c830d13","name":"Parse Timestamp from Inbound Slack message"},{"parameters":{"tableId":"slack_messages","fieldsUi":{"fieldValues":[{"fieldId":"slack_team_id","fieldValue":"={{ $('Find User by Slack ID').item.json.get_slack_user.external_user_id }}"},{"fieldId":"slack_channel_id","fieldValue":"={{ $('Message?').item.json.body.event.channel }}"},{"fieldId":"slack_user_id","fieldValue":"={{ $('Message?').item.json.body.event.user }}"},{"fieldId":"slack_message_ts","fieldValue":"={{ $('Message?').item.json.body.event.event_ts }}"},{"fieldId":"slack_message_ts_utc","fieldValue":"={{ $json.timetampUTC }}"},{"fieldId":"direction","fieldValue":"inbound"},{"fieldId":"raw_payload","fieldValue":"={{ $('Webhook').item.json.body }}"},{"fieldId":"text","fieldValue":"={{ $('Webhook').item.json.body.event.text }}"},{"fieldId":"sender_id","fieldValue":"={{ $('Webhook').item.json.body.event.user }}"},{"fieldId":"recipient_id","fieldValue":"={{ $('Webhook').item.json.body.authorizations[0].user_id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1120,-80],"id":"f130609f-3cca-402a-a093-8b3ba097211b","name":"Save Message","retryOnFail":true,"credentials":{"supabaseApi":{"id":"PwJN4yKDRZqivq2f","name":"Supabase account"}}},{"parameters":{"operation":"upsert","schema":{"__rl":true,"value":"=public","mode":"name"},"table":{"__rl":true,"value":"ai_processing_queue","mode":"list","cachedResultName":"ai_processing_queue"},"columns":{"mappingMode":"defineBelow","value":{"status":"pending","process_at":"={{ $now.plus({ seconds: 5 }).toISO() }}","sender_id":"={{ $('Webhook').item.json.body.event.user }}","type":"slack"},"matchingColumns":["sender_id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false,"removed":true},{"id":"updated_at","displayName":"updated_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false,"removed":true},{"id":"sender_id","displayName":"sender_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false},{"id":"process_at","displayName":"process_at","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false},{"id":"type","displayName":"type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1344,-80],"id":"724577fd-0752-4610-8165-a540a5204706","name":"Upsert Job","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"method":"POST","url":"https://slack.com/api/chat.postMessage","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.get_slack_integration_by_team.access_token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"channel","value":"={{ $('Webhook').item.json.body.event.user }}"},{"name":"text","value":"=Hi! \n\nPlease sign up here: \n\nhttps://cal.hellotomo.ai/welcome?service=slack&user_id={{ $('Webhook').item.json.body.event.user }}&team_id={{ $('Webhook').item.json.body.team_id }}&app_id={{ $('Webhook').item.json.body.api_app_id }}&token={{ $json.get_slack_integration_by_team.access_token }}&bot_user_id={{ $('Webhook').item.json.body.authorizations[0].user_id }}"},{"name":"unfurl_links","value":"true"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[1120,112],"id":"e5cb2cc6-776c-4eb0-bd15-3ec00c3cc087","name":"Send Message"}],"connections":{"Webhook":{"main":[[{"node":"Message?","type":"main","index":0}]]},"Message?":{"main":[[{"node":"Find User by Slack ID","type":"main","index":0}],[]]},"Find User by Slack ID":{"main":[[{"node":"Found?","type":"main","index":0}]]},"Found?":{"main":[[{"node":"Parse Timestamp from Inbound Slack message","type":"main","index":0}],[{"node":"Find Token by Team ID","type":"main","index":0}]]},"Find Token by Team ID":{"main":[[{"node":"Send Message","type":"main","index":0}]]},"Parse Timestamp from Inbound Slack message":{"main":[[{"node":"Save Message","type":"main","index":0}]]},"Save Message":{"main":[[{"node":"Upsert Job","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n.srv845833.hstgr.cloud","user-agent":"Slackbot 1.0 (+https://api.slack.com/robots)","content-length":"879","accept":"*/*","accept-encoding":"gzip,deflate","content-type":"application/json","x-forwarded-for":"107.22.51.15","x-forwarded-host":"n8n.srv845833.hstgr.cloud","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"bafc71398f11","x-real-ip":"107.22.51.15","x-slack-request-timestamp":"1764729395","x-slack-signature":"v0=0abba80701af4ab05958c7bb8a9ef8135a5cad91ca5336511d2b63935b994c98"},"params":{},"query":{},"body":{"token":"jqsfQxQ4MIbURsb09NNTXSCg","team_id":"T02Q7P07G91","context_team_id":"T02Q7P07G91","context_enterprise_id":null,"api_app_id":"A09U4GD1064","event":{"type":"message","user":"U07U3MJ9SQY","ts":"1764729394.363959","client_msg_id":"4f024d52-62fd-408a-b6f8-91a52157de70","text":"hi","team":"T02Q7P07G91","blocks":[{"type":"rich_text","block_id":"a8bcU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"hi"}]}]}],"channel":"D09TR7U4DBL","event_ts":"1764729394.363959","channel_type":"im"},"type":"event_callback","event_id":"Ev0A0R2Z40K1","event_time":1764729394,"authorizations":[{"enterprise_id":null,"team_id":"T02Q7P07G91","user_id":"U09U4508SFK","is_bot":true,"is_enterprise_install":false}],"is_ext_shared_channel":false,"event_context":"4-eyJldCI6Im1lc3NhZ2UiLCJ0aWQiOiJUMDJRN1AwN0c5MSIsImFpZCI6IkEwOVU0R0QxMDY0IiwiY2lkIjoiRDA5VFI3VTREQkwifQ"},"webhookUrl":"https://n8n.srv845833.hstgr.cloud/webhook/slack-events","executionMode":"production"}}]},"versionId":"66e4d191-84ff-4fd9-9f70-f051a6b99a92","activeVersionId":"66e4d191-84ff-4fd9-9f70-f051a6b99a92","triggerCount":1,"shared":[{"updatedAt":"2025-11-18T16:44:18.875Z","createdAt":"2025-11-18T16:44:18.875Z","role":"workflow:owner","workflowId":"vqv9sxjCKexF60mn","projectId":"8nyfoRCh3nEYWaKJ"}],"activeVersion":{"updatedAt":"2025-12-03T02:46:39.755Z","createdAt":"2025-12-03T02:46:39.755Z","versionId":"66e4d191-84ff-4fd9-9f70-f051a6b99a92","workflowId":"vqv9sxjCKexF60mn","nodes":[{"parameters":{"httpMethod":"POST","path":"slack-events","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[0,16],"id":"2a3fdaab-d313-482a-b518-6c17e3969168","name":"Webhook","webhookId":"d0ead3d8-7c5f-4c5e-97af-5f05871d9a29"},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"59a9a31b-754a-4275-b8bf-fb407604484a","leftValue":"={{ $json.body.event.type }}","rightValue":"message","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{"ignoreCase":true}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[224,16],"id":"ce5b615c-b40a-4c94-8c0a-412896340eda","name":"Message?"},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_slack_user('{{ $json.body.event.user}}');","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[448,16],"id":"ad085d70-cf26-4a43-b2be-1790b39c1bca","name":"Find User by Slack ID","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c4989d88-5d11-409b-8aee-1ba1fbb0484e","leftValue":"={{ $json.get_slack_user === null}}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[672,16],"id":"dd96deb7-bc7f-4b28-a412-007d4ae261c8","name":"Found?"},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_slack_integration_by_team('{{ $('Webhook').item.json.body.team_id}}');","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[896,112],"id":"ffd4762f-265b-4042-aaf3-7577d09a745f","name":"Find Token by Team ID","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"assignments":{"assignments":[{"id":"994defb3-f232-4a03-a0c8-248ff454b522","name":"timetampUTC","value":"={{ $('Webhook').item.json.body.event.event_ts.toDateTime('s').toUTC().toISO() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[896,-80],"id":"7bee0268-553a-4936-9069-3b505c830d13","name":"Parse Timestamp from Inbound Slack message"},{"parameters":{"tableId":"slack_messages","fieldsUi":{"fieldValues":[{"fieldId":"slack_team_id","fieldValue":"={{ $('Find User by Slack ID').item.json.get_slack_user.external_user_id }}"},{"fieldId":"slack_channel_id","fieldValue":"={{ $('Message?').item.json.body.event.channel }}"},{"fieldId":"slack_user_id","fieldValue":"={{ $('Message?').item.json.body.event.user }}"},{"fieldId":"slack_message_ts","fieldValue":"={{ $('Message?').item.json.body.event.event_ts }}"},{"fieldId":"slack_message_ts_utc","fieldValue":"={{ $json.timetampUTC }}"},{"fieldId":"direction","fieldValue":"inbound"},{"fieldId":"raw_payload","fieldValue":"={{ $('Webhook').item.json.body }}"},{"fieldId":"text","fieldValue":"={{ $('Webhook').item.json.body.event.text }}"},{"fieldId":"sender_id","fieldValue":"={{ $('Webhook').item.json.body.event.user }}"},{"fieldId":"recipient_id","fieldValue":"={{ $('Webhook').item.json.body.authorizations[0].user_id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1120,-80],"id":"f130609f-3cca-402a-a093-8b3ba097211b","name":"Save Message","retryOnFail":true,"credentials":{"supabaseApi":{"id":"PwJN4yKDRZqivq2f","name":"Supabase account"}}},{"parameters":{"operation":"upsert","schema":{"__rl":true,"value":"=public","mode":"name"},"table":{"__rl":true,"value":"ai_processing_queue","mode":"list","cachedResultName":"ai_processing_queue"},"columns":{"mappingMode":"defineBelow","value":{"status":"pending","process_at":"={{ $now.plus({ seconds: 5 }).toISO() }}","sender_id":"={{ $('Webhook').item.json.body.event.user }}","type":"slack"},"matchingColumns":["sender_id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false,"removed":true},{"id":"updated_at","displayName":"updated_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false,"removed":true},{"id":"sender_id","displayName":"sender_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false},{"id":"process_at","displayName":"process_at","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false},{"id":"type","displayName":"type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1344,-80],"id":"724577fd-0752-4610-8165-a540a5204706","name":"Upsert Job","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"method":"POST","url":"https://slack.com/api/chat.postMessage","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.get_slack_integration_by_team.access_token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"channel","value":"={{ $('Webhook').item.json.body.event.user }}"},{"name":"text","value":"=Hi! \n\nPlease sign up here: \n\nhttps://cal.hellotomo.ai/welcome?service=slack&user_id={{ $('Webhook').item.json.body.event.user }}&team_id={{ $('Webhook').item.json.body.team_id }}&app_id={{ $('Webhook').item.json.body.api_app_id }}&token={{ $json.get_slack_integration_by_team.access_token }}&bot_user_id={{ $('Webhook').item.json.body.authorizations[0].user_id }}"},{"name":"unfurl_links","value":"true"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[1120,112],"id":"e5cb2cc6-776c-4eb0-bd15-3ec00c3cc087","name":"Send Message"}],"connections":{"Webhook":{"main":[[{"node":"Message?","type":"main","index":0}]]},"Message?":{"main":[[{"node":"Find User by Slack ID","type":"main","index":0}],[]]},"Find User by Slack ID":{"main":[[{"node":"Found?","type":"main","index":0}]]},"Found?":{"main":[[{"node":"Parse Timestamp from Inbound Slack message","type":"main","index":0}],[{"node":"Find Token by Team ID","type":"main","index":0}]]},"Find Token by Team ID":{"main":[[{"node":"Send Message","type":"main","index":0}]]},"Parse Timestamp from Inbound Slack message":{"main":[[{"node":"Save Message","type":"main","index":0}]]},"Save Message":{"main":[[{"node":"Upsert Job","type":"main","index":0}]]}},"authors":"Dev JIA","name":null,"description":null},"tags":[]}