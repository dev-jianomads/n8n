{"createdAt":"2025-07-14T20:39:00.478Z","updatedAt":"2025-07-16T21:47:34.546Z","id":"R3wPrQR0rYDcXpkq","name":"Poll Messages","active":true,"isArchived":false,"nodes":[{"parameters":{"assignments":{"assignments":[{"id":"8d2fcb7f-7f82-4dc5-a7f4-687b493fb5e0","name":"tomoPhone","value":"+85291356545","type":"string"},{"id":"10f4c204-f200-424a-9bd6-1c38fca15177","name":"tomoUUID","value":"dd104d16-db00-41de-bcb6-4a3c1d7cb245","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[220,-160],"id":"b8664183-1073-493c-958b-ac65271e5486","name":"Set Tomo Phone Number and UUID"},{"parameters":{"url":"=https://n8n.srv845833.hstgr.cloud/signal/v1/receive/{{ $json.tomoPhone }}","sendQuery":true,"queryParameters":{"parameters":[{"name":"send_read_receipts","value":"true"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[440,-160],"id":"b4a9f214-52fc-4d32-ad3f-de02bd787ac6","name":"Poll Messages","retryOnFail":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ Object.keys($json.envelope).includes(\"dataMessage\") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"7a2d12af-eb37-426e-9b50-b96faf25d947"}],"combinator":"and"},"renameOutput":true,"outputKey":"INBOUND MESSAGE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"819c7b42-2f37-47b7-ba65-0f1c9accbef5","leftValue":"={{ Object.keys($json.envelope).includes(\"syncMessage\") && Object.keys($json.envelope[\"syncMessage\"]).includes(\"sentMessage\") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"SENT MESSAGE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"94b13e45-9036-4414-aadc-d114e3a18f04","leftValue":"={{ Object.keys($json.envelope).includes(\"receiptMessage\") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"RECEIPT MESSAGE"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1100,-160],"id":"d5e5cbfd-d5dd-40a1-ad7c-9d7470edcea6","name":"Switch"},{"parameters":{"tableId":"signal_messages","fieldsUi":{"fieldValues":[{"fieldId":"signal_timestamp","fieldValue":"={{ $('Switch').item.json.envelope.dataMessage.timestamp }}"},{"fieldId":"signal_timestamp_utc","fieldValue":"={{ $json.timetampUTC }}"},{"fieldId":"sender_phone","fieldValue":"={{ $('Switch').item.json.envelope.sourceNumber }}"},{"fieldId":"recipient_phone","fieldValue":"={{ $('Set Tomo Phone Number and UUID').first().json.tomoPhone }}"},{"fieldId":"message_text","fieldValue":"={{ $('Switch').item.json.envelope.dataMessage.message }}"},{"fieldId":"direction","fieldValue":"inbound"},{"fieldId":"sender_uuid","fieldValue":"={{ $('Switch').item.json.envelope.sourceUuid }}"},{"fieldId":"recipient_uuid","fieldValue":"={{ $('Set Tomo Phone Number and UUID').item.json.tomoUUID }}"},{"fieldId":"attachments","fieldValue":"={{ ($('Switch').item.json.envelope.dataMessage.attachments ?? null) }}"},{"fieldId":"raw_payload","fieldValue":"={{ $('Switch').item.json }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1540,-360],"id":"7552843b-b6e5-4e4e-8bed-9b9ddc0bcbc4","name":"Save Message","retryOnFail":true,"credentials":{"supabaseApi":{"id":"PwJN4yKDRZqivq2f","name":"Supabase account"}}},{"parameters":{"assignments":{"assignments":[{"id":"994defb3-f232-4a03-a0c8-248ff454b522","name":"timetampUTC","value":"={{ $json.envelope.dataMessage.timestamp.toDateTime('ms').toUTC() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1320,-360],"id":"efc39e1f-ed21-437c-8209-48fb6b8e5ff9","name":"Parse Timestamp from Inbound Message"},{"parameters":{"assignments":{"assignments":[{"id":"6e1815f3-19f5-419f-9fbb-06a3814c451d","name":"phoneNumber","value":"={{ $json.envelope.syncMessage.sentMessage.destinationNumber }}","type":"string"},{"id":"820bb73f-3a47-4066-80b1-ddc47d8fe3da","name":"signalUuid","value":"={{ $json.envelope.syncMessage.sentMessage.destinationUuid }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1320,-160],"id":"324d08ed-a8d7-49f9-bf10-dab549a775d3","name":"Extract Phone and UUID from Sent Message"},{"parameters":{"assignments":{"assignments":[{"id":"6e1815f3-19f5-419f-9fbb-06a3814c451d","name":"phoneNumber","value":"={{ $json.envelope.sourceNumber }}","type":"string"},{"id":"820bb73f-3a47-4066-80b1-ddc47d8fe3da","name":"signalUuid","value":"={{ $json.envelope.sourceUuid }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1320,40],"id":"fcd13a2d-d3e4-4075-b1dc-0792421d95fa","name":"Extract Phone and UUID from Sent Receipt"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"386aa916-8375-4310-9940-e3e91138758a","leftValue":"={{ $json.phoneNumber }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"ca55db0d-7b86-4c2f-a8b1-eb3577a1b446","leftValue":"={{ $json.phoneNumber }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1540,-60],"id":"36b777dc-f3ff-419e-9862-3755db31ce5e","name":"Phone Exists?"},{"parameters":{"operation":"update","tableId":"users","matchType":"allFilters","filters":{"conditions":[{"keyName":"phone_number","condition":"eq","keyValue":"={{ $json.phoneNumber }}"},{"keyName":"signal_source_uuid","condition":"is","keyValue":"={{ null }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"signal_source_uuid","fieldValue":"={{ $json.signalUuid }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1760,-80],"id":"03eacaef-1edc-46b7-bc00-17d9d1e2cac6","name":"Update User with Signal UUID","retryOnFail":true,"credentials":{"supabaseApi":{"id":"PwJN4yKDRZqivq2f","name":"Supabase account"}}},{"parameters":{"fieldToSplitOut":"data","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[880,-160],"id":"6a118197-b640-4d0a-aca2-5a49e002a93b","name":"Split Out"},{"parameters":{"assignments":{"assignments":[{"id":"970a1c0e-2d05-4bf8-a5e4-3411e5cfd08a","name":"data","value":"={{ JSON.parse($json.data) }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[660,-160],"id":"24f76c04-3c78-48f4-a793-b3520f7739f6","name":"Parse Response"},{"parameters":{"rule":{"interval":[{"field":"seconds","secondsInterval":5}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,-160],"id":"8c0b5ba7-4174-4eaf-ba2b-764ea0161c01","name":"Run Every 5 Seconds"},{"parameters":{"content":"Here we should trigger the AI"},"type":"n8n-nodes-base.stickyNote","position":[1740,-380],"typeVersion":1,"id":"065e5077-bcd3-4e7f-8a5d-9272a86d4a6b","name":"Sticky Note"}],"connections":{"Set Tomo Phone Number and UUID":{"main":[[{"node":"Poll Messages","type":"main","index":0}]]},"Poll Messages":{"main":[[{"node":"Parse Response","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Parse Timestamp from Inbound Message","type":"main","index":0}],[{"node":"Extract Phone and UUID from Sent Message","type":"main","index":0}],[{"node":"Extract Phone and UUID from Sent Receipt","type":"main","index":0}]]},"Parse Timestamp from Inbound Message":{"main":[[{"node":"Save Message","type":"main","index":0}]]},"Extract Phone and UUID from Sent Message":{"main":[[{"node":"Phone Exists?","type":"main","index":0}]]},"Extract Phone and UUID from Sent Receipt":{"main":[[{"node":"Phone Exists?","type":"main","index":0}]]},"Phone Exists?":{"main":[[{"node":"Update User with Signal UUID","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Parse Response":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"Run Every 5 Seconds":{"main":[[{"node":"Set Tomo Phone Number and UUID","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Run Every 30 Seconds":{"recurrenceRules":[]},"node:Run Every 15 Seconds":{"recurrenceRules":[]},"node:Run Every 5 Seconds":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Poll Messages":[{"json":{"data":"[\n  {\n    \"envelope\": {\n      \"source\": \"2d9102cb-a72d-4a41-ac61-64c7479e68d1\",\n      \"sourceNumber\": null,\n      \"sourceUuid\": \"2d9102cb-a72d-4a41-ac61-64c7479e68d1\",\n      \"sourceName\": \"Jesús Armando Martínez Var\",\n      \"sourceDevice\": 1,\n      \"timestamp\": 1752522579193,\n      \"serverReceivedTimestamp\": 1752522578956,\n      \"serverDeliveredTimestamp\": 1752522587826,\n      \"dataMessage\": {\n        \"timestamp\": 1752522579193,\n        \"message\": \"What do you think?\",\n        \"expiresInSeconds\": 0,\n        \"viewOnce\": false,\n        \"attachments\": [\n          {\n            \"contentType\": \"image/webp\",\n            \"filename\": null,\n            \"id\": \"-DkP7S28Qor8Ag2XKBGe.webp\",\n            \"size\": 228490,\n            \"width\": 1024,\n            \"height\": 1536,\n            \"caption\": null,\n            \"uploadTimestamp\": 1752522571114\n          }\n        ]\n      }\n    },\n    \"account\": \"+573195884149\"\n  },\n  {\n    \"envelope\": {\n      \"source\": \"+573195884149\",\n      \"sourceNumber\": \"+573195884149\",\n      \"sourceUuid\": \"1794451c-454e-4a15-b409-99a0c19f5bcd\",\n      \"sourceName\": \"AM3\",\n      \"sourceDevice\": 1,\n      \"timestamp\": 1752522580276,\n      \"serverReceivedTimestamp\": 1752522580265,\n      \"serverDeliveredTimestamp\": 1752522587826,\n      \"syncMessage\": {}\n    },\n    \"account\": \"+573195884149\"\n  },\n  {\n    \"envelope\": {\n      \"source\": \"+573195884149\",\n      \"sourceNumber\": \"+573195884149\",\n      \"sourceUuid\": \"1794451c-454e-4a15-b409-99a0c19f5bcd\",\n      \"sourceName\": \"AM3\",\n      \"sourceDevice\": 1,\n      \"timestamp\": 1752526294754,\n      \"serverReceivedTimestamp\": 1752526294740,\n      \"serverDeliveredTimestamp\": 1752526309757,\n      \"syncMessage\": {}\n    },\n    \"account\": \"+573195884149\"\n  },\n  {\n    \"envelope\": {\n      \"source\": \"+573001363646\",\n      \"sourceNumber\": \"+573001363646\",\n      \"sourceUuid\": \"2d9102cb-a72d-4a41-ac61-64c7479e68d1\",\n      \"sourceName\": \"Jesús Armando Martínez Var\",\n      \"sourceDevice\": 1,\n      \"timestamp\": 1752526296265,\n      \"serverReceivedTimestamp\": 1752526296265,\n      \"serverDeliveredTimestamp\": 1752526309757,\n      \"receiptMessage\": {\n        \"when\": 1752526296265,\n        \"isDelivery\": true,\n        \"isRead\": false,\n        \"isViewed\": false,\n        \"timestamps\": [\n          1752526277189\n        ]\n      }\n    },\n    \"account\": \"+573195884149\"\n  },\n  {\n    \"envelope\": {\n      \"source\": \"+573195884149\",\n      \"sourceNumber\": \"+573195884149\",\n      \"sourceUuid\": \"1794451c-454e-4a15-b409-99a0c19f5bcd\",\n      \"sourceName\": \"AM3\",\n      \"sourceDevice\": 1,\n      \"timestamp\": 1752526306161,\n      \"serverReceivedTimestamp\": 1752526306357,\n      \"serverDeliveredTimestamp\": 1752526309757,\n      \"syncMessage\": {\n        \"sentMessage\": {\n          \"destination\": \"+573001363646\",\n          \"destinationNumber\": \"+573001363646\",\n          \"destinationUuid\": \"2d9102cb-a72d-4a41-ac61-64c7479e68d1\",\n          \"timestamp\": 1752526306161,\n          \"message\": \"Haha\",\n          \"expiresInSeconds\": 0,\n          \"viewOnce\": false\n        }\n      }\n    },\n    \"account\": \"+573195884149\"\n  }\n]"}}]},"versionId":"cae7fdc6-dfd3-44cd-8cf3-4a58cc217e38","triggerCount":1,"tags":[]}