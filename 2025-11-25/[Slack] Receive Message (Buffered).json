{"updatedAt":"2025-11-22T20:53:47.417Z","createdAt":"2025-11-18T16:44:18.875Z","id":"vqv9sxjCKexF60mn","name":"[Slack] Receive Message (Buffered)","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"slack-events","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[0,16],"id":"2a3fdaab-d313-482a-b518-6c17e3969168","name":"Webhook","webhookId":"d0ead3d8-7c5f-4c5e-97af-5f05871d9a29"},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"59a9a31b-754a-4275-b8bf-fb407604484a","leftValue":"={{ $json.body.event.type }}","rightValue":"message","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{"ignoreCase":true}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[224,16],"id":"ce5b615c-b40a-4c94-8c0a-412896340eda","name":"Message?"},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_slack_user('{{ $json.body.event.user}}');","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[448,16],"id":"ad085d70-cf26-4a43-b2be-1790b39c1bca","name":"Find User by Slack ID","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c4989d88-5d11-409b-8aee-1ba1fbb0484e","leftValue":"={{ $json.get_slack_user === null}}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[672,16],"id":"dd96deb7-bc7f-4b28-a412-007d4ae261c8","name":"Found?"},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_slack_integration_by_team('{{ $('Webhook').item.json.body.team_id}}');","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[896,112],"id":"ffd4762f-265b-4042-aaf3-7577d09a745f","name":"Find Token by Team ID","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"assignments":{"assignments":[{"id":"994defb3-f232-4a03-a0c8-248ff454b522","name":"timetampUTC","value":"={{ $('Webhook').item.json.body.event.event_ts.toDateTime('s').toUTC().toISO() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[896,-80],"id":"7bee0268-553a-4936-9069-3b505c830d13","name":"Parse Timestamp from Inbound Slack message"},{"parameters":{"tableId":"slack_messages","fieldsUi":{"fieldValues":[{"fieldId":"slack_team_id","fieldValue":"={{ $('Find User by Slack ID').item.json.get_slack_user.external_user_id }}"},{"fieldId":"slack_channel_id","fieldValue":"={{ $('Message?').item.json.body.event.channel }}"},{"fieldId":"slack_user_id","fieldValue":"={{ $('Message?').item.json.body.event.user }}"},{"fieldId":"slack_message_ts","fieldValue":"={{ $('Message?').item.json.body.event.event_ts }}"},{"fieldId":"slack_message_ts_utc","fieldValue":"={{ $json.timetampUTC }}"},{"fieldId":"direction","fieldValue":"inbound"},{"fieldId":"raw_payload","fieldValue":"={{ $('Webhook').item.json.body }}"},{"fieldId":"text","fieldValue":"={{ $('Webhook').item.json.body.event.text }}"},{"fieldId":"sender_id","fieldValue":"={{ $('Webhook').item.json.body.event.user }}"},{"fieldId":"recipient_id","fieldValue":"={{ $('Webhook').item.json.body.authorizations[0].user_id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1120,-80],"id":"f130609f-3cca-402a-a093-8b3ba097211b","name":"Save Message","retryOnFail":true,"credentials":{"supabaseApi":{"id":"PwJN4yKDRZqivq2f","name":"Supabase account"}}},{"parameters":{"operation":"upsert","schema":{"__rl":true,"value":"=public","mode":"name"},"table":{"__rl":true,"value":"ai_processing_queue","mode":"list","cachedResultName":"ai_processing_queue"},"columns":{"mappingMode":"defineBelow","value":{"status":"pending","process_at":"={{ $now.plus({ seconds: 5 }).toISO() }}","sender_id":"={{ $('Webhook').item.json.body.event.user }}","type":"slack"},"matchingColumns":["sender_id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false,"removed":true},{"id":"updated_at","displayName":"updated_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false,"removed":true},{"id":"sender_id","displayName":"sender_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false},{"id":"process_at","displayName":"process_at","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false},{"id":"type","displayName":"type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1344,-80],"id":"724577fd-0752-4610-8165-a540a5204706","name":"Upsert Job","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"workflowId":{"__rl":true,"value":"dl7Ouu4fFql85VAB","mode":"list","cachedResultUrl":"/workflow/dl7Ouu4fFql85VAB","cachedResultName":"[Slack] Send Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{"text":"=Hi! Please sign up here: https://cal.hellotomo.ai/welcome?service=slack&user_id={{ $('Webhook').item.json.body.event.user }}&team_id={{ $('Webhook').item.json.body.team_id }}&app_id={{ $('Webhook').item.json.body.api_app_id }}&token={{ $json.get_slack_integration_by_team.access_token }}","save":false,"slack_user_id":"={{ $('Webhook').item.json.body.event.user }}"},"matchingColumns":[],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"text","displayName":"text","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"save","displayName":"save","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1120,112],"id":"747dff6b-4287-48dd-8180-61488c40effc","name":"Call '[Slack] Send Message'"}],"connections":{"Webhook":{"main":[[{"node":"Message?","type":"main","index":0}]]},"Message?":{"main":[[{"node":"Find User by Slack ID","type":"main","index":0}],[]]},"Find User by Slack ID":{"main":[[{"node":"Found?","type":"main","index":0}]]},"Found?":{"main":[[{"node":"Parse Timestamp from Inbound Slack message","type":"main","index":0}],[{"node":"Find Token by Team ID","type":"main","index":0}]]},"Find Token by Team ID":{"main":[[{"node":"Call '[Slack] Send Message'","type":"main","index":0}]]},"Parse Timestamp from Inbound Slack message":{"main":[[{"node":"Save Message","type":"main","index":0}]]},"Save Message":{"main":[[{"node":"Upsert Job","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n.srv845833.hstgr.cloud","user-agent":"Slackbot 1.0 (+https://api.slack.com/robots)","content-length":"889","accept":"*/*","accept-encoding":"gzip,deflate","content-type":"application/json","x-forwarded-for":"54.227.75.150","x-forwarded-host":"n8n.srv845833.hstgr.cloud","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"ca81421ec8d0","x-real-ip":"54.227.75.150","x-slack-request-timestamp":"1763672228","x-slack-signature":"v0=dc229f1923238183ed78e0a3bfa1036043ad78cc11f45218cca227d2e37a2a74"},"params":{},"query":{},"body":{"token":"jqsfQxQ4MIbURsb09NNTXSCg","team_id":"T02Q7P07G91","context_team_id":"T02Q7P07G91","context_enterprise_id":null,"api_app_id":"A09U4GD1064","event":{"type":"message","user":"U07U3MJ9SQY","ts":"1763672227.664769","client_msg_id":"9da792d2-2467-4178-8443-5cd3ec952ff5","text":"Hi Tomo","team":"T02Q7P07G91","blocks":[{"type":"rich_text","block_id":"6QSsh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hi Tomo"}]}]}],"channel":"D09TR7U4DBL","event_ts":"1763672227.664769","channel_type":"im"},"type":"event_callback","event_id":"Ev09UQ6CU7S5","event_time":1763672227,"authorizations":[{"enterprise_id":null,"team_id":"T02Q7P07G91","user_id":"U09U4508SFK","is_bot":true,"is_enterprise_install":false}],"is_ext_shared_channel":false,"event_context":"4-eyJldCI6Im1lc3NhZ2UiLCJ0aWQiOiJUMDJRN1AwN0c5MSIsImFpZCI6IkEwOVU0R0QxMDY0IiwiY2lkIjoiRDA5VFI3VTREQkwifQ"},"webhookUrl":"https://n8n.srv845833.hstgr.cloud/webhook/slack-events","executionMode":"production"}}]},"versionId":"79cd019e-e895-4ac1-98c9-46482de040ea","triggerCount":1,"shared":[{"updatedAt":"2025-11-18T16:44:18.875Z","createdAt":"2025-11-18T16:44:18.875Z","role":"workflow:owner","workflowId":"vqv9sxjCKexF60mn","projectId":"8nyfoRCh3nEYWaKJ"}],"tags":[]}