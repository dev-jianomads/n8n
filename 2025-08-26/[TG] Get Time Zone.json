{"createdAt":"2025-07-30T17:52:59.488Z","updatedAt":"2025-08-25T23:16:45.394Z","id":"DHcoEXUvqWWKxbZD","name":"[TG] Get Time Zone","active":false,"isArchived":false,"nodes":[{"parameters":{"workflowInputs":{"values":[{"name":"userId"},{"name":"chatHistory","type":"array"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-656,-80],"id":"ba9be2d1-ee5a-4f97-b850-0cac30d371da","name":"When Executed by Another Workflow"},{"parameters":{"workflowId":{"__rl":true,"value":"pE2lsrstziYiLtF8","mode":"list","cachedResultName":"Get Token for Signal Integration"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('When Executed by Another Workflow').first().json.userId }}"},"matchingColumns":["user_id"],"schema":[{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[448,16],"id":"d26910ab-b781-41d7-bda9-b53bc361b94c","name":"Get Token"},{"parameters":{"url":"https://www.googleapis.com/calendar/v3/calendars/primary","sendQuery":true,"queryParameters":{"parameters":[{"name":"fields","value":"timeZone"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('Get Token').first().json.accessToken }}"},{"name":"Content-Type","value":"application/json"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[672,16],"id":"2cd47bc5-7e1c-4212-96ab-bec13a62b5e0","name":"Get Time Zone from Primary Calendar","retryOnFail":true,"alwaysOutputData":false,"onError":"continueErrorOutput"},{"parameters":{"jsonSchemaExample":"{\"time_zone\": \"America/New_York\", \"confidence\": 0.8, \"reason\": \"The user mentions having visited Times Square yesterday\"}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-176,144],"id":"4cc92dde-3cc4-4f48-a5cd-7dc50770ce35","name":"Structured Output Parser"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1","mode":"list","cachedResultName":"gpt-4.1"},"options":{"temperature":0}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-384,368],"id":"31c3b54e-a45d-469f-9d03-ac2ee22ca87b","name":"4.1","credentials":{"openAiApi":{"id":"JNBPFneOXwzjzSKh","name":"OpenAI account"}}},{"parameters":{"promptType":"define","text":"={{ JSON.stringify($json.chatHistory) }}","hasOutputParser":true,"needsFallback":true,"options":{"systemMessage":"=You are a timezone extraction agent. Your sole task is to determine the most likely IANA time zone of the **primary user** in a conversation.\n\n**Core Directives:**\n\n1.  **Analyze the entire chat history.** Look for explicit mentions of geographic locations (cities, countries, regions, or specific landmarks) made by the user.\n2.  **Focus exclusively on the user.** The goal is to find the user's timezone, not the timezone of other people, contacts, or entities mentioned in the conversation.\n3.  **Evaluate the evidence critically.** Do not just find keywords. Understand the context in which they are used.\n\n**Rules for Evidence Evaluation:**\n\n  * **User's Location is Priority:** Only clues about the primary user's location are relevant. If a location is tied to someone else (e.g., \"I need to schedule a meeting with Ken in Tokyo\"), it must be ignored.\n  * **Explicit Mentions \\> Inferred Clues:** An explicit statement like \"I'm in Chicago\" is high-quality evidence. An inferred clue, like an email address (`tokyo-fan@...`) or a last name (\"Mr. London\"), is very low-quality evidence and should be treated with extreme skepticism.\n  * **Contradictions are Negative Evidence:** If the user questions a timezone or location (e.g., \"Why are you using +09:00?\"), treat this as strong evidence *against* that timezone. It indicates a system error, not a user preference.\n  * **Tool Activity is Not User Intent:** Data inside a `toolactivity` block (like a UTC offset) reflects the agent's internal state or a default setting. It is **not** evidence of the user's location unless the user explicitly confirms it.\n\n**Confidence Scoring:**\n\n  * **High Confidence (0.8 - 1.0):** The user explicitly states their city, country, or timezone (e.g., \"I am in New York,\" \"My timezone is CET\").\n  * **Medium Confidence (0.5 - 0.7):** The user mentions a specific, unambiguous landmark or makes a strong implication (e.g., \"I'm near the Eiffel Tower\").\n  * **Low Confidence (0.1 - 0.4):** The evidence is weak, inferred, or ambiguous (e.g., mentioning a common city name like \"Paris, Texas\" vs. \"Paris, France\").\n  * **Zero Confidence (0.0):** There is no reliable evidence, or the only available evidence has been contradicted or applies to someone other than the user. **When in doubt, default to this.**\n\n**Output Format:**\nReturn a JSON object with the following structure. Do not return any other text.\n\n```json\n{\n  \"time_zone\": \"The IANA time zone string or null if none is found.\",\n  \"confidence\": \"A number between 0.0 and 1.0.\",\n  \"reason\": \"A brief but clear justification for your conclusion, referencing the specific evidence used and explaining why you ignored irrelevant clues.\"\n}\n```"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[-432,-80],"id":"bf84975f-b7c3-4e7a-9992-f4e973218c5f","name":"Time Zone Extractor"},{"parameters":{"model":{"__rl":true,"value":"o3","mode":"list","cachedResultName":"o3"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-304,144],"id":"11c06142-85e8-485b-93f0-2e3d0fadb84c","name":"o3","credentials":{"openAiApi":{"id":"JNBPFneOXwzjzSKh","name":"OpenAI account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"04fc2c96-d0d3-4303-b046-a117b5f7a8fc","leftValue":"={{ $json.output.confidence }}","rightValue":0.7,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{"ignoreCase":true}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[224,-80],"id":"8adabe3b-de70-40f9-ba07-ebbc73e345ca","name":"Time Zone?"},{"parameters":{"assignments":{"assignments":[{"id":"efe47c53-2fd8-4b01-b911-dc97d0c7f18e","name":"timeZone","value":"={{ $json.output.time_zone }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[448,-176],"id":"5cc5f1ce-7c79-48a1-b1c1-be10892b9ef3","name":"Set Extracted Time Zone"},{"parameters":{"assignments":{"assignments":[{"id":"0fdd8902-0577-4469-9832-717dd35739c2","name":"timeZone","value":"={{ $('Time Zone?').item.json.output.time_zone }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[880,112],"id":"e7f3b207-58e9-4472-8240-e8cb7b13f4ec","name":"Set Low Confidence Time Zone"}],"connections":{"Get Token":{"main":[[{"node":"Get Time Zone from Primary Calendar","type":"main","index":0}]]},"When Executed by Another Workflow":{"main":[[{"node":"Time Zone Extractor","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"Time Zone Extractor","type":"ai_outputParser","index":0}]]},"4.1":{"ai_languageModel":[[{"node":"Structured Output Parser","type":"ai_languageModel","index":0},{"node":"Time Zone Extractor","type":"ai_languageModel","index":0}]]},"Time Zone Extractor":{"main":[[{"node":"Time Zone?","type":"main","index":0}]]},"o3":{"ai_languageModel":[[{"node":"Time Zone Extractor","type":"ai_languageModel","index":1}]]},"Time Zone?":{"main":[[{"node":"Set Extracted Time Zone","type":"main","index":0}],[{"node":"Get Token","type":"main","index":0}]]},"Get Time Zone from Primary Calendar":{"main":[[],[{"node":"Set Low Confidence Time Zone","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"userId":"l8DA1eqn6nE4eCYXc8PLBbaFRo8D","chatHistory":[{"date":"2025-08-05T22:30:57.000Z","message":"You assumed that because of the kenintokyo@gmail.com account, right? ...","toolactivity":null,"role":"user"},{"date":"2025-08-05T22:30:34.000Z","message":"You are currently set to the Asia/Tokyo time zone (UTC+09:00) in your scheduling assistant. If this is incorrect, please let me know your actual location or preferred time zone.","toolactivity":[],"role":"ai"},{"date":"2025-08-05T22:30:22.000Z","message":"Where do you think i am located now?","toolactivity":null,"role":"user"},{"date":"2025-08-05T22:30:05.000Z","message":"I'm using the +09:00 time zone (Asia/Tokyo) because that's the configured time zone for your scheduling assistant. All times are shown in this time zone to ensure consistency when booking or managing your calendar. If you need to use a different time zone, let me know and I can adjust accordingly.","toolactivity":[],"role":"ai"},{"date":"2025-08-05T22:29:53.000Z","message":"Why are you using +09:00 time zone?","toolactivity":null,"role":"user"},{"date":"2025-08-05T22:28:52.000Z","message":"There was an error checking your availability for tomorrow at 9:00 PM. Please try again in a few minutes.","toolactivity":[{"tool_name":"Find_Time","tool_input":{"to":"2025-08-07T21:30:00+09:00","from":"2025-08-07T21:00:00+09:00","limit":5},"tool_output":[{"message":"There was an error. Try later."}]}],"role":"ai"},{"date":"2025-08-05T22:28:39.000Z","message":"tomorrow at 9:00 PM my time, just a 30 minutes catch up","toolactivity":null,"role":"user"},{"date":"2025-08-05T22:28:12.000Z","message":"Thank you for confirming Ken's email as kenintokyo@gmail.com. Please provide the meeting details (date, time, duration, and any other attendees) so I can check your availability and schedule the meeting.","toolactivity":[],"role":"ai"},{"date":"2025-08-05T22:28:00.000Z","message":"Actually, is kenintokyo@gmail.com","toolactivity":null,"role":"user"},{"date":"2025-08-05T22:27:35.000Z","message":"I found multiple possible emails for \"Ken.\" Please specify which one is correct by its number:\n\n1. kenneth.tuma@carloanestimates.com\n2. kenneth.thompson@fastloaneasy.com\n3. kenneth.aguilar@insurancesalesexpert.com\n\nLet me know which email to use for inviting Ken.","toolactivity":[{"tool_name":"Search_Contacts_in_Vector_Store","tool_input":{"input":"Ken"},"tool_output":[{"text":"{\"pageContent\":\"Names:\\n[]\\n\\nEmails:\\n[{\\\"metadata\\\":{\\\"primary\\\":true,\\\"source\\\":{\\\"type\\\":\\\"OTHER_CONTACT\\\",\\\"id\\\":\\\"5ac4f0b58b0b3b02\\\"},\\\"sourcePrimary\\\":true},\\\"value\\\":\\\"kenneth.tuma@carloanestimates.com\\\"}]\",\"metadata\":{\"loc\":{\"lines\":{\"to\":5,\"from\":1}},\"source\":\"blob\",\"user_id\":\"l8DA1eqn6nE4eCYXc8PLBbaFRo8D\",\"blobType\":\"text/plain\"},\"id\":\"ede8fee3-b7e0-4b60-8b0e-fcf8106ccd9a\"}","type":"text"},{"text":"{\"pageContent\":\"Names:\\n[]\\n\\nEmails:\\n[{\\\"metadata\\\":{\\\"primary\\\":true,\\\"source\\\":{\\\"type\\\":\\\"OTHER_CONTACT\\\",\\\"id\\\":\\\"3e7175c48b121f1b\\\"}},\\\"value\\\":\\\"kenneth.thompson@fastloaneasy.com\\\"}]\",\"metadata\":{\"loc\":{\"lines\":{\"to\":5,\"from\":1}},\"source\":\"blob\",\"user_id\":\"l8DA1eqn6nE4eCYXc8PLBbaFRo8D\",\"blobType\":\"text/plain\"},\"id\":\"0ea15188-52c7-4864-acc0-ccee842ef8c5\"}","type":"text"},{"text":"{\"pageContent\":\"Names:\\n[]\\n\\nEmails:\\n[{\\\"metadata\\\":{\\\"primary\\\":true,\\\"source\\\":{\\\"type\\\":\\\"OTHER_CONTACT\\\",\\\"id\\\":\\\"5573a65f09089989\\\"}},\\\"value\\\":\\\"kenneth.aguilar@insurancesalesexpert.com\\\"}]\",\"metadata\":{\"loc\":{\"lines\":{\"to\":5,\"from\":1}},\"source\":\"blob\",\"user_id\":\"l8DA1eqn6nE4eCYXc8PLBbaFRo8D\",\"blobType\":\"text/plain\"},\"id\":\"fbbcb43c-7601-4051-a4ba-d0525024af19\"}","type":"text"},{"text":"{\"pageContent\":\"Names:\\n[]\\n\\nEmails:\\n[{\\\"metadata\\\":{\\\"primary\\\":true,\\\"source\\\":{\\\"type\\\":\\\"OTHER_CONTACT\\\",\\\"id\\\":\\\"4e666e768b72eb1e\\\"}},\\\"value\\\":\\\"karen@bigdwomensnetwork.org\\\"}]\",\"metadata\":{\"loc\":{\"lines\":{\"to\":5,\"from\":1}},\"source\":\"blob\",\"user_id\":\"l8DA1eqn6nE4eCYXc8PLBbaFRo8D\",\"blobType\":\"text/plain\"},\"id\":\"9813be70-0f03-4170-9895-6952557ce0e1\"}","type":"text"},{"text":"{\"pageContent\":\"Names:\\n[]\\n\\nEmails:\\n[{\\\"metadata\\\":{\\\"primary\\\":true,\\\"source\\\":{\\\"type\\\":\\\"OTHER_CONTACT\\\",\\\"id\\\":\\\"51318bf90d941295\\\"},\\\"sourcePrimary\\\":true},\\\"value\\\":\\\"karenk@denverceonetwork.com\\\"}]\",\"metadata\":{\"loc\":{\"lines\":{\"to\":5,\"from\":1}},\"source\":\"blob\",\"user_id\":\"l8DA1eqn6nE4eCYXc8PLBbaFRo8D\",\"blobType\":\"text/plain\"},\"id\":\"bbdb9917-0ddf-4ebc-83ad-116a4f4ed754\"}","type":"text"}]}],"role":"ai"},{"date":"2025-08-05T22:27:15.000Z","message":"try again","toolactivity":null,"role":"user"},{"date":"2025-08-05T22:21:11.000Z","message":"I couldn't find Ken's email in your contacts. Please provide Ken's email address so I can help you invite him to the meeting.","toolactivity":[{"tool_name":"Search_Contacts_in_Vector_Store","tool_input":{"input":"Ken"},"tool_output":[]}],"role":"ai"},{"date":"2025-08-05T22:20:52.000Z","message":"Hey, can you tell me what's Ken email? I need to invite him to a meeting","toolactivity":null,"role":"user"},{"date":"2025-08-05T22:19:51.000Z","message":"You're welcome! If you need any more help with your calendar or scheduling, just let me know.","toolactivity":[],"role":"ai"},{"date":"2025-08-05T22:19:41.000Z","message":"Thanks :)","toolactivity":null,"role":"user"},{"date":"2025-08-05T22:14:24.000Z","message":"The event \"Renamed Event by Tomo\" has the following ID:\n7o1648990vpu3hd31ncholrei0","toolactivity":[],"role":"ai"},{"date":"2025-08-05T22:13:14.000Z","message":"Tell me the ID of the Renamed Event by Tomo","toolactivity":null,"role":"user"},{"date":"2025-08-05T22:10:20.000Z","message":"You have one event on your calendar for Thursday, August 7, 2025:\n\n- Renamed Event by Tomo â€” 18:45 to 20:00 (America/Bogota)\n\nLet me know if you need details or want to make changes.","toolactivity":[{"action":{"log":"Invoking \"List_Events\" with {\"from\":\"2025-08-07T00:00:00-05:00\",\"to\":\"2025-08-07T23:59:59-05:00\",\"query\":\"\"}\n","tool":"List_Events","toolInput":{"to":"2025-08-07T23:59:59-05:00","from":"2025-08-07T00:00:00-05:00","query":""},"messageLog":[{"id":["langchain_core","messages","AIMessage"],"lc":1,"type":"constructor","kwargs":{"id":"chatcmpl-C1K9JrtXoY8dv7k2rp0I8vmmUBb5O","content":"","tool_calls":[{"id":"call_KLAgs4PcXvs1Waf57v1NW4Qq","args":{"to":"2025-08-07T23:59:59-05:00","from":"2025-08-07T00:00:00-05:00","query":""},"name":"List_Events","type":"tool_call"}],"usage_metadata":{"input_tokens":4259,"total_tokens":4312,"output_tokens":53,"input_token_details":{"audio":0,"cache_read":1792},"output_token_details":{"audio":0,"reasoning":0}},"additional_kwargs":{"tool_calls":[{"id":"call_KLAgs4PcXvs1Waf57v1NW4Qq","type":"function","function":{"name":"List_Events","arguments":"{\"from\":\"2025-08-07T00:00:00-05:00\",\"to\":\"2025-08-07T23:59:59-05:00\",\"query\":\"\"}"}}]},"response_metadata":{"usage":{"total_tokens":4312,"prompt_tokens":4259,"completion_tokens":53,"prompt_tokens_details":{"audio_tokens":0,"cached_tokens":1792},"completion_tokens_details":{"audio_tokens":0,"reasoning_tokens":0,"accepted_prediction_tokens":0,"rejected_prediction_tokens":0}},"model_name":"gpt-4.1-2025-04-14","tokenUsage":{"totalTokens":4312,"promptTokens":4259,"completionTokens":53},"finish_reason":"tool_calls","system_fingerprint":"fp_51e1070cf2"},"invalid_tool_calls":[]}}],"toolCallId":"call_KLAgs4PcXvs1Waf57v1NW4Qq"},"observation":"[\n  {\n    \"events\": [\n      {\n        \"status\": \"confirmed\",\n        \"creator\": {\n          \"email\": \"jesus@datasmarts.net\",\n          \"self\": true\n        },\n        \"start\": {\n          \"dateTime\": \"2025-03-24T12:00:00-05:00\",\n          \"timeZone\": \"America/Bogota\"\n        },\n        \"end\": {\n          \"dateTime\": \"2025-03-24T13:00:00-05:00\",\n          \"timeZone\": \"America/Bogota\"\n        },\n        \"summary\": \"Out of office\",\n        \"attendees\": null,\n        \"id\": \"274vtqfnomlb4sh5d6vlldfrd0\"\n      },\n      {\n        \"status\": \"confirmed\",\n        \"creator\": {\n          \"email\": \"jesus@datasmarts.net\",\n          \"self\": true\n        },\n        \"start\": {\n          \"dateTime\": \"2025-03-24T17:30:00-05:00\",\n          \"timeZone\": \"America/Bogota\"\n        },\n        \"end\": {\n          \"dateTime\": \"2025-03-24T18:15:00-05:00\",\n          \"timeZone\": \"America/Bogota\"\n        },\n        \"summary\": \"Out of office\",\n        \"attendees\": null,\n        \"id\": \"5eup009voa81fdals9ce8ks8ka\"\n      },\n      {\n        \"status\": \"confirmed\",\n        \"creator\": {\n          \"email\": \"jesus@datasmarts.net\",\n          \"self\": true\n        },\n        \"start\": {\n          \"dateTime\": \"2025-07-21T13:30:00-05:00\",\n          \"timeZone\": \"America/Bogota\"\n        },\n        \"end\": {\n          \"dateTime\": \"2025-07-21T16:00:00-05:00\",\n          \"timeZone\": \"America/Bogota\"\n        },\n        \"summary\": \"Unavailable\",\n        \"attendees\": null,\n        \"id\": \"3ceka5fnt1as1mkigjck55v5bn\"\n      },\n      {\n        \"status\": \"confirmed\",\n        \"creator\": {\n          \"email\": \"jesus@datasmarts.net\",\n          \"self\": true\n        },\n        \"start\": {\n          \"dateTime\": \"2025-08-07T18:45:00-05:00\",\n          \"timeZone\": \"America/Bogota\"\n        },\n        \"end\": {\n          \"dateTime\": \"2025-08-07T20:00:00-05:00\",\n          \"timeZone\": \"America/Bogota\"\n        },\n        \"summary\": \"Renamed Event by Tomo\",\n        \"attendees\": [\n          \"jesus@datasmarts.net\",\n          \"jaxex706@gmail.com\"\n        ],\n        \"id\": \"7o1648990vpu3hd31ncholrei0\"\n      }\n    ]\n  }\n]"}],"role":"ai"},{"date":"2025-08-05T22:10:11.000Z","message":"List my events of thursday","toolactivity":null,"role":"user"},{"date":"2025-08-05T21:51:50.000Z","message":"How can I assist you with your calendar or scheduling needs? Please specify what you'd like to do.","toolactivity":null,"role":"ai"}]}}]},"versionId":"d9fea04d-8e4e-45ce-82cf-8dcfec9b3d8b","triggerCount":0,"shared":[{"createdAt":"2025-07-30T17:52:59.488Z","updatedAt":"2025-07-30T17:52:59.488Z","role":"workflow:owner","workflowId":"DHcoEXUvqWWKxbZD","projectId":"8nyfoRCh3nEYWaKJ"}],"tags":[]}