{"createdAt":"2025-08-28T21:40:34.937Z","updatedAt":"2025-08-28T21:43:25.291Z","id":"An8yn6bAcRrsPpIu","name":"🖥️ [TG] Vectorize Single User Contacts","active":false,"isArchived":true,"nodes":[{"parameters":{"workflowId":{"__rl":true,"value":"OH9PUovRKlvZel5e","mode":"list","cachedResultName":"[TG] Get Token for Telegram Integration"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $json.user_id }}"},"matchingColumns":["user_id"],"schema":[{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"mode":"each","options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-320,-288],"id":"d2f36b6c-b204-48bf-ad49-472f057baaff","name":"Get Token"},{"parameters":{"url":"=https://people.googleapis.com/v1/otherContacts","sendQuery":true,"queryParameters":{"parameters":[{"name":"readMask","value":"names,emailAddresses"},{"name":"pageSize","value":"500"},{"name":"pageToken"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.accessToken }}"},{"name":"Content-Type","value":"application/json"}]},"options":{"pagination":{"pagination":{"parameters":{"parameters":[{"name":"pageToken","value":"={{ $response.body[\"nextPageToken\"] }}"}]},"paginationCompleteWhen":"other","completeExpression":"={{ $response.body[\"nextPageToken\"] === undefined || $response.body[\"nextPageToken\"] === null }}","requestInterval":30000}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-96,-288],"id":"070a10ca-19ca-48c1-9d3d-b0b7b9d8a7f7","name":"Search Other Contacts","retryOnFail":true,"alwaysOutputData":false,"onError":"continueErrorOutput"},{"parameters":{"mode":"insert","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[1264,-288],"id":"68449dc2-e150-4540-9289-29439707af3b","name":"Postgres PGVector Store","retryOnFail":true,"waitBetweenTries":5000,"maxTries":5,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"options":{"stripNewLines":true}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[1248,-64],"id":"1c6f8b28-62f2-411a-aec4-7fe484fe4c81","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"JNBPFneOXwzjzSKh","name":"OpenAI account"}}},{"parameters":{"jsonMode":"expressionData","jsonData":"=Names:\n{{ JSON.stringify($json.names ?? []) }}\n\nEmails:\n{{ JSON.stringify($json.emailAddresses ?? []) }}","textSplittingMode":"custom","options":{"metadata":{"metadataValues":[{"name":"user_id","value":"={{ $('Code').item.json.userId }}"}]}}},"type":"@n8n/n8n-nodes-langchain.documentDefaultDataLoader","typeVersion":1.1,"position":[1376,-64],"id":"bb4199b7-1186-42ef-a1fc-1a05dc42e83d","name":"Default Data Loader"},{"parameters":{"chunkOverlap":20,"options":{}},"type":"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter","typeVersion":1,"position":[1472,160],"id":"7aeea98e-9c63-4c49-a6f0-d9de0a2ffef4","name":"Recursive Character Text Splitter"},{"parameters":{"aggregate":"aggregateAllItemData","include":"specifiedFields","fieldsToInclude":"otherContacts","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[128,-288],"id":"38390216-e286-42b4-a944-6a3bdf0f83e7","name":"Aggregate"},{"parameters":{"jsCode":"\nlet contacts = []\nfor (const item of $input.first().json.data) {\n  contacts = contacts.concat(item.otherContacts);\n}\n\nreturn {\n  json: {\n    contacts,\n    userId: $('Get Token').first().json.user.id\n  }\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[352,-288],"id":"6a941e2f-7957-4054-ad2e-edc9221a9cda","name":"Code"},{"parameters":{"fieldToSplitOut":"contacts","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[576,-288],"id":"d4f2ded0-4080-4d0d-9186-bf2128b164b8","name":"Split Out"},{"parameters":{"operation":"executeQuery","query":"DELETE FROM n8n_vectors\nWHERE metadata->>'user_id' = '{{ $('Code').item.json.userId }}'","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[800,-352],"id":"8661ea23-9db2-4583-91f4-69077d7681e2","name":"Delete Vectors","retryOnFail":true,"maxTries":5,"waitBetweenTries":5000,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}},"onError":"continueErrorOutput"},{"parameters":{"workflowInputs":{"values":[{"name":"user_id"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-544,-288],"id":"67f581dd-da73-4cc1-a1d3-d6b941aeefdf","name":"When Executed by Another Workflow"},{"parameters":{"mode":"chooseBranch","useDataOfInput":2},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1024,-288],"id":"dd525b46-83d0-49a1-ae63-f5d7e1cdec01","name":"Merge"}],"connections":{"Get Token":{"main":[[{"node":"Search Other Contacts","type":"main","index":0}]]},"Search Other Contacts":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Postgres PGVector Store","type":"ai_embedding","index":0}]]},"Default Data Loader":{"ai_document":[[{"node":"Postgres PGVector Store","type":"ai_document","index":0}]]},"Recursive Character Text Splitter":{"ai_textSplitter":[[{"node":"Default Data Loader","type":"ai_textSplitter","index":0}]]},"Aggregate":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"Delete Vectors","type":"main","index":0},{"node":"Merge","type":"main","index":1}]]},"Delete Vectors":{"main":[[{"node":"Merge","type":"main","index":0}]]},"When Executed by Another Workflow":{"main":[[{"node":"Get Token","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Postgres PGVector Store","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"When Executed by Another Workflow":[{"json":{"name":"First item","code":1}},{"json":{"name":"Second item","code":2}}]},"versionId":"acfb09b8-f973-4256-bf7c-deda6e87970d","triggerCount":0,"shared":[{"createdAt":"2025-08-28T21:40:34.937Z","updatedAt":"2025-08-28T21:40:34.937Z","role":"workflow:owner","workflowId":"An8yn6bAcRrsPpIu","projectId":"8nyfoRCh3nEYWaKJ"}],"tags":[]}