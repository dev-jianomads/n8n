{"updatedAt":"2025-11-26T00:46:11.817Z","createdAt":"2025-11-22T20:38:32.358Z","id":"2XrGeLFaoPh5Fhbl","name":"[Slack] Slack Job Processor","active":true,"isArchived":false,"nodes":[{"parameters":{"workflowId":{"__rl":true,"value":"XFQFb7sUMTyKg2dV","mode":"list","cachedResultUrl":"/workflow/XFQFb7sUMTyKg2dV","cachedResultName":"[Slack] Get Cached Slack Conversation"},"workflowInputs":{"mappingMode":"defineBelow","value":{"slack_user_id":"={{ $('Get Unprocessed Messages').first().json.slack_user_id }}"},"matchingColumns":["telegramId"],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1552,-480],"id":"ff645477-58ee-446e-b8a3-36e93e9115c6","name":"Get Chat History"},{"parameters":{"jsCode":"/**\n * Filter a chat history to only the last 2 hours and convert dates to a given time zone.\n *\n * @param {Array<{date:string,message:string,role:string}>} history\n * @param {string} tz IANA time zone, e.g. \"America/New_York\"\n * @param {number} hoursBack (optional) default 2\n * @returns {Array<{date:string,message:string,role:string}>}\n */\nfunction filterAndConvert(history, tz, hoursBack = 2) {\n  const nowUtc = Date.now();\n  const cutoffUtc = nowUtc - hoursBack * 60 * 60 * 1000;\n\n  return history\n    .filter(item => new Date(item.date).getTime() >= cutoffUtc)\n    .map(item => ({\n      ...item,\n      date: toTZISO(item.date, tz),\n    }));\n}\n\n/**\n * Convert an ISO string to the same moment expressed in another time zone,\n * returned as \"YYYY-MM-DDTHH:mm:ss[±HH:MM]\" (no milliseconds).\n *\n * Uses only built-ins (Intl.DateTimeFormat).\n */\nfunction toTZISO(dateString, tz) {\n  const d = new Date(dateString);\n\n  // Grab all parts in the desired TZ\n  const parts = new Intl.DateTimeFormat('en-CA', {\n    timeZone: tz,\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n    second: '2-digit',\n    hour12: false,\n  }).formatToParts(d).reduce((acc, p) => {\n    acc[p.type] = p.value;\n    return acc;\n  }, {});\n\n  // Build local datetime string\n  const local = `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}`;\n\n  // Compute offset for that TZ at that instant\n  const offsetMinutes = getOffsetMinutes(d, tz);\n  const sign = offsetMinutes >= 0 ? '+' : '-';\n  const abs = Math.abs(offsetMinutes);\n  const hh = String(Math.floor(abs / 60)).padStart(2, '0');\n  const mm = String(abs % 60).padStart(2, '0');\n\n  return `${local}${sign}${hh}:${mm}`;\n}\n\n/**\n * Find the UTC offset (in minutes) of a date in a given TZ using Intl.\n */\nfunction getOffsetMinutes(date, tz) {\n  // Format the same date in UTC and in the TZ, compare epoch millis reconstructed\n  const fmt = (zone) => {\n    const parts = new Intl.DateTimeFormat('en-CA', {\n      timeZone: zone,\n      year: 'numeric',\n      month: '2-digit',\n      day: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n      second: '2-digit',\n      hour12: false,\n    }).formatToParts(date).reduce((acc, p) => {\n      acc[p.type] = p.value;\n      return acc;\n    }, {});\n    return Date.UTC(\n      Number(parts.year),\n      Number(parts.month) - 1,\n      Number(parts.day),\n      Number(parts.hour),\n      Number(parts.minute),\n      Number(parts.second)\n    );\n  };\n\n  const asUtcMillis = fmt('UTC');\n  const asTzMillis = fmt(tz);\n  return (asTzMillis - asUtcMillis) / (60 * 1000);\n}\n\nconst history = $('Get Chat History').first().json.chat_history;\nconst tz = $('Get Time Zone').first().json.timeZone || 'America/New_York';\n\nconst filtered = filterAndConvert(history, tz);\n\n// Return as n8n items\nreturn { json: { history: filtered } };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2000,-480],"id":"3529be3c-a102-4c0a-9d5e-5248de79aeda","name":"Filter Chat History"},{"parameters":{"workflowId":{"__rl":true,"value":"KhXkPpKZls1wrj5t","mode":"list","cachedResultUrl":"/workflow/KhXkPpKZls1wrj5t","cachedResultName":"[Slack] Slack Tomo Scheduler"},"workflowInputs":{"mappingMode":"defineBelow","value":{"chat_history":"={{ $json }}","user_message":"={{ $('Bundle Messages').item.json.bundledText }}","time_zone":"={{ $('Get Time Zone').first().json.time_zone }}","user":"={{ $('Get Cached User by Slack ID').item.json }}","slack_user_id":"={{ $('Get Unprocessed Messages').first().json.slack_user_id }}","channel_id":"={{ $('Call \\'[Slack] Send Message\\'').item.json.channel }}","message_ts":"={{ $('Call \\'[Slack] Send Message\\'').item.json.message.ts }}"},"matchingColumns":[],"schema":[{"id":"chat_history","displayName":"chat_history","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object"},{"id":"time_zone","displayName":"time_zone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_message","displayName":"user_message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user","displayName":"user","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object","removed":false},{"id":"context","displayName":"context","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"channel_id","displayName":"channel_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"message_ts","displayName":"message_ts","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"mode":"each","options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2224,-480],"id":"0ff33377-847b-465a-a5be-5e765c1f447f","name":"Send to Agent"},{"parameters":{"workflowId":{"__rl":true,"value":"w6HobcwNKb3K2hYo","mode":"list","cachedResultUrl":"/workflow/w6HobcwNKb3K2hYo","cachedResultName":"[Slack] Refresh Cached Slack Chat History and Time Zone"},"workflowInputs":{"mappingMode":"defineBelow","value":{"slack_user_id":"={{ $('Get Unprocessed Messages').first().json.sender_id }}","user_id":"={{ $('Get Cached User by Slack ID').item.json.id }}"},"matchingColumns":[],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[3120,-480],"id":"d074dc4f-777a-420a-93f3-7283f9b308e5","name":"Refresh Caches"},{"parameters":{"workflowId":{"__rl":true,"value":"NSHJ7N5HuSWzl9c0","mode":"list","cachedResultUrl":"/workflow/NSHJ7N5HuSWzl9c0","cachedResultName":"[Slack] Get Slack Time Zone [TO-DO]"},"workflowInputs":{"mappingMode":"defineBelow","value":{"userId":"={{ $('Get Cached User by Slack ID').first().json.id }}"},"matchingColumns":["userId"],"schema":[{"id":"userId","displayName":"userId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1776,-480],"id":"e31e34f9-da25-4bc8-b1f9-d11dc273b008","name":"Get Time Zone"},{"parameters":{"operation":"executeQuery","query":"UPDATE public.ai_processing_queue\nSET status = 'processing', updated_at = NOW()\nWHERE id = (\n  SELECT id\n  FROM public.ai_processing_queue\n  WHERE status = 'pending' AND process_at <= NOW()\n  AND type = 'slack'\n  ORDER BY process_at\n  LIMIT 1\n  FOR UPDATE SKIP LOCKED\n)\nRETURNING *;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[208,-480],"id":"1ce2fddf-2f70-483c-94dd-710931963c6f","name":"Fetch Due Job","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"rule":{"interval":[{"field":"seconds","secondsInterval":2}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-16,-480],"id":"41f2cdd9-b855-4dd8-ba2b-a2e7e6170929","name":"Schedule 2 Seconds"},{"parameters":{"operation":"executeQuery","query":"SELECT *\nFROM public.slack_messages\nWHERE sender_id = '{{ $('Found?').item.json.sender_id }}'\n  AND processed_by_ai_at IS NULL\nORDER BY slack_message_ts ASC;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[656,-480],"id":"a6e6d6fb-ecc2-4bba-b547-e803df541b0c","name":"Get Unprocessed Messages","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"jsCode":"const messages = $input.all();\n// Store the IDs of the messages we are processing\nconst messageIds = messages.map(item => item.json.id);\n// Combine the text of all messages into one string\nconst bundledText = messages.map(item => item.json.text).join('\\n\\n---\\n\\n');\n\nconst jobs = $(\"Found?\").all();\nconst jobsIds = jobs.map(item => item.json.id);\n\n// Pass both the bundled text and the IDs to the next nodes\nreturn {\n  bundledText,\n  processedMessageIds: messageIds,\n  jobsIds\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,-480],"id":"2ff3a166-98f0-459b-a2f8-a75925343d6f","name":"Bundle Messages"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d75e122-ad45-4b13-b858-53be7d7ba2a8","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[432,-480],"id":"14ed4e2c-bbc5-4f16-98c9-ad85b480d55b","name":"Found?"},{"parameters":{"operation":"executeQuery","query":"UPDATE public.slack_messages\nSET processed_by_ai_at = '{{ $now.toISO() }}'\nWHERE id IN ({{ $('Bundle Messages').item.json.processedMessageIds.join(\",\") }})","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3344,-480],"id":"a57f07dd-3ee9-4f32-9816-72c4390d3c79","name":"Mark Messages as Processed","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"operation":"executeQuery","query":"DELETE FROM public.ai_processing_queue\nWHERE id IN ({{ $('Bundle Messages').item.json.jobsIds.join(\",\") }})","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3568,-480],"id":"9df2e22a-f6b6-407e-9c24-c45bf39437b4","name":"Delete Jobs","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"workflowId":{"__rl":true,"value":"dl7Ouu4fFql85VAB","mode":"list","cachedResultUrl":"/workflow/dl7Ouu4fFql85VAB","cachedResultName":"[Slack] Send Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{"save":false,"text":"_Thinking_ :brain:","slack_user_id":"={{ $('Get Unprocessed Messages').first().json.slack_user_id }}"},"matchingColumns":[],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"text","displayName":"text","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"save","displayName":"save","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1104,-480],"id":"3784bd29-ec95-4f4a-a64c-05be4f901c8f","name":"Call '[Slack] Send Message'"},{"parameters":{"workflowId":{"__rl":true,"value":"p5XnT4dNLsVCSXNl","mode":"list","cachedResultUrl":"/workflow/p5XnT4dNLsVCSXNl","cachedResultName":"[Slack] Get Cached User by Slack ID"},"workflowInputs":{"mappingMode":"defineBelow","value":{"slack_user_id":"={{ $('Get Unprocessed Messages').first().json.slack_user_id }}"},"matchingColumns":["message_from_id"],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1328,-480],"name":"Get Cached User by Slack ID","id":"2489883d-f314-445e-8120-514554440867"},{"parameters":{"workflowId":{"__rl":true,"value":"dl7Ouu4fFql85VAB","mode":"list","cachedResultUrl":"/workflow/dl7Ouu4fFql85VAB","cachedResultName":"[Slack] Send Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{"save":true,"text":"={{ $json.response }}","slack_user_id":"={{ $('Get Unprocessed Messages').first().json.slack_user_id }}","tool_activity":"={{ $json.toolActivity ?? [] }}"},"matchingColumns":[],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"text","displayName":"text","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"save","displayName":"save","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean","removed":false},{"id":"tool_activity","displayName":"tool_activity","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[2896,-480],"id":"8f373d6a-d17d-42ae-9f01-4bf20a9f921b","name":"Send Slack Message","retryOnFail":true},{"parameters":{"mode":"chooseBranch","useDataOfInput":2},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2672,-480],"id":"78d28d2f-9d83-41df-98f9-291352b8bdd8","name":"Merge"},{"parameters":{"workflowId":{"__rl":true,"value":"uHLn3qmIi4h9SZPT","mode":"list","cachedResultUrl":"/workflow/uHLn3qmIi4h9SZPT","cachedResultName":"[Slack] Delete Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{"channel_id":"={{ $('Call \\'[Slack] Send Message\\'').item.json.channel }}","message_ts":"={{ $('Call \\'[Slack] Send Message\\'').item.json.ts }}","slack_user_id":"={{ $('Get Unprocessed Messages').first().json.slack_user_id }}"},"matchingColumns":[],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"channel_id","displayName":"channel_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"message_ts","displayName":"message_ts","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[2448,-544],"id":"40339135-27bc-4867-9ae9-85eb98f21579","name":"Call '[Slack] Delete Message'"}],"connections":{"Get Chat History":{"main":[[{"node":"Get Time Zone","type":"main","index":0}]]},"Filter Chat History":{"main":[[{"node":"Send to Agent","type":"main","index":0}]]},"Send to Agent":{"main":[[{"node":"Merge","type":"main","index":1},{"node":"Call '[Slack] Delete Message'","type":"main","index":0}]]},"Refresh Caches":{"main":[[{"node":"Mark Messages as Processed","type":"main","index":0}]]},"Get Time Zone":{"main":[[{"node":"Filter Chat History","type":"main","index":0}]]},"Fetch Due Job":{"main":[[{"node":"Found?","type":"main","index":0}]]},"Schedule 2 Seconds":{"main":[[{"node":"Fetch Due Job","type":"main","index":0}]]},"Get Unprocessed Messages":{"main":[[{"node":"Bundle Messages","type":"main","index":0}]]},"Bundle Messages":{"main":[[{"node":"Call '[Slack] Send Message'","type":"main","index":0}]]},"Found?":{"main":[[{"node":"Get Unprocessed Messages","type":"main","index":0}]]},"Mark Messages as Processed":{"main":[[{"node":"Delete Jobs","type":"main","index":0}]]},"Call '[Slack] Send Message'":{"main":[[{"node":"Get Cached User by Slack ID","type":"main","index":0}]]},"Get Cached User by Slack ID":{"main":[[{"node":"Get Chat History","type":"main","index":0}]]},"Send Slack Message":{"main":[[{"node":"Refresh Caches","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Send Slack Message","type":"main","index":0}]]},"Call '[Slack] Delete Message'":{"main":[[{"node":"Merge","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule 2 Seconds":{"recurrenceRules":[]}},"meta":null,"pinData":{"Schedule 2 Seconds":[{"json":{"timestamp":"2025-11-26T01:45:22.001+01:00","Readable date":"November 26th 2025, 1:45:22 am","Readable time":"1:45:22 am","Day of week":"Wednesday","Year":"2025","Month":"November","Day of month":"26","Hour":"01","Minute":"45","Second":"22","Timezone":"Europe/Berlin (UTC+01:00)"}}]},"versionId":"afaa1760-3e8f-45d0-9e8b-94e011d3e9e8","activeVersionId":"afaa1760-3e8f-45d0-9e8b-94e011d3e9e8","triggerCount":1,"shared":[{"updatedAt":"2025-11-22T20:38:32.358Z","createdAt":"2025-11-22T20:38:32.358Z","role":"workflow:owner","workflowId":"2XrGeLFaoPh5Fhbl","projectId":"8nyfoRCh3nEYWaKJ"}],"activeVersion":{"updatedAt":"2025-11-26T00:46:11.824Z","createdAt":"2025-11-26T00:46:11.824Z","versionId":"afaa1760-3e8f-45d0-9e8b-94e011d3e9e8","workflowId":"2XrGeLFaoPh5Fhbl","nodes":[{"parameters":{"workflowId":{"__rl":true,"value":"XFQFb7sUMTyKg2dV","mode":"list","cachedResultUrl":"/workflow/XFQFb7sUMTyKg2dV","cachedResultName":"[Slack] Get Cached Slack Conversation"},"workflowInputs":{"mappingMode":"defineBelow","value":{"slack_user_id":"={{ $('Get Unprocessed Messages').first().json.slack_user_id }}"},"matchingColumns":["telegramId"],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1552,-480],"id":"ff645477-58ee-446e-b8a3-36e93e9115c6","name":"Get Chat History"},{"parameters":{"jsCode":"/**\n * Filter a chat history to only the last 2 hours and convert dates to a given time zone.\n *\n * @param {Array<{date:string,message:string,role:string}>} history\n * @param {string} tz IANA time zone, e.g. \"America/New_York\"\n * @param {number} hoursBack (optional) default 2\n * @returns {Array<{date:string,message:string,role:string}>}\n */\nfunction filterAndConvert(history, tz, hoursBack = 2) {\n  const nowUtc = Date.now();\n  const cutoffUtc = nowUtc - hoursBack * 60 * 60 * 1000;\n\n  return history\n    .filter(item => new Date(item.date).getTime() >= cutoffUtc)\n    .map(item => ({\n      ...item,\n      date: toTZISO(item.date, tz),\n    }));\n}\n\n/**\n * Convert an ISO string to the same moment expressed in another time zone,\n * returned as \"YYYY-MM-DDTHH:mm:ss[±HH:MM]\" (no milliseconds).\n *\n * Uses only built-ins (Intl.DateTimeFormat).\n */\nfunction toTZISO(dateString, tz) {\n  const d = new Date(dateString);\n\n  // Grab all parts in the desired TZ\n  const parts = new Intl.DateTimeFormat('en-CA', {\n    timeZone: tz,\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n    second: '2-digit',\n    hour12: false,\n  }).formatToParts(d).reduce((acc, p) => {\n    acc[p.type] = p.value;\n    return acc;\n  }, {});\n\n  // Build local datetime string\n  const local = `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}`;\n\n  // Compute offset for that TZ at that instant\n  const offsetMinutes = getOffsetMinutes(d, tz);\n  const sign = offsetMinutes >= 0 ? '+' : '-';\n  const abs = Math.abs(offsetMinutes);\n  const hh = String(Math.floor(abs / 60)).padStart(2, '0');\n  const mm = String(abs % 60).padStart(2, '0');\n\n  return `${local}${sign}${hh}:${mm}`;\n}\n\n/**\n * Find the UTC offset (in minutes) of a date in a given TZ using Intl.\n */\nfunction getOffsetMinutes(date, tz) {\n  // Format the same date in UTC and in the TZ, compare epoch millis reconstructed\n  const fmt = (zone) => {\n    const parts = new Intl.DateTimeFormat('en-CA', {\n      timeZone: zone,\n      year: 'numeric',\n      month: '2-digit',\n      day: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n      second: '2-digit',\n      hour12: false,\n    }).formatToParts(date).reduce((acc, p) => {\n      acc[p.type] = p.value;\n      return acc;\n    }, {});\n    return Date.UTC(\n      Number(parts.year),\n      Number(parts.month) - 1,\n      Number(parts.day),\n      Number(parts.hour),\n      Number(parts.minute),\n      Number(parts.second)\n    );\n  };\n\n  const asUtcMillis = fmt('UTC');\n  const asTzMillis = fmt(tz);\n  return (asTzMillis - asUtcMillis) / (60 * 1000);\n}\n\nconst history = $('Get Chat History').first().json.chat_history;\nconst tz = $('Get Time Zone').first().json.timeZone || 'America/New_York';\n\nconst filtered = filterAndConvert(history, tz);\n\n// Return as n8n items\nreturn { json: { history: filtered } };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2000,-480],"id":"3529be3c-a102-4c0a-9d5e-5248de79aeda","name":"Filter Chat History"},{"parameters":{"workflowId":{"__rl":true,"value":"KhXkPpKZls1wrj5t","mode":"list","cachedResultUrl":"/workflow/KhXkPpKZls1wrj5t","cachedResultName":"[Slack] Slack Tomo Scheduler"},"workflowInputs":{"mappingMode":"defineBelow","value":{"chat_history":"={{ $json }}","user_message":"={{ $('Bundle Messages').item.json.bundledText }}","time_zone":"={{ $('Get Time Zone').first().json.time_zone }}","user":"={{ $('Get Cached User by Slack ID').item.json }}","slack_user_id":"={{ $('Get Unprocessed Messages').first().json.slack_user_id }}","channel_id":"={{ $('Call \\'[Slack] Send Message\\'').item.json.channel }}","message_ts":"={{ $('Call \\'[Slack] Send Message\\'').item.json.message.ts }}"},"matchingColumns":[],"schema":[{"id":"chat_history","displayName":"chat_history","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object"},{"id":"time_zone","displayName":"time_zone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_message","displayName":"user_message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user","displayName":"user","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object","removed":false},{"id":"context","displayName":"context","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"channel_id","displayName":"channel_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"message_ts","displayName":"message_ts","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"mode":"each","options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2224,-480],"id":"0ff33377-847b-465a-a5be-5e765c1f447f","name":"Send to Agent"},{"parameters":{"workflowId":{"__rl":true,"value":"w6HobcwNKb3K2hYo","mode":"list","cachedResultUrl":"/workflow/w6HobcwNKb3K2hYo","cachedResultName":"[Slack] Refresh Cached Slack Chat History and Time Zone"},"workflowInputs":{"mappingMode":"defineBelow","value":{"slack_user_id":"={{ $('Get Unprocessed Messages').first().json.sender_id }}","user_id":"={{ $('Get Cached User by Slack ID').item.json.id }}"},"matchingColumns":[],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[3120,-480],"id":"d074dc4f-777a-420a-93f3-7283f9b308e5","name":"Refresh Caches"},{"parameters":{"workflowId":{"__rl":true,"value":"NSHJ7N5HuSWzl9c0","mode":"list","cachedResultUrl":"/workflow/NSHJ7N5HuSWzl9c0","cachedResultName":"[Slack] Get Slack Time Zone [TO-DO]"},"workflowInputs":{"mappingMode":"defineBelow","value":{"userId":"={{ $('Get Cached User by Slack ID').first().json.id }}"},"matchingColumns":["userId"],"schema":[{"id":"userId","displayName":"userId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1776,-480],"id":"e31e34f9-da25-4bc8-b1f9-d11dc273b008","name":"Get Time Zone"},{"parameters":{"operation":"executeQuery","query":"UPDATE public.ai_processing_queue\nSET status = 'processing', updated_at = NOW()\nWHERE id = (\n  SELECT id\n  FROM public.ai_processing_queue\n  WHERE status = 'pending' AND process_at <= NOW()\n  AND type = 'slack'\n  ORDER BY process_at\n  LIMIT 1\n  FOR UPDATE SKIP LOCKED\n)\nRETURNING *;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[208,-480],"id":"1ce2fddf-2f70-483c-94dd-710931963c6f","name":"Fetch Due Job","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"rule":{"interval":[{"field":"seconds","secondsInterval":2}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-16,-480],"id":"41f2cdd9-b855-4dd8-ba2b-a2e7e6170929","name":"Schedule 2 Seconds"},{"parameters":{"operation":"executeQuery","query":"SELECT *\nFROM public.slack_messages\nWHERE sender_id = '{{ $('Found?').item.json.sender_id }}'\n  AND processed_by_ai_at IS NULL\nORDER BY slack_message_ts ASC;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[656,-480],"id":"a6e6d6fb-ecc2-4bba-b547-e803df541b0c","name":"Get Unprocessed Messages","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"jsCode":"const messages = $input.all();\n// Store the IDs of the messages we are processing\nconst messageIds = messages.map(item => item.json.id);\n// Combine the text of all messages into one string\nconst bundledText = messages.map(item => item.json.text).join('\\n\\n---\\n\\n');\n\nconst jobs = $(\"Found?\").all();\nconst jobsIds = jobs.map(item => item.json.id);\n\n// Pass both the bundled text and the IDs to the next nodes\nreturn {\n  bundledText,\n  processedMessageIds: messageIds,\n  jobsIds\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,-480],"id":"2ff3a166-98f0-459b-a2f8-a75925343d6f","name":"Bundle Messages"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d75e122-ad45-4b13-b858-53be7d7ba2a8","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[432,-480],"id":"14ed4e2c-bbc5-4f16-98c9-ad85b480d55b","name":"Found?"},{"parameters":{"operation":"executeQuery","query":"UPDATE public.slack_messages\nSET processed_by_ai_at = '{{ $now.toISO() }}'\nWHERE id IN ({{ $('Bundle Messages').item.json.processedMessageIds.join(\",\") }})","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3344,-480],"id":"a57f07dd-3ee9-4f32-9816-72c4390d3c79","name":"Mark Messages as Processed","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"operation":"executeQuery","query":"DELETE FROM public.ai_processing_queue\nWHERE id IN ({{ $('Bundle Messages').item.json.jobsIds.join(\",\") }})","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3568,-480],"id":"9df2e22a-f6b6-407e-9c24-c45bf39437b4","name":"Delete Jobs","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"workflowId":{"__rl":true,"value":"dl7Ouu4fFql85VAB","mode":"list","cachedResultUrl":"/workflow/dl7Ouu4fFql85VAB","cachedResultName":"[Slack] Send Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{"save":false,"text":"_Thinking_ :brain:","slack_user_id":"={{ $('Get Unprocessed Messages').first().json.slack_user_id }}"},"matchingColumns":[],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"text","displayName":"text","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"save","displayName":"save","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1104,-480],"id":"3784bd29-ec95-4f4a-a64c-05be4f901c8f","name":"Call '[Slack] Send Message'"},{"parameters":{"workflowId":{"__rl":true,"value":"p5XnT4dNLsVCSXNl","mode":"list","cachedResultUrl":"/workflow/p5XnT4dNLsVCSXNl","cachedResultName":"[Slack] Get Cached User by Slack ID"},"workflowInputs":{"mappingMode":"defineBelow","value":{"slack_user_id":"={{ $('Get Unprocessed Messages').first().json.slack_user_id }}"},"matchingColumns":["message_from_id"],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1328,-480],"name":"Get Cached User by Slack ID","id":"2489883d-f314-445e-8120-514554440867"},{"parameters":{"workflowId":{"__rl":true,"value":"dl7Ouu4fFql85VAB","mode":"list","cachedResultUrl":"/workflow/dl7Ouu4fFql85VAB","cachedResultName":"[Slack] Send Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{"save":true,"text":"={{ $json.response }}","slack_user_id":"={{ $('Get Unprocessed Messages').first().json.slack_user_id }}","tool_activity":"={{ $json.toolActivity ?? [] }}"},"matchingColumns":[],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"text","displayName":"text","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"save","displayName":"save","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean","removed":false},{"id":"tool_activity","displayName":"tool_activity","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[2896,-480],"id":"8f373d6a-d17d-42ae-9f01-4bf20a9f921b","name":"Send Slack Message","retryOnFail":true},{"parameters":{"mode":"chooseBranch","useDataOfInput":2},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2672,-480],"id":"78d28d2f-9d83-41df-98f9-291352b8bdd8","name":"Merge"},{"parameters":{"workflowId":{"__rl":true,"value":"uHLn3qmIi4h9SZPT","mode":"list","cachedResultUrl":"/workflow/uHLn3qmIi4h9SZPT","cachedResultName":"[Slack] Delete Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{"channel_id":"={{ $('Call \\'[Slack] Send Message\\'').item.json.channel }}","message_ts":"={{ $('Call \\'[Slack] Send Message\\'').item.json.ts }}","slack_user_id":"={{ $('Get Unprocessed Messages').first().json.slack_user_id }}"},"matchingColumns":[],"schema":[{"id":"slack_user_id","displayName":"slack_user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"channel_id","displayName":"channel_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"message_ts","displayName":"message_ts","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[2448,-544],"id":"40339135-27bc-4867-9ae9-85eb98f21579","name":"Call '[Slack] Delete Message'"}],"connections":{"Get Chat History":{"main":[[{"node":"Get Time Zone","type":"main","index":0}]]},"Filter Chat History":{"main":[[{"node":"Send to Agent","type":"main","index":0}]]},"Send to Agent":{"main":[[{"node":"Merge","type":"main","index":1},{"node":"Call '[Slack] Delete Message'","type":"main","index":0}]]},"Refresh Caches":{"main":[[{"node":"Mark Messages as Processed","type":"main","index":0}]]},"Get Time Zone":{"main":[[{"node":"Filter Chat History","type":"main","index":0}]]},"Fetch Due Job":{"main":[[{"node":"Found?","type":"main","index":0}]]},"Schedule 2 Seconds":{"main":[[{"node":"Fetch Due Job","type":"main","index":0}]]},"Get Unprocessed Messages":{"main":[[{"node":"Bundle Messages","type":"main","index":0}]]},"Bundle Messages":{"main":[[{"node":"Call '[Slack] Send Message'","type":"main","index":0}]]},"Found?":{"main":[[{"node":"Get Unprocessed Messages","type":"main","index":0}]]},"Mark Messages as Processed":{"main":[[{"node":"Delete Jobs","type":"main","index":0}]]},"Call '[Slack] Send Message'":{"main":[[{"node":"Get Cached User by Slack ID","type":"main","index":0}]]},"Get Cached User by Slack ID":{"main":[[{"node":"Get Chat History","type":"main","index":0}]]},"Send Slack Message":{"main":[[{"node":"Refresh Caches","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Send Slack Message","type":"main","index":0}]]},"Call '[Slack] Delete Message'":{"main":[[{"node":"Merge","type":"main","index":0}]]}},"authors":"Dev JIA","name":null,"description":null},"tags":[]}