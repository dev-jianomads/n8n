{"createdAt":"2025-10-22T21:56:12.597Z","updatedAt":"2025-10-23T16:59:41.450Z","id":"9OyASSckcIeMWtfb","name":"[TG] Get Time Zone","active":false,"isArchived":false,"nodes":[{"parameters":{"workflowInputs":{"values":[{"name":"userId"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-1840,384],"id":"36309d80-fff7-4d68-a769-1cf786bdf3c5","name":"When Executed by Another Workflow"},{"parameters":{"workflowId":{"__rl":true,"value":"pE2lsrstziYiLtF8","mode":"list","cachedResultUrl":"/workflow/pE2lsrstziYiLtF8","cachedResultName":"[TG] Get Token for TG Integration"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('When Executed by Another Workflow').first().json.userId }}"},"matchingColumns":["user_id"],"schema":[{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[624,432],"id":"a6fa68a1-fabd-47ad-84b9-dc665f854c99","name":"Get Token"},{"parameters":{"url":"https://www.googleapis.com/calendar/v3/calendars/primary","sendQuery":true,"queryParameters":{"parameters":[{"name":"fields","value":"timeZone"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('Get Token').first().json.accessToken }}"},{"name":"Content-Type","value":"application/json"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[848,432],"id":"97357c4d-40cd-44c9-bcfd-c8c64bd566ab","name":"Get Time Zone from Primary Calendar","retryOnFail":true,"alwaysOutputData":false,"onError":"continueErrorOutput"},{"parameters":{"jsonSchemaExample":"{\n  \"time_zone\": \"Europe/Paris\",\n  \"confidence\": 0.9,\n  \"present_like\": true,\n  \"reason\": \"Reason\"\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[32,80],"id":"43156f79-c54e-44b3-b64e-b6e0e0a6f0f1","name":"Structured Output Parser"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1","mode":"list","cachedResultName":"gpt-4.1"},"options":{"temperature":0}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[32,288],"id":"2b57de7d-3121-456e-bfba-da9539cac739","name":"4.1","credentials":{"openAiApi":{"id":"JNBPFneOXwzjzSKh","name":"OpenAI account"}}},{"parameters":{"promptType":"define","text":"=Last messages (newest first): {{ JSON.stringify($('Aggregate').first().json.messages) }}","hasOutputParser":true,"options":{"systemMessage":"=You are a precise Time Zone Extractor. Decide the user’s CURRENT time zone from the messages. Only accept explicit present statements (“I’m in…”, “here in…”, “just landed…”, “back in…”). If the text is about planning, travel ideas, or future/past, return null.\n\nOutput JSON only:\n{\n  \"time_zone\": \"IANA or null\",\n  \"confidence\": 0.0-1.0,\n  \"present_like\": true|false,\n  \"reason\": \"short\"\n}\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[-48,-144],"id":"d0757855-d58a-46f2-b31d-ea108f6127ce","name":"LLM Verifier"},{"parameters":{"operation":"executeQuery","query":"insert into public.tz_presence_cache\n  (user_id, tz, source, strength, observed_at, committed_at, last_checked_at, evidence_message_id, evidence_text, updated_at)\nvalues\n  ($1::text, $2::text, 'chat_explicit', $3::numeric, now(), now(), now(), null, $4::text, now())\non conflict (user_id) do update set\n  tz = excluded.tz,\n  source = excluded.source,\n  strength = excluded.strength,\n  observed_at = excluded.observed_at,\n  committed_at = excluded.committed_at,\n  last_checked_at = excluded.last_checked_at,\n  evidence_message_id = excluded.evidence_message_id,\n  evidence_text = excluded.evidence_text,\n  updated_at = now();\n","options":{"queryReplacement":"={{ [$('When Executed by Another Workflow').item.json.userId, $json.output.time_zone, $json.output.confidence, $json.output.reason] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[624,16],"id":"161f3ab0-eb28-4527-aeca-3f13e35072a9","name":"Upsert (Chat)","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"time_zone\": \"{{ $('Confident Output?').item.json.output.time_zone }}\",\n  \"confidence\": {{ $('Confident Output?').item.json.output.confidence }},\n  \"source\": \"chat_explicit\",\n  \"reason\": \"{{ $('Confident Output?').item.json.output.reason }}\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[848,16],"id":"acb443cc-062a-494f-96c7-6295aedbbaa3","name":"Set (Chat)"},{"parameters":{"operation":"executeQuery","query":"insert into public.tz_presence_cache\n  (user_id, tz, source, strength, observed_at, committed_at, last_checked_at, updated_at)\nvalues\n  ($1::text, $2::text, 'calendar_setting', 0.6, now(), now(), now(), now())\non conflict (user_id) do update set\n  tz = excluded.tz,\n  source = excluded.source,\n  strength = excluded.strength,\n  observed_at = excluded.observed_at,\n  committed_at = excluded.committed_at,\n  last_checked_at = excluded.last_checked_at,\n  updated_at = now();","options":{"queryReplacement":"={{ [$('When Executed by Another Workflow').item.json.userId, $json.timeZone] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1072,336],"id":"747d20e5-6b9b-4c20-b2ea-22f0b1a49f3f","name":"Upsert (Calendar Settings)","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_user_telegram_messages(\n  '{{ $(\"When Executed by Another Workflow\").item.json.userId }}',\n  8,\n  'inbound'\n) as messages;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1616,384],"id":"54347957-5655-40bb-9da8-b8807fa4d088","name":"Get Last N Messages","alwaysOutputData":true,"retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"messages","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-1168,272],"id":"e0a3c220-8e0e-4c21-8abc-ed2aeee5ba41","name":"Aggregate"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"598c9c69-e75a-449e-a070-2df69dc89708","leftValue":"={{ $json.shouldCallLLM }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-720,272],"id":"e9cd38f8-7fd2-4cc3-853e-06db43a9edec","name":"Should Call LLM?"},{"parameters":{"operation":"executeQuery","query":"select tz, strength, observed_at\nfrom public.tz_presence_cache\nwhere user_id = '{{ $('When Executed by Another Workflow').item.json.userId }}';\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-496,416],"id":"ded01ad3-4e24-44ee-b321-51fe726c6c18","name":"Get Cache","alwaysOutputData":true,"retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c3f6ba0e-a006-42c1-b766-70b5aba9026a","leftValue":"={{ $json.isNotEmpty() && $json.strength >= 0.6 && (Math.abs($json.observed_at.toDateTime().diffToNow('hours'))) <= 24 }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-272,416],"id":"fd99c2d8-daaf-4d70-a44c-f131867a3658","name":"Use Cache?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d59c2e2-5e56-4fab-a8df-791763632dfb","leftValue":"={{ $json.isNotEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1392,384],"id":"8232f252-758b-4c42-8113-fb2f80138fdc","name":"Messages?"},{"parameters":{"operation":"executeQuery","query":"select tz, strength, observed_at\nfrom public.tz_presence_cache\nwhere user_id = '{{ $('When Executed by Another Workflow').item.json.userId }}';\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-496,656],"id":"399d41d4-73ae-4cf7-9d76-8c462e92b970","name":"Get Cache [No Messages]","alwaysOutputData":true,"retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c3f6ba0e-a006-42c1-b766-70b5aba9026a","leftValue":"={{ $json.isNotEmpty() && $json.strength >= 0.6 && (Math.abs($json.observed_at.toDateTime().diffToNow('hours'))) <= 24 }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-272,656],"id":"bb7afa9e-211a-4170-ab9e-2ee4872d88d0","name":"Use Cache? [No Messages]"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"time_zone\": \"{{ $json.tz }}\",\n  \"confidence\": {{ $json.strength }},\n  \"source\": \"cache\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[64,464],"id":"93b16200-b654-4121-b740-7f480224288c","name":"Set (Cache)"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"043ca09e-4f59-4993-ad99-c2252254e300","leftValue":"={{ $json.output.present_like && $json.output.time_zone && $json.output.confidence >= 0.75}}","rightValue":0,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[400,64],"id":"16fc3b55-5a43-4e25-bba3-12f7a7868412","name":"Confident Output?"},{"parameters":{"jsCode":"// PresenceTrigger\nconst row = $input.first().json.messages[0] || {};\nconst txt = (row.text || \"\").toLowerCase();\n\nconst triggers = [\n  /\\b(i'?m|i am)\\s+in\\s+[a-z][a-z\\s\\-]{2,}/,\n  /\\b(here in|based in|staying in|living in)\\s+[a-z][a-z\\s\\-]{2,}/,\n  /\\b(just landed in|landed in|arrived in|back in)\\s+[a-z][a-z\\s\\-]{2,}/,\n  /\\b(now in)\\s+[a-z][a-z\\s\\-]{2,}/\n];\nconst futures = [/\\b(heading to|going to|will be in|tomorrow|next week)\\b/];\n\nconst shouldCallLLM = triggers.some(r => r.test(txt)) && !futures.some(r => r.test(txt));\nreturn [{ shouldCallLLM, lastMessageId: row.id, lastMessageText: row.text, lastTs: row.ts }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-944,272],"id":"f796fa10-d329-427b-96f8-f3ebecda6574","name":"Validate LLM Need"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"time_zone\": \"{{$('Get Time Zone from Primary Calendar').item.json.timeZone}}\",\n  \"confidence\": 0.6,\n  \"source\": \"calendar_setting\",\n  \"reason\": \"Falling back to Google Calendar account setting.\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1296,336],"id":"88d4d91c-a294-4692-a31b-6a815f42fd5c","name":"Set (Calendar Settings)"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"time_zone\": \"Etc/UTC\",\n  \"confidence\": 0.1,\n  \"source\": \"default\",\n  \"reason\": \"All other methods failed. Defaulting to UTC\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1072,528],"id":"e52b0896-b2a2-4062-a162-36bfeecdb07f","name":"Set (UTC Default)"}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Get Last N Messages","type":"main","index":0}]]},"Get Token":{"main":[[{"node":"Get Time Zone from Primary Calendar","type":"main","index":0}]]},"Get Time Zone from Primary Calendar":{"main":[[{"node":"Upsert (Calendar Settings)","type":"main","index":0}],[{"node":"Set (UTC Default)","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"LLM Verifier","type":"ai_outputParser","index":0}]]},"4.1":{"ai_languageModel":[[{"node":"LLM Verifier","type":"ai_languageModel","index":0},{"node":"Structured Output Parser","type":"ai_languageModel","index":0}]]},"LLM Verifier":{"main":[[{"node":"Confident Output?","type":"main","index":0}]]},"Upsert (Chat)":{"main":[[{"node":"Set (Chat)","type":"main","index":0}]]},"Upsert (Calendar Settings)":{"main":[[{"node":"Set (Calendar Settings)","type":"main","index":0}]]},"Get Last N Messages":{"main":[[{"node":"Messages?","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Validate LLM Need","type":"main","index":0}]]},"Should Call LLM?":{"main":[[{"node":"LLM Verifier","type":"main","index":0}],[{"node":"Get Cache","type":"main","index":0}]]},"Get Cache":{"main":[[{"node":"Use Cache?","type":"main","index":0}]]},"Use Cache?":{"main":[[{"node":"Set (Cache)","type":"main","index":0}],[{"node":"LLM Verifier","type":"main","index":0}]]},"Messages?":{"main":[[{"node":"Aggregate","type":"main","index":0}],[{"node":"Get Cache [No Messages]","type":"main","index":0}]]},"Get Cache [No Messages]":{"main":[[{"node":"Use Cache? [No Messages]","type":"main","index":0}]]},"Use Cache? [No Messages]":{"main":[[{"node":"Set (Cache)","type":"main","index":0}],[{"node":"Get Token","type":"main","index":0}]]},"Confident Output?":{"main":[[{"node":"Upsert (Chat)","type":"main","index":0}],[{"node":"Get Token","type":"main","index":0}]]},"Validate LLM Need":{"main":[[{"node":"Should Call LLM?","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"When Executed by Another Workflow":[{"json":{"userId":"t07ZDdtiVLduDE3RuRHGKowoSd0f"}}],"LLM Verifier":[{"json":{"output":{"time_zone":"Europe/Paris","confidence":1,"present_like":true,"reason":"User explicitly stated 'I'm actually in France' and 'just landed in Paris' in the most recent messages."}}}]},"versionId":"f69e6285-b9b9-4738-9ad2-47a3174c7405","triggerCount":0,"shared":[{"createdAt":"2025-10-22T21:56:12.597Z","updatedAt":"2025-10-22T21:56:12.597Z","role":"workflow:owner","workflowId":"9OyASSckcIeMWtfb","projectId":"8nyfoRCh3nEYWaKJ"}],"tags":[]}