{"updatedAt":"2025-11-05T21:56:21.565Z","createdAt":"2025-11-05T21:42:16.169Z","id":"FIxK0VneW1maD1Hi","name":">>>> [WA] Receive Message (Buffered)","active":false,"isArchived":false,"nodes":[{"parameters":{"updates":["messages"],"options":{}},"type":"n8n-nodes-base.whatsAppTrigger","typeVersion":1,"position":[-944,480],"id":"8ac4197f-663a-4f94-a649-7277334dd2e4","name":"WhatsApp Trigger","webhookId":"9c276208-4753-4cad-9db7-3f9aea7b200c","credentials":{"whatsAppTriggerApi":{"id":"E6zgzaiMKkzeqacR","name":"WhatsApp OAuth account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_whatsapp_user('{{ $json.contacts[0].wa_id }}');","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-496,576],"id":"d3656a4d-a695-4004-8a2c-c98d02322327","name":"Find User by WhatsApp ID","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4e2daa52-5c2f-46ab-a36d-9801b6a117dd","leftValue":"={{ $json.get_whatsapp_user }}","rightValue":"","operator":{"type":"object","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-272,576],"id":"9da30c45-2bcb-4bd0-85af-34492f6770a7","name":"Found?"},{"parameters":{"operation":"send","phoneNumberId":"749915891538765","recipientPhoneNumber":"=+{{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}","textBody":"=Hi! Please sign up here: https://cal.hellotomo.ai/welcome?service=whatsapp&id={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}","additionalFields":{}},"type":"n8n-nodes-base.whatsApp","typeVersion":1.1,"position":[-48,672],"id":"1f2ddfb3-7cc2-4a4b-a886-e44cee3b52ea","name":"Send Sign Up URL","webhookId":"6cdfa395-548b-477e-b41d-ae5117358a8a","credentials":{"whatsAppApi":{"id":"hn7HYT0djID7QTau","name":"WhatsApp account"}}},{"parameters":{"assignments":{"assignments":[{"id":"994defb3-f232-4a03-a0c8-248ff454b522","name":"timetampUTC","value":"={{ $('WhatsApp Trigger').item.json.messages[0].timestamp.toDateTime('s').toUTC().toISO() }}","type":"string"},{"id":"59998172-9c6b-483c-aa57-c2a4911ac059","name":"tomoWhatsAppId","value":"15551366684","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-48,480],"id":"0900ace0-e29f-474f-b9b9-2724318515bd","name":"Parse Timestamp from Inbound WhatsApp message"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b2971a46-fdc6-41c9-bceb-6573a287f960","leftValue":"={{ $json.keys().includes(\"statuses\") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-720,480],"id":"d6bc2fb1-2565-42fc-ad17-8bc192bc2d30","name":"Status Update"},{"parameters":{"fieldToSplitOut":"statuses","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-496,288],"id":"b78a338c-d92b-4ccb-b777-1efac88fe065","name":"Split Out"},{"parameters":{"operation":"update","tableId":"whatsapp_messages","filters":{"conditions":[{"keyName":"whatsapp_message_id","condition":"eq","keyValue":"={{ $json.id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"={{ $json.status }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-48,288],"id":"6f4f6c00-6ac4-4127-b639-5c0762c6bc0c","name":"Update a row","credentials":{"supabaseApi":{"id":"PwJN4yKDRZqivq2f","name":"Supabase account"}},"onError":"continueRegularOutput"},{"parameters":{"amount":2},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-272,288],"id":"e24d303c-8028-417d-a281-87b3746d2d72","name":"Wait 2 seconds","webhookId":"69b3dce9-c570-4b52-b895-178a14e9782d"},{"parameters":{"tableId":"whatsapp_messages","fieldsUi":{"fieldValues":[{"fieldId":"whatsapp_date","fieldValue":"={{ $('WhatsApp Trigger').item.json.messages[0].timestamp }}"},{"fieldId":"whatsapp_date_utc","fieldValue":"={{ $json.timetampUTC }}"},{"fieldId":"text","fieldValue":"={{ $('WhatsApp Trigger').item.json.messages[0].text.body }}"},{"fieldId":"direction","fieldValue":"inbound"},{"fieldId":"sender_id","fieldValue":"={{ $('WhatsApp Trigger').item.json.messages[0].from }}"},{"fieldId":"recipient_id","fieldValue":"={{ $json.tomoWhatsAppId }}"},{"fieldId":"raw_payload","fieldValue":"={{ $('WhatsApp Trigger').item.json }}"},{"fieldId":"whatsapp_message_id","fieldValue":"={{ $('WhatsApp Trigger').item.json.messages[0].id }}"},{"fieldId":"status","fieldValue":"delivered"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[176,480],"id":"a6594811-e926-40b2-ac1c-df737951030b","name":"Save Message1","retryOnFail":true,"credentials":{"supabaseApi":{"id":"PwJN4yKDRZqivq2f","name":"Supabase account"}}},{"parameters":{"operation":"upsert","schema":{"__rl":true,"value":"=public","mode":"name"},"table":{"__rl":true,"value":"ai_processing_queue","mode":"list","cachedResultName":"ai_processing_queue"},"columns":{"mappingMode":"defineBelow","value":{"status":"pending","process_at":"={{ $now.plus({ seconds: 5 }).toISO() }}","sender_id":"={{ $('WhatsApp Trigger').item.json.messages[0].from }}","type":"whatsapp"},"matchingColumns":["sender_id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false,"removed":true},{"id":"updated_at","displayName":"updated_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false,"removed":true},{"id":"sender_id","displayName":"sender_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false},{"id":"process_at","displayName":"process_at","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false},{"id":"type","displayName":"type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[400,480],"id":"90f94e12-d9b2-4aa4-b149-4230306ac4a2","name":"Upsert Job1","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}}],"connections":{"WhatsApp Trigger":{"main":[[{"node":"Status Update","type":"main","index":0}]]},"Find User by WhatsApp ID":{"main":[[{"node":"Found?","type":"main","index":0}]]},"Found?":{"main":[[{"node":"Parse Timestamp from Inbound WhatsApp message","type":"main","index":0}],[{"node":"Send Sign Up URL","type":"main","index":0}]]},"Parse Timestamp from Inbound WhatsApp message":{"main":[[{"node":"Save Message1","type":"main","index":0}]]},"Status Update":{"main":[[{"node":"Split Out","type":"main","index":0}],[{"node":"Find User by WhatsApp ID","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"Wait 2 seconds","type":"main","index":0}]]},"Wait 2 seconds":{"main":[[{"node":"Update a row","type":"main","index":0}]]},"Save Message1":{"main":[[{"node":"Upsert Job1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"ea360e0c-f219-4587-b5f8-430f3ca56115","triggerCount":0,"shared":[{"updatedAt":"2025-11-05T21:42:16.169Z","createdAt":"2025-11-05T21:42:16.169Z","role":"workflow:owner","workflowId":"FIxK0VneW1maD1Hi","projectId":"8nyfoRCh3nEYWaKJ"}],"tags":[]}