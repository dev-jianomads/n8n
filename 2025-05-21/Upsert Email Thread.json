{"createdAt":"2025-05-05T16:16:25.709Z","updatedAt":"2025-05-20T22:35:17.000Z","id":"OIOzWFLJLQPje4hX","name":"Upsert Email Thread","active":false,"nodes":[{"parameters":{"workflowInputs":{"values":[{"name":"threadId"},{"name":"newEmailBody"},{"name":"newEmailDateReceived"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[0,-40],"id":"ce1a9305-813c-4d2f-b058-ebf72d6b7324","name":"When Executed by Another Workflow"},{"parameters":{"operation":"get","tableId":"email_threads","filters":{"conditions":[{"keyName":"id","keyValue":"={{ $json.threadId }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[220,-40],"id":"8e46d568-a027-45dd-8047-821768f16ae7","name":"Get Thread","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"4EHtJhQUmG6XN1Mw","name":"Supabase account"}}},{"parameters":{"aggregate":"aggregateAllItemData","include":"specifiedFields","fieldsToInclude":"date_received,body","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1100,60],"id":"520cb2d4-5f4b-4ccf-a9cc-15f59495906e","name":"Aggregate"},{"parameters":{"sortFieldsUi":{"sortField":[{"fieldName":"date_received"}]},"options":{"disableDotNotation":false}},"type":"n8n-nodes-base.sort","typeVersion":1,"position":[880,60],"id":"323aeecf-c1ef-4f87-92bb-676375ea9981","name":"Sort"},{"parameters":{"workflowId":{"__rl":true,"value":"yhrDJhWiNqe7hj1L","mode":"list","cachedResultName":"ðŸ¤– Summarize Thread"},"workflowInputs":{"mappingMode":"defineBelow","value":{"thread":"={{ $json.data.concat([]) }}"},"matchingColumns":["thread"],"schema":[{"id":"thread","displayName":"thread","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1320,60],"id":"e388855c-2679-4b5f-a9e0-51b59c883d96","name":"Summarize Thread"},{"parameters":{"workflowId":{"__rl":true,"value":"yhrDJhWiNqe7hj1L","mode":"list","cachedResultName":"ðŸ¤– Summarize Thread"},"workflowInputs":{"mappingMode":"defineBelow","value":{"thread":"={{ \n[\n  {\n    \"body\": JSON.stringify($('When Executed by Another Workflow').item.json.newEmailBody),\n    \"date_received\": JSON.stringify($('When Executed by Another Workflow').item.json.newEmailDateReceived)\n  }\n] \n}}"},"matchingColumns":["thread"],"schema":[{"id":"thread","displayName":"thread","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1320,-140],"id":"53f1a6b4-848c-4053-890e-eb0716a2c132","name":"Summarize New Thread"},{"parameters":{"operation":"update","tableId":"email_threads","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('When Executed by Another Workflow').item.json.threadId }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"summary","fieldValue":"={{ $json.threadSummary }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1540,60],"id":"de60f220-7a6a-41d1-ab84-cb156f23fcd8","name":"Update Thread","credentials":{"supabaseApi":{"id":"4EHtJhQUmG6XN1Mw","name":"Supabase account"}}},{"parameters":{"tableId":"email_threads","fieldsUi":{"fieldValues":[{"fieldId":"id","fieldValue":"={{ $('When Executed by Another Workflow').item.json.threadId }}"},{"fieldId":"summary","fieldValue":"={{ $json.threadSummary }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1540,-140],"id":"a20ee804-2a79-45e4-80d1-00bdd3823576","name":"Create Thread","credentials":{"supabaseApi":{"id":"4EHtJhQUmG6XN1Mw","name":"Supabase account"}}},{"parameters":{"assignments":{"assignments":[{"id":"90d7d2c0-7e9b-49a5-a365-e7686d05ae2e","name":"threadId","value":"={{ $json.id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1760,-40],"id":"5102bf6e-e592-4b44-89dc-e19e9cb42054","name":"Set Response"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe81f354-eb00-4dd9-9577-5aa6731b0d4d","leftValue":"={{ $json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[440,-40],"id":"d4c4986e-59e0-4eb0-a593-da5f880dd1ab","name":"New?"},{"parameters":{"operation":"executeQuery","query":"SELECT body, date_received\nFROM emails\nWHERE thread_id = '{{ $('When Executed by Another Workflow').item.json.threadId }}'","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[660,60],"id":"2ba926aa-f96a-4d9f-9a1c-b2d4fd279fe8","name":"Get Email Bodies in Thread","credentials":{"postgres":{"id":"kI6uSN0fI2Vhpmlk","name":"Postgres account"}}}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Get Thread","type":"main","index":0}]]},"Get Thread":{"main":[[{"node":"New?","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Summarize Thread","type":"main","index":0}]]},"Sort":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"Summarize Thread":{"main":[[{"node":"Update Thread","type":"main","index":0}]]},"Summarize New Thread":{"main":[[{"node":"Create Thread","type":"main","index":0}]]},"Create Thread":{"main":[[{"node":"Set Response","type":"main","index":0}]]},"Update Thread":{"main":[[{"node":"Set Response","type":"main","index":0}]]},"New?":{"main":[[{"node":"Summarize New Thread","type":"main","index":0}],[{"node":"Get Email Bodies in Thread","type":"main","index":0}]]},"Get Email Bodies in Thread":{"main":[[{"node":"Sort","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"3DwlFyiaSzmnZPkS"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"0a0708c3-cea9-46ff-82e0-c75cfce97981","triggerCount":0,"tags":[]}