{"createdAt":"2025-07-30T17:51:39.781Z","updatedAt":"2025-08-04T22:34:26.457Z","id":"eE6NDJqa50WcfjeC","name":"[TG] Receive Messages","active":true,"isArchived":false,"nodes":[{"parameters":{"tableId":"telegram_messages","fieldsUi":{"fieldValues":[{"fieldId":"telegram_date","fieldValue":"={{ $('Telegram Trigger').item.json.message.date }}"},{"fieldId":"telegram_date_utc","fieldValue":"={{ $json.timetampUTC }}"},{"fieldId":"text","fieldValue":"={{ $('Telegram Trigger').item.json.message.text }}"},{"fieldId":"direction","fieldValue":"inbound"},{"fieldId":"sender_id","fieldValue":"={{ $('Telegram Trigger').item.json.message.from.id }}"},{"fieldId":"recipient_id","fieldValue":"={{ $json.tomoTelegramId }}"},{"fieldId":"raw_payload","fieldValue":"={{ $('Telegram Trigger').item.json }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[672,-592],"id":"ffe3d6cf-abf9-4c95-8444-98e1ddce5b3f","name":"Save Message","retryOnFail":true,"credentials":{"supabaseApi":{"id":"PwJN4yKDRZqivq2f","name":"Supabase account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"hcMQex513eYi8K2H","mode":"list","cachedResultName":"[TG] Get Conversation"},"workflowInputs":{"mappingMode":"defineBelow","value":{"telegramId":"={{ $json.telegram_id }}"},"matchingColumns":["telegramId"],"schema":[{"id":"telegramId","displayName":"telegramId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1120,-592],"id":"255732c7-edd8-4d58-aa45-8ca0b29dcf96","name":"Get Chat History"},{"parameters":{"model":"openai/gpt-4.1","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[0,272],"id":"ed071a4c-2656-4e3b-97c0-540a1d93be8d","name":"GPT 4.1","credentials":{"openRouterApi":{"id":"SeBKTiKFu0nP1GsL","name":"OpenRouter account"}},"disabled":true},{"parameters":{"description":"Use this tool to find available time slots in the user's calendar within a specified time range. Use this as the first step for any scheduling request to check for availability.\n\nParameters:\n\nlimit (integer): The maximum number of available time slots to return. If not specified, the default value is 10.\n\nfrom (string): The start of the time range to search, formatted as an ISO 8601 string (e.g., \"2025-07-21T09:00:00-05:00\"). This field is required.\n\nto (string): The end of the time range to search, formatted as an ISO 8601 string (e.g., \"2025-07-21T17:00:00-05:00\"). This field is required.","workflowId":{"__rl":true,"value":"JU7vXWGpAIcxWdP4","mode":"list","cachedResultName":"[TG] Find Time"},"workflowInputs":{"mappingMode":"defineBelow","value":{"limit":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('limit', ``, 'number') }}","from":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('from', ``, 'string') }}","to":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('to', ``, 'string') }}","userId":"={{ $('Get User').item.json.id }}","timeZone":"={{ $('Get Time Zone').first().json.timeZone }}"},"matchingColumns":[],"schema":[{"id":"userId","displayName":"userId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"limit","displayName":"limit","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"from","displayName":"from","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"to","displayName":"to","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"timeZone","displayName":"timeZone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[128,-144],"id":"6af86b1a-a173-43a9-a40d-80915dbf3668","name":"Find Time"},{"parameters":{"operation":"get","tableId":"users","filters":{"conditions":[{"keyName":"telegram_id","keyValue":"={{ $json.sender_id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[896,-592],"id":"2038acb3-29ef-4b3a-90ab-1e18bda30951","name":"Get User","credentials":{"supabaseApi":{"id":"PwJN4yKDRZqivq2f","name":"Supabase account"}}},{"parameters":{"description":"=Creates a new event in the user's calendar and generates a Google Meet link for it. Use this tool only after a specific time slot has been confirmed by the user, unless it's for an \"instant meeting\" request.\n\n**Parameters:**\n\n* **`title`** (`string`): The main title for the calendar event. This field is required.\n* **`description`** (`string`): A detailed description for the event. This is an optional field.\n* **`start`** (`string`): The start time for the event, formatted as an ISO 8601 string (e.g., \"2025-07-21T14:30:00-05:00\"). This field is required.\n* **`duration`** (`integer`): The duration of the event in minutes. If not specified, the default value is **60**.","workflowId":{"__rl":true,"value":"WhHqn9o96WxpWmjJ","mode":"list","cachedResultName":"[TG] Block Time with Meeting copy"},"workflowInputs":{"mappingMode":"defineBelow","value":{"description":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('description', ``, 'string') }}","start":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('start', ``, 'string') }}","duration":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('duration', ``, 'number') }}","title":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('title', ``, 'string') }}","summary":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('summary', ``, 'string') }}","userId":"={{ $('Get User').item.json.id }}","attendees":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('attendees', `Comma-separated list of emails of the attendees to the event. If there are no attendees, THIS SHOULD BE \"NONE\".`, 'string') }}"},"matchingColumns":[],"schema":[{"id":"description","displayName":"description","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"start","displayName":"start","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"duration","displayName":"duration","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"title","displayName":"title","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"userId","displayName":"userId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"summary","displayName":"summary","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"attendees","displayName":"attendees","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[256,-144],"id":"9d20afd1-7239-4bca-9c18-945b4ba2bf7d","name":"Block Time"},{"parameters":{"workflowId":{"__rl":true,"value":"DHcoEXUvqWWKxbZD","mode":"list","cachedResultName":"[TG] Get Time Zone"},"workflowInputs":{"mappingMode":"defineBelow","value":{"chatHistory":"={{ $('Get Chat History').first().json.chat_history }}","userId":"={{ $('Get User').item.json.id }}"},"matchingColumns":[],"schema":[{"id":"userId","displayName":"userId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"chatHistory","displayName":"chatHistory","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1344,-592],"id":"d1e7fe28-efc2-4de5-ae07-59dd0257c0b0","name":"Get Time Zone"},{"parameters":{"content":"## Old Prompt\n\nYou are an expert scheduling assistant. Your primary goal is to help the user find available time and book meetings on their calendar efficiently. You must adhere to the following rules and workflows.\n\n**Core Directives:**\n\n  * **Be Concise:** Your responses should be direct and to the point. Confirm actions and provide necessary information without unnecessary conversational filler.\n  * **Always Verify Availability First:** Before booking any time, you MUST first use the `find_time` tool to check for open slots.\n  * **Provide the Meeting Link:** After successfully booking an event, your final response to the user MUST include the Google Meet link.\n\n**Tool Usage:**\n\n1.  **`find_time`**\n\n      * **Purpose:** To check the user's calendar for available time blocks.\n      * **When to Use:** Use this as the first step for ALL scheduling requests.\n\n2.  **`block_time`**\n\n      * **Purpose:** To create an event in the user's Google Calendar.\n      * **When to Use:** Use this after confirming an available time slot.\n      * **Output Handling:** This tool returns the raw JSON response from the Google Calendar API. You must parse this response, extract the value of the **`hangoutLink`** property, and present this link clearly to the user.\n\n-----\n\n**Workflows**\n\nYou must identify the user's intent and follow one of two primary workflows:\n\n**Workflow 1: Standard Scheduling**\n\n  * **Trigger:** When the user wants to schedule a meeting for a future date/time or with specific people (e.g., \"book a meeting for tomorrow,\" \"find time with Jane next week\").\n  * **Steps:**\n    1.  Use `find_time` to identify all available slots that match the user's request.\n    2.  Present the available time slots to the user as a clear list of options.\n    3.  Once the user confirms their choice, use `block_time` to create the event.\n    4.  Respond with a confirmation and the extracted `hangoutLink`.\n\n**Workflow 2: Instant Meeting Link**\n\n  * **Trigger:** When the user asks for a meeting link **\"now,\" \"immediately,\"** for an **\"instant meeting,\"** or uses similar urgent language indicating a need for an immediate link.\n  * **Steps:**\n    1.  Use `find_time` to find the very next available 15-minute slot starting from the current time.\n    2.  **Immediately** use `block_time` to book that slot. **Do not ask the user for confirmation.** The goal is speed.\n    3.  Respond immediately with a confirmation that you've booked the next available slot and provide the extracted `hangoutLink`.\n\n      * **Example Response:** \"I've booked the next available 15 minutes for you. Here is your instant meeting link: [https://meet.google.com/xyz-abc-pqr](https://www.google.com/search?q=https://meet.google.com/xyz-abc-pqr)\"\n\n\n## Extra Notes:\nCurrent date and time: {{ $now.setZone($('Get Time Zone').first().json.timeZone).toISO() }}\nYou must convert all date times to ISO format, in the following time zone: {{ $('Get Time Zone').first().json.timeZone }}","height":1392,"width":672},"type":"n8n-nodes-base.stickyNote","position":[3200,-1936],"typeVersion":1,"id":"78984133-5ac5-4273-aa32-8d2cdb380a91","name":"Sticky Note1"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1","mode":"list","cachedResultName":"gpt-4.1"},"options":{"temperature":0.4}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[0,-144],"id":"e47682b9-b8e8-4f61-8fd8-11c89c2076b8","name":"4.1","credentials":{"openAiApi":{"id":"JNBPFneOXwzjzSKh","name":"OpenAI account"}}},{"parameters":{"jsCode":"/**\n * Filter a chat history to only the last 2 hours and convert dates to a given time zone.\n *\n * @param {Array<{date:string,message:string,role:string}>} history\n * @param {string} tz IANA time zone, e.g. \"America/New_York\"\n * @param {number} hoursBack (optional) default 2\n * @returns {Array<{date:string,message:string,role:string}>}\n */\nfunction filterAndConvert(history, tz, hoursBack = 2) {\n  const nowUtc = Date.now();\n  const cutoffUtc = nowUtc - hoursBack * 60 * 60 * 1000;\n\n  return history\n    .filter(item => new Date(item.date).getTime() >= cutoffUtc)\n    .map(item => ({\n      ...item,\n      date: toTZISO(item.date, tz),\n    }));\n}\n\n/**\n * Convert an ISO string to the same moment expressed in another time zone,\n * returned as \"YYYY-MM-DDTHH:mm:ss[±HH:MM]\" (no milliseconds).\n *\n * Uses only built-ins (Intl.DateTimeFormat).\n */\nfunction toTZISO(dateString, tz) {\n  const d = new Date(dateString);\n\n  // Grab all parts in the desired TZ\n  const parts = new Intl.DateTimeFormat('en-CA', {\n    timeZone: tz,\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n    second: '2-digit',\n    hour12: false,\n  }).formatToParts(d).reduce((acc, p) => {\n    acc[p.type] = p.value;\n    return acc;\n  }, {});\n\n  // Build local datetime string\n  const local = `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}`;\n\n  // Compute offset for that TZ at that instant\n  const offsetMinutes = getOffsetMinutes(d, tz);\n  const sign = offsetMinutes >= 0 ? '+' : '-';\n  const abs = Math.abs(offsetMinutes);\n  const hh = String(Math.floor(abs / 60)).padStart(2, '0');\n  const mm = String(abs % 60).padStart(2, '0');\n\n  return `${local}${sign}${hh}:${mm}`;\n}\n\n/**\n * Find the UTC offset (in minutes) of a date in a given TZ using Intl.\n */\nfunction getOffsetMinutes(date, tz) {\n  // Format the same date in UTC and in the TZ, compare epoch millis reconstructed\n  const fmt = (zone) => {\n    const parts = new Intl.DateTimeFormat('en-CA', {\n      timeZone: zone,\n      year: 'numeric',\n      month: '2-digit',\n      day: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n      second: '2-digit',\n      hour12: false,\n    }).formatToParts(date).reduce((acc, p) => {\n      acc[p.type] = p.value;\n      return acc;\n    }, {});\n    return Date.UTC(\n      Number(parts.year),\n      Number(parts.month) - 1,\n      Number(parts.day),\n      Number(parts.hour),\n      Number(parts.minute),\n      Number(parts.second)\n    );\n  };\n\n  const asUtcMillis = fmt('UTC');\n  const asTzMillis = fmt(tz);\n  return (asTzMillis - asUtcMillis) / (60 * 1000);\n}\n\n// --------- EXAMPLE n8n usage ---------\n// Assuming your incoming item has the array in items[0].json.history and tz in items[0].json.tz\n// Remove/adjust as needed.\nconst history = $('Get Chat History').first().json.chat_history;\nconst tz = $('Get Time Zone').first().json.timeZone || 'America/New_York';\n\nconst filtered = filterAndConvert(history, tz);\n\n// Return as n8n items\nreturn { json: { history: filtered } };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1568,-592],"id":"ebb1f2ce-2ec8-474e-9ead-ae8b922ed8d9","name":"Filter Chat History"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[480,64],"id":"9ba98c37-cab9-4d51-852b-9bad0774e56b","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"JNBPFneOXwzjzSKh","name":"OpenAI account"}}},{"parameters":{"description":"=Use this tool to find a person's email address when the user asks you to schedule a meeting with them.\n\nYou should trigger this tool whenever a user's request mentions a person by name (e.g., \"Book a call with Jane Doe\" or \"Find time with John Smith\"). The goal is to use their name to find their contact information so you can add them as an attendee to the calendar event.\n\nThe input should be the name, either partial (e.g. Jesus) or full (Jesus Martinez) of the contact you want to search.","workflowId":{"__rl":true,"value":"BmazSSTKstkRHFz9","mode":"list","cachedResultName":"[Signal] Search Contacts"},"workflowInputs":{"mappingMode":"defineBelow","value":{"query":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('query', ``, 'string') }}","userId":"={{ $('Get User').item.json.id }}"},"matchingColumns":[],"schema":[{"id":"userId","displayName":"userId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"query","displayName":"query","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[0,480],"id":"2d072376-17b5-45c5-a637-a2541fc907da","name":"Search Contacts","disabled":true},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"Use this tool to retrieve information about contacts, such as their email and name","topK":5,"options":{"metadata":{"metadataValues":[{"name":"user_id","value":"={{ $('Get User').item.json.id }}"}]}}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[384,-144],"id":"bf3f2133-9c3b-44d7-9edd-d8653516f334","name":"Search Contacts in Vector Store","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"updates":["message"],"additionalFields":{}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[0,-688],"id":"eea19cb9-99d9-4f81-871b-898130e317a8","name":"Telegram Trigger","webhookId":"b68a7420-3736-44ca-92d8-4520d499e3af","credentials":{"telegramApi":{"id":"ZhOp4IaJqCFjHFqK","name":"Ask Tomo (PROD)"}}},{"parameters":{"assignments":{"assignments":[{"id":"994defb3-f232-4a03-a0c8-248ff454b522","name":"timetampUTC","value":"={{ $json.message.date.toDateTime('s').toUTC().toISO() }}","type":"string"},{"id":"6148ee13-6558-4289-b01e-6c7faff5a027","name":"tomoTelegramId","value":"8354483273","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[224,-688],"id":"0dd4bce8-9819-45f8-98d2-659b1008e14b","name":"Parse Timestamp from Inbound Message and Set Tomo TG ID"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6dcf5122-b614-4414-805f-e9888284deea","leftValue":"={{ $('Telegram Trigger').item.json.message.text.startsWith(\"/start \") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[448,-688],"id":"90c0099a-2f44-47ff-98ee-d4095c13ad0d","name":"Start Command?"},{"parameters":{"assignments":{"assignments":[{"id":"fbfa8f50-e7ec-4a2e-b015-cb686b2be6b8","name":"telegramToken","value":"={{ $('Telegram Trigger').item.json.message.text.split(\" \")[1].trim() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[672,-784],"id":"34de3a03-e4a6-4211-8bac-65198a30e934","name":"Isolate Sign Up Token"},{"parameters":{"operation":"update","tableId":"users","matchType":"allFilters","filters":{"conditions":[{"keyName":"telegram_signup_token","condition":"eq","keyValue":"={{ $json.telegramToken }}"},{"keyName":"telegram_id","condition":"is","keyValue":"null"}]},"fieldsUi":{"fieldValues":[{"fieldId":"telegram_id","fieldValue":"={{ $('Telegram Trigger').item.json.message.chat.id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[896,-784],"id":"babe0050-fa63-463f-ac5e-5eee6545b655","name":"Update User with Telegram ID","credentials":{"supabaseApi":{"id":"PwJN4yKDRZqivq2f","name":"Supabase account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"B4R5PCXZUaCSSdbV","mode":"list","cachedResultName":"[TG] Send Telegram Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{"message":"=Hi{{ $json.display_name !== undefined && $json.display_name !== null? ' ' + $json.display_name: '' }}! I’m Tomo. Just message me here and I’ll help you schedule your meetings automatically.","telegramId":"={{ $('Telegram Trigger').item.json.message.chat.id.toString() }}","chatId":"={{ $('Telegram Trigger').item.json.message.chat.id.toString() }}"},"matchingColumns":[],"schema":[{"id":"telegramId","displayName":"telegramId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"chatId","displayName":"chatId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1120,-784],"id":"3a9efe22-8a58-443c-8874-ddc71996f462","name":"Send Welcome Message"},{"parameters":{"workflowId":{"__rl":true,"value":"B4R5PCXZUaCSSdbV","mode":"list","cachedResultName":"[TG] Send Telegram Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{"message":"={{ $json.response }}","telegramId":"={{ $('Save Message').item.json.sender_id }}","chatId":"={{ $('Telegram Trigger').item.json.message.chat.id.toString() }}"},"matchingColumns":[],"schema":[{"id":"telegramId","displayName":"telegramId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"chatId","displayName":"chatId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2016,-592],"id":"679b5709-096d-4dd7-b28b-4e9297cfab9d","name":"Send Telegram Message"},{"parameters":{"promptType":"define","text":"=# Chat History:\n{{ JSON.stringify($json.history) }}\n\n# User message\n{{ $('Save Message').item.json.text }}","options":{"systemMessage":"=You are an expert scheduling assistant. Your primary goal is to help the user find available time and book meetings on their calendar efficiently, both for themselves and with other contacts. You must adhere to the following rules and workflows.\n\n### Core Directives\n\n  * **Be Concise:** Your responses should be direct and to the point. Confirm actions and provide necessary information without unnecessary conversational filler.\n  * **Always Verify Availability First:** Before booking any time, you **MUST** use the `find_time` tool to get the user's current availability. **Never** assume availability based on chat history or previous checks. Each scheduling action requires a fresh availability check.\n  * **Always Favor Data from the Tools Over Chat History:** Only use chat history as conversational context; however, favor the information you get from the tools at your disposal over any data in previous messages in the conversation.\n  * **Provide Both Event Links:** This is a **HARD** requirement. After successfully booking an event, your final response to the user **MUST** include both the Google Meet link (`hangoutLink`) and the event's HTML link (`htmlLink`).\n  * **Do Not Make Assumptions:** If a user request is ambiguous, don’t guess. Ask clarifying questions to ensure full compliance with the user's intent.\n  * **Tentative Events Are Not Free Time:** When checking a user's calendar availability, do not assume that tentative events count as open time slots. Instead, flag these events and ask the user whether it's acceptable to treat them as available.\n\n\n### Tool Usage\n\n1.  **`search-contacts`**\n\n      * **Purpose:** To find contacts by name to invite them to an event.\n      * **When to Use:** When the user mentions a person's name in a scheduling request (e.g., \"Create a meeting with Jesus...\").\n      * **Output Handling:**\n          * **If no results are found:** Notify the user you could not find the contact and ask for their email address directly.\n          * **If multiple results are found:** Present a numbered list of the matching contacts and ask the user to choose one by its number.\n          * **If a chosen contact has no email:** Notify the user and ask them to provide the email address for that contact.\n          * **ONLY present results that are relevant to the search term, even if you have more than one available results. If none of the results returned by the tool are relevant enough, tell the user you didn't find any and ask them to manually specify the email of the contact they searched for.\n\n2.  **`find_time`**\n\n      * **Purpose:** To check the user's calendar for available time blocks.\n      * **When to Use:** After all attendees have been identified and confirmed, use this tool to find a suitable time.\n\n3.  **`block_time`**\n\n      * **Purpose:** To create an event in the user's Google Calendar and invite attendees.\n      * **When to Use:** After a specific time slot has been confirmed by the user.\n      * **Parameters:** This tool accepts event details and a comma-separated string of attendee emails.\n      * **Output Handling:** This tool returns the raw JSON response from the Google Calendar API. You must parse this response and extract the values of both the **`hangoutLink`** and the **`htmlLink`** properties.\n\n\n### Workflows\n\nYou must identify the user's intent and follow one of two primary workflows:\n\n**Workflow 1: Standard Scheduling (with or without attendees)**\n\n  * **Trigger:** When the user wants to schedule a meeting for a future date/time. This may or may not include other people.\n  * **Steps:**\n    1.  **Identify Attendees:** If the user mentions participants (e.g., \"...with Jesus and Lina\"), use the `search-contacts` tool for each name.\n    2.  **Confirm Attendees:** Resolve any ambiguities with the user based on the contact search results (ask for clarification on multiple matches or request missing emails). Collect all final attendee emails.\n    3.  **Find Availability:** Once all attendees are confirmed, use `find_time` to identify available slots that match the user's request.\n    4.  **Confirm Time:** Present the available time slots to the user as a clear list of options.\n    5.  **Create Event:** Once the user confirms their choice, use `block_time` with all event details, passing the collected emails as a comma-separated string to the `attendees` parameter.\n    6.  **Respond:** Provide a final confirmation to the user including both the `hangoutLink` and `htmlLink`.\n\n**Workflow 2: Instant Meeting Link (for the user only)**\n\n  * **Trigger:** When the user asks for a meeting link **\"now,\" \"immediately,\"** for an **\"instant meeting,\"** or uses similar urgent language. This workflow is for generating a link for the user alone.\n  * **Steps:**\n    1.  Use `find_time` to find the very next available 15-minute slot starting from the current time.\n    2.  **Immediately** use `block_time` to book that slot. **Do not ask the user for confirmation.**\n    3.  Respond immediately with a confirmation and provide both the `hangoutLink` and `htmlLink`.\n    <!-- end list -->\n      * **Example Response:** \"I've booked the next available 15 minutes for you.**Event Link:** [https://www.google.com/calendar/event?eid=](https://www.google.com/search?q=https://www.google.com/calendar/event%3Feid%3D)...\\\\n\\\\n**Google Meet Link:** [https://meet.google.com/xyz-abc-pqr](https://meet.google.com/xyz-abc-pqr)\"\n\n\n### Extra Notes:\nCurrent date and time: {{ $now.setZone($('Get Time Zone').first().json.timeZone).toISO() }}\nYou must convert all date times to ISO format, in the following time zone: {{ $('Get Time Zone').first().json.timeZone }}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2,"position":[96,-368],"id":"cbd171f6-f109-464e-add5-76322a84deda","name":"Telegram Agent","disabled":true},{"parameters":{"workflowId":{"__rl":true,"value":"bNcOIAwEzwJCt4uG","mode":"list","cachedResultName":"[TG] Scheduling Agent"},"workflowInputs":{"mappingMode":"defineBelow","value":{"chat_history":"={{ $json }}","user_message":"={{ $('Save Message').item.json.text }}","time_zone":"={{ $('Get Time Zone').first().json.timeZone }}","user":"={{ $('Get User').item.json }}"},"matchingColumns":[],"schema":[{"id":"chat_history","displayName":"chat_history","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object"},{"id":"time_zone","displayName":"time_zone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_message","displayName":"user_message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user","displayName":"user","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"mode":"each","options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1792,-592],"id":"6b605466-7482-416d-87be-929d480be5bc","name":"Send to Agent"}],"connections":{"Save Message":{"main":[[{"node":"Get User","type":"main","index":0}]]},"Get Chat History":{"main":[[{"node":"Get Time Zone","type":"main","index":0}]]},"GPT 4.1":{"ai_languageModel":[[]]},"Find Time":{"ai_tool":[[{"node":"Telegram Agent","type":"ai_tool","index":0}]]},"Get User":{"main":[[{"node":"Get Chat History","type":"main","index":0}]]},"Block Time":{"ai_tool":[[{"node":"Telegram Agent","type":"ai_tool","index":0}]]},"Get Time Zone":{"main":[[{"node":"Filter Chat History","type":"main","index":0}]]},"4.1":{"ai_languageModel":[[{"node":"Telegram Agent","type":"ai_languageModel","index":0}]]},"Filter Chat History":{"main":[[{"node":"Send to Agent","type":"main","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Search Contacts in Vector Store","type":"ai_embedding","index":0}]]},"Search Contacts":{"ai_tool":[[]]},"Search Contacts in Vector Store":{"ai_tool":[[{"node":"Telegram Agent","type":"ai_tool","index":0}]]},"Telegram Trigger":{"main":[[{"node":"Parse Timestamp from Inbound Message and Set Tomo TG ID","type":"main","index":0}]]},"Parse Timestamp from Inbound Message and Set Tomo TG ID":{"main":[[{"node":"Start Command?","type":"main","index":0}]]},"Start Command?":{"main":[[{"node":"Isolate Sign Up Token","type":"main","index":0}],[{"node":"Save Message","type":"main","index":0}]]},"Isolate Sign Up Token":{"main":[[{"node":"Update User with Telegram ID","type":"main","index":0}]]},"Update User with Telegram ID":{"main":[[{"node":"Send Welcome Message","type":"main","index":0}]]},"Telegram Agent":{"main":[[]]},"Send to Agent":{"main":[[{"node":"Send Telegram Message","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"63JMaA3ATIsJVc6Y"},"staticData":{"node:Run Every 30 Seconds":{"recurrenceRules":[]},"node:Run Every 15 Seconds":{"recurrenceRules":[]},"node:Run Every 5 Seconds":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Telegram Agent":[{"json":{"output":"How can I assist you with scheduling or calendar management today? Please let me know your request."}}],"Telegram Trigger":[{"json":{"update_id":85501917,"message":{"message_id":30,"from":{"id":1598386790,"is_bot":false,"first_name":"Jesús","last_name":"Martínez","username":"Jxx706","language_code":"en","is_premium":true},"chat":{"id":1598386790,"first_name":"Jesús","last_name":"Martínez","username":"Jxx706","type":"private"},"date":1754346810,"text":"Hi??"}}}]},"versionId":"24977d17-400c-4d85-9040-a11a257f1e2d","triggerCount":1,"tags":[]}