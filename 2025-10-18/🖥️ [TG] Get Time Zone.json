{"createdAt":"2025-07-30T17:52:59.488Z","updatedAt":"2025-10-14T19:05:17.762Z","id":"DHcoEXUvqWWKxbZD","name":"ðŸ–¥ï¸ [TG] Get Time Zone","active":false,"isArchived":false,"nodes":[{"parameters":{"workflowInputs":{"values":[{"name":"userId"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-1712,384],"id":"ba9be2d1-ee5a-4f97-b850-0cac30d371da","name":"When Executed by Another Workflow"},{"parameters":{"workflowId":{"__rl":true,"value":"OH9PUovRKlvZel5e","mode":"list","cachedResultUrl":"/workflow/OH9PUovRKlvZel5e","cachedResultName":"ðŸ–¥ï¸ [TG] Get Token for Telegram Integration"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('When Executed by Another Workflow').first().json.userId }}"},"matchingColumns":["user_id"],"schema":[{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[752,432],"id":"d26910ab-b781-41d7-bda9-b53bc361b94c","name":"Get Token"},{"parameters":{"url":"https://www.googleapis.com/calendar/v3/calendars/primary","sendQuery":true,"queryParameters":{"parameters":[{"name":"fields","value":"timeZone"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('Get Token').first().json.accessToken }}"},{"name":"Content-Type","value":"application/json"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[976,432],"id":"2cd47bc5-7e1c-4212-96ab-bec13a62b5e0","name":"Get Time Zone from Primary Calendar","retryOnFail":true,"alwaysOutputData":false,"onError":"continueErrorOutput"},{"parameters":{"jsonSchemaExample":"{\n  \"time_zone\": \"Europe/Paris\",\n  \"confidence\": 0.9,\n  \"present_like\": true,\n  \"reason\": \"Reason\"\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[160,80],"id":"4cc92dde-3cc4-4f48-a5cd-7dc50770ce35","name":"Structured Output Parser"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1","mode":"list","cachedResultName":"gpt-4.1"},"options":{"temperature":0}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[160,288],"id":"31c3b54e-a45d-469f-9d03-ac2ee22ca87b","name":"4.1","credentials":{"openAiApi":{"id":"JNBPFneOXwzjzSKh","name":"OpenAI account"}}},{"parameters":{"promptType":"define","text":"=Last messages (newest first): {{ JSON.stringify($('Aggregate').first().json.messages) }}","hasOutputParser":true,"options":{"systemMessage":"=You are a precise Time Zone Extractor. Decide the userâ€™s CURRENT time zone from the messages. Only accept explicit present statements (â€œIâ€™m inâ€¦â€, â€œhere inâ€¦â€, â€œjust landedâ€¦â€, â€œback inâ€¦â€). If the text is about planning, travel ideas, or future/past, return null.\n\nOutput JSON only:\n{\n  \"time_zone\": \"IANA or null\",\n  \"confidence\": 0.0-1.0,\n  \"present_like\": true|false,\n  \"reason\": \"short\"\n}\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[80,-144],"id":"bf84975f-b7c3-4e7a-9992-f4e973218c5f","name":"LLM Verifier"},{"parameters":{"operation":"executeQuery","query":"insert into dev.tz_presence_cache\n  (user_id, tz, source, strength, observed_at, committed_at, last_checked_at, evidence_message_id, evidence_text, updated_at)\nvalues\n  ($1::text, $2::text, 'chat_explicit', $3::numeric, now(), now(), now(), null, $4::text, now())\non conflict (user_id) do update set\n  tz = excluded.tz,\n  source = excluded.source,\n  strength = excluded.strength,\n  observed_at = excluded.observed_at,\n  committed_at = excluded.committed_at,\n  last_checked_at = excluded.last_checked_at,\n  evidence_message_id = excluded.evidence_message_id,\n  evidence_text = excluded.evidence_text,\n  updated_at = now();\n","options":{"queryReplacement":"={{ [$('When Executed by Another Workflow').item.json.userId, $json.output.time_zone, $json.output.confidence, $json.output.reason] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[752,16],"id":"028a77d4-bc77-419f-932e-5595544fd806","name":"Upsert (Chat)","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"time_zone\": \"{{ $('Confident Output?').item.json.output.time_zone }}\",\n  \"confidence\": {{ $('Confident Output?').item.json.output.confidence }},\n  \"source\": \"chat_explicit\",\n  \"reason\": \"{{ $('Confident Output?').item.json.output.reason }}\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[976,16],"id":"585892eb-3219-4e99-a0a1-e4a42ede11c1","name":"Set (Chat)"},{"parameters":{"operation":"executeQuery","query":"insert into dev.tz_presence_cache\n  (user_id, tz, source, strength, observed_at, committed_at, last_checked_at, updated_at)\nvalues\n  ($1::text, $2::text, 'calendar_setting', 0.6, now(), now(), now(), now())\non conflict (user_id) do update set\n  tz = excluded.tz,\n  source = excluded.source,\n  strength = excluded.strength,\n  observed_at = excluded.observed_at,\n  committed_at = excluded.committed_at,\n  last_checked_at = excluded.last_checked_at,\n  updated_at = now();","options":{"queryReplacement":"={{ [$('When Executed by Another Workflow').item.json.userId, $json.timeZone] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1200,336],"id":"6ea45297-e52b-4088-ba6f-eccdb681c265","name":"Upsert (Calendar Settings)","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"operation":"executeQuery","query":"SELECT dev.get_user_telegram_messages(\n  '{{ $(\"When Executed by Another Workflow\").item.json.userId }}',\n  8,\n  'inbound'\n) as messages;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1488,384],"id":"f24b605b-4df1-4411-8341-fe49b3b2f1a0","name":"Get Last N Messages","alwaysOutputData":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"messages","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-1040,272],"id":"f2babf99-a9ae-4b27-bffd-3165462fd486","name":"Aggregate"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"598c9c69-e75a-449e-a070-2df69dc89708","leftValue":"={{ $json.shouldCallLLM }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-592,272],"id":"b910df43-34db-4e0e-a8a0-81e77b224e40","name":"Should Call LLM?"},{"parameters":{"operation":"executeQuery","query":"select tz, strength, observed_at\nfrom dev.tz_presence_cache\nwhere user_id = '{{ $('When Executed by Another Workflow').item.json.userId }}';\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-368,416],"id":"c59fc647-aa9c-458a-8b09-288a215ea3cd","name":"Get Cache","alwaysOutputData":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c3f6ba0e-a006-42c1-b766-70b5aba9026a","leftValue":"={{ $json.isNotEmpty() && $json.strength >= 0.6 && (Math.abs($json.observed_at.toDateTime().diffToNow('hours'))) <= 24 }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-144,416],"id":"9721991f-d820-4492-a3b9-c946e6e4d080","name":"Use Cache?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d59c2e2-5e56-4fab-a8df-791763632dfb","leftValue":"={{ $json.isNotEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1264,384],"id":"f18f1b57-9cf0-4c49-84a7-e2b91ad45748","name":"Messages?"},{"parameters":{"operation":"executeQuery","query":"select tz, strength, observed_at\nfrom dev.tz_presence_cache\nwhere user_id = '{{ $('When Executed by Another Workflow').item.json.userId }}';\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-368,656],"id":"ea56beeb-b95a-4724-ab6b-299afe74be55","name":"Get Cache [No Messages]","alwaysOutputData":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c3f6ba0e-a006-42c1-b766-70b5aba9026a","leftValue":"={{ $json.isNotEmpty() && $json.strength >= 0.6 && (Math.abs($json.observed_at.toDateTime().diffToNow('hours'))) <= 24 }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-144,656],"id":"da5f8815-0ba3-4a4a-8a48-9980675108be","name":"Use Cache? [No Messages]"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"time_zone\": \"{{ $json.tz }}\",\n  \"confidence\": {{ $json.strength }},\n  \"source\": \"cache\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[192,464],"id":"c0e1da84-7586-4167-97ca-72424152d657","name":"Set (Cache)"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"043ca09e-4f59-4993-ad99-c2252254e300","leftValue":"={{ $json.output.present_like && $json.output.time_zone && $json.output.confidence >= 0.75}}","rightValue":0,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[528,64],"id":"054fa8f7-cb5d-4042-b12b-7e1068a2db43","name":"Confident Output?"},{"parameters":{"jsCode":"// PresenceTrigger\nconst row = $input.first().json.messages[0] || {};\nconst txt = (row.text || \"\").toLowerCase();\n\nconst triggers = [\n  /\\b(i'?m|i am)\\s+in\\s+[a-z][a-z\\s\\-]{2,}/,\n  /\\b(here in|based in|staying in|living in)\\s+[a-z][a-z\\s\\-]{2,}/,\n  /\\b(just landed in|landed in|arrived in|back in)\\s+[a-z][a-z\\s\\-]{2,}/,\n  /\\b(now in)\\s+[a-z][a-z\\s\\-]{2,}/\n];\nconst futures = [/\\b(heading to|going to|will be in|tomorrow|next week)\\b/];\n\nconst shouldCallLLM = triggers.some(r => r.test(txt)) && !futures.some(r => r.test(txt));\nreturn [{ shouldCallLLM, lastMessageId: row.id, lastMessageText: row.text, lastTs: row.ts }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-816,272],"id":"9ee1ba2c-6e21-4597-9830-b62eea01fbf8","name":"Validate LLM Need"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"time_zone\": \"{{$('Get Time Zone from Primary Calendar').item.json.timeZone}}\",\n  \"confidence\": 0.6,\n  \"source\": \"calendar_setting\",\n  \"reason\": \"Falling back to Google Calendar account setting.\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1424,336],"id":"21c25881-c4c1-4ffa-9040-d7b99cfab6a8","name":"Set (Calendar Settings)"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"time_zone\": \"Etc/UTC\",\n  \"confidence\": 0.1,\n  \"source\": \"default\",\n  \"reason\": \"All other methods failed. Defaulting to UTC\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1200,528],"id":"342b0474-1f68-4ad5-a5f5-7fa10ce6ccd4","name":"Set (UTC Default)"}],"connections":{"Get Token":{"main":[[{"node":"Get Time Zone from Primary Calendar","type":"main","index":0}]]},"When Executed by Another Workflow":{"main":[[{"node":"Get Last N Messages","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"LLM Verifier","type":"ai_outputParser","index":0}]]},"Get Time Zone from Primary Calendar":{"main":[[{"node":"Upsert (Calendar Settings)","type":"main","index":0}],[{"node":"Set (UTC Default)","type":"main","index":0}]]},"4.1":{"ai_languageModel":[[{"node":"LLM Verifier","type":"ai_languageModel","index":0},{"node":"Structured Output Parser","type":"ai_languageModel","index":0}]]},"LLM Verifier":{"main":[[{"node":"Confident Output?","type":"main","index":0}]]},"Upsert (Chat)":{"main":[[{"node":"Set (Chat)","type":"main","index":0}]]},"Upsert (Calendar Settings)":{"main":[[{"node":"Set (Calendar Settings)","type":"main","index":0}]]},"Get Last N Messages":{"main":[[{"node":"Messages?","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Validate LLM Need","type":"main","index":0}]]},"Should Call LLM?":{"main":[[{"node":"LLM Verifier","type":"main","index":0}],[{"node":"Get Cache","type":"main","index":0}]]},"Get Cache":{"main":[[{"node":"Use Cache?","type":"main","index":0}]]},"Messages?":{"main":[[{"node":"Aggregate","type":"main","index":0}],[{"node":"Get Cache [No Messages]","type":"main","index":0}]]},"Get Cache [No Messages]":{"main":[[{"node":"Use Cache? [No Messages]","type":"main","index":0}]]},"Use Cache? [No Messages]":{"main":[[{"node":"Set (Cache)","type":"main","index":0}],[{"node":"Get Token","type":"main","index":0}]]},"Use Cache?":{"main":[[{"node":"Set (Cache)","type":"main","index":0}],[{"node":"LLM Verifier","type":"main","index":0}]]},"Confident Output?":{"main":[[{"node":"Upsert (Chat)","type":"main","index":0}],[{"node":"Get Token","type":"main","index":0}]]},"Validate LLM Need":{"main":[[{"node":"Should Call LLM?","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"LLM Verifier":[{"json":{"output":{"time_zone":"Europe/Paris","confidence":1,"present_like":true,"reason":"User explicitly stated 'I'm actually in France' and 'just landed in Paris' in the most recent messages."}}}],"When Executed by Another Workflow":[{"json":{"userId":"t07ZDdtiVLduDE3RuRHGKowoSd0f"}}]},"versionId":"7d469cf3-60f0-4c78-ad19-a8423265030f","triggerCount":0,"shared":[{"createdAt":"2025-07-30T17:52:59.488Z","updatedAt":"2025-07-30T17:52:59.488Z","role":"workflow:owner","workflowId":"DHcoEXUvqWWKxbZD","projectId":"8nyfoRCh3nEYWaKJ"}],"tags":[]}