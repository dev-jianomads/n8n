{"updatedAt":"2025-10-28T20:06:22.855Z","createdAt":"2025-10-14T22:21:22.998Z","id":"NOs8uISgMND4NjBf","name":"[WA] On New Message","active":false,"isArchived":false,"nodes":[{"parameters":{"updates":["messages"],"options":{}},"type":"n8n-nodes-base.whatsAppTrigger","typeVersion":1,"position":[-48,-32],"id":"f15e8ff2-6e90-4a5b-8fb1-eeb74b115934","name":"WhatsApp Trigger","webhookId":"9c276208-4753-4cad-9db7-3f9aea7b200c","credentials":{"whatsAppTriggerApi":{"id":"E6zgzaiMKkzeqacR","name":"WhatsApp OAuth account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT dev.get_whatsapp_user('{{ $json.contacts[0].wa_id }}');","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[400,-32],"id":"895df53b-f14c-475c-8386-90d999e54037","name":"Find User by WhatsApp ID","credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4e2daa52-5c2f-46ab-a36d-9801b6a117dd","leftValue":"={{ $json.get_whatsapp_user }}","rightValue":"","operator":{"type":"object","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[624,-32],"id":"f7d4615b-fa66-4f20-b8d6-e4a3ae21e639","name":"Found?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b2971a46-fdc6-41c9-bceb-6573a287f960","leftValue":"={{ $json.keys().includes(\"statuses\") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[176,-32],"id":"b7e98794-fd5d-4553-b52e-307e6c4dd9e9","name":"Ignore?"},{"parameters":{"operation":"send","phoneNumberId":"749915891538765","recipientPhoneNumber":"=+{{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}","textBody":"=Hi! Please sign up here: https://cal.hellotomo.ai/welcome","additionalFields":{}},"type":"n8n-nodes-base.whatsApp","typeVersion":1.1,"position":[848,64],"id":"a2b6b7ea-db35-4e08-98e6-032ef62bc0e3","name":"Send Sign Up URL","webhookId":"6cdfa395-548b-477e-b41d-ae5117358a8a","credentials":{"whatsAppApi":{"id":"hn7HYT0djID7QTau","name":"WhatsApp account"}}},{"parameters":{"tableId":"whatsapp_messages","fieldsUi":{"fieldValues":[{"fieldId":"whatsapp_date","fieldValue":"={{ $('WhatsApp Trigger').item.json.messages[0].timestamp }}"},{"fieldId":"whatsapp_date_utc","fieldValue":"={{ $json.timetampUTC }}"},{"fieldId":"text","fieldValue":"={{ $('WhatsApp Trigger').item.json.messages[0].text.body }}"},{"fieldId":"direction","fieldValue":"inbound"},{"fieldId":"sender_id","fieldValue":"={{ $('WhatsApp Trigger').item.json.messages[0].from }}"},{"fieldId":"recipient_id","fieldValue":"={{ $json.tomoWhatsAppId }}"},{"fieldId":"raw_payload","fieldValue":"={{ $('WhatsApp Trigger').item.json }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1744,-32],"id":"b08af307-e255-4106-8b76-5f450e89ad3c","name":"Save Message","retryOnFail":true,"credentials":{"supabaseApi":{"id":"PwJN4yKDRZqivq2f","name":"Supabase account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"503EbTmyLBMYLGzq","mode":"list","cachedResultUrl":"/workflow/503EbTmyLBMYLGzq","cachedResultName":"[WA] Get Cached WhatsApp Conversation"},"workflowInputs":{"mappingMode":"defineBelow","value":{"whatsAppId":"={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}"},"matchingColumns":["telegramId"],"schema":[{"id":"whatsAppId","displayName":"whatsAppId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1296,-224],"id":"e1b63ab1-0fb2-4614-9994-ceba85fc3853","name":"Get Chat History"},{"parameters":{"jsCode":"/**\n * Filter a chat history to only the last 2 hours and convert dates to a given time zone.\n *\n * @param {Array<{date:string,message:string,role:string}>} history\n * @param {string} tz IANA time zone, e.g. \"America/New_York\"\n * @param {number} hoursBack (optional) default 2\n * @returns {Array<{date:string,message:string,role:string}>}\n */\nfunction filterAndConvert(history, tz, hoursBack = 2) {\n  const nowUtc = Date.now();\n  const cutoffUtc = nowUtc - hoursBack * 60 * 60 * 1000;\n\n  return history\n    .filter(item => new Date(item.date).getTime() >= cutoffUtc)\n    .map(item => ({\n      ...item,\n      date: toTZISO(item.date, tz),\n    }));\n}\n\n/**\n * Convert an ISO string to the same moment expressed in another time zone,\n * returned as \"YYYY-MM-DDTHH:mm:ss[Â±HH:MM]\" (no milliseconds).\n *\n * Uses only built-ins (Intl.DateTimeFormat).\n */\nfunction toTZISO(dateString, tz) {\n  const d = new Date(dateString);\n\n  // Grab all parts in the desired TZ\n  const parts = new Intl.DateTimeFormat('en-CA', {\n    timeZone: tz,\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n    second: '2-digit',\n    hour12: false,\n  }).formatToParts(d).reduce((acc, p) => {\n    acc[p.type] = p.value;\n    return acc;\n  }, {});\n\n  // Build local datetime string\n  const local = `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}`;\n\n  // Compute offset for that TZ at that instant\n  const offsetMinutes = getOffsetMinutes(d, tz);\n  const sign = offsetMinutes >= 0 ? '+' : '-';\n  const abs = Math.abs(offsetMinutes);\n  const hh = String(Math.floor(abs / 60)).padStart(2, '0');\n  const mm = String(abs % 60).padStart(2, '0');\n\n  return `${local}${sign}${hh}:${mm}`;\n}\n\n/**\n * Find the UTC offset (in minutes) of a date in a given TZ using Intl.\n */\nfunction getOffsetMinutes(date, tz) {\n  // Format the same date in UTC and in the TZ, compare epoch millis reconstructed\n  const fmt = (zone) => {\n    const parts = new Intl.DateTimeFormat('en-CA', {\n      timeZone: zone,\n      year: 'numeric',\n      month: '2-digit',\n      day: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n      second: '2-digit',\n      hour12: false,\n    }).formatToParts(date).reduce((acc, p) => {\n      acc[p.type] = p.value;\n      return acc;\n    }, {});\n    return Date.UTC(\n      Number(parts.year),\n      Number(parts.month) - 1,\n      Number(parts.day),\n      Number(parts.hour),\n      Number(parts.minute),\n      Number(parts.second)\n    );\n  };\n\n  const asUtcMillis = fmt('UTC');\n  const asTzMillis = fmt(tz);\n  return (asTzMillis - asUtcMillis) / (60 * 1000);\n}\n\nconst history = $('Get Chat History').first().json.chat_history;\nconst tz = $('Get Time Zone').first().json.timeZone || 'America/New_York';\n\nconst filtered = filterAndConvert(history, tz);\n\n// Return as n8n items\nreturn { json: { history: filtered } };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1744,-224],"id":"e97c063b-a2e9-4d61-bd8d-8d65ef3c8f8d","name":"Filter Chat History"},{"parameters":{"workflowId":{"__rl":true,"value":"bNcOIAwEzwJCt4uG","mode":"list","cachedResultUrl":"/workflow/bNcOIAwEzwJCt4uG","cachedResultName":"[TG] Scheduling Agent"},"workflowInputs":{"mappingMode":"defineBelow","value":{"chat_history":"={{ $json }}","user_message":"={{ $('WhatsApp Trigger').item.json.messages[0].text.body }}","time_zone":"={{ $('Get Time Zone').first().json.time_zone }}","user":"={{ $('Find User by WhatsApp ID').item.json.get_whatsapp_user }}"},"matchingColumns":[],"schema":[{"id":"chat_history","displayName":"chat_history","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object"},{"id":"time_zone","displayName":"time_zone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_message","displayName":"user_message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user","displayName":"user","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object","removed":false},{"id":"context","displayName":"context","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"telegram_id","displayName":"telegram_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":true},"mode":"each","options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2192,-128],"id":"e9e4e56b-260c-4a6c-bf5f-afa53b8f1642","name":"Send to Agent"},{"parameters":{"mode":"chooseBranch"},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1968,-128],"id":"140081f1-0bb6-4f9a-bd0c-9d5cf920e819","name":"Merge"},{"parameters":{"workflowId":{"__rl":true,"value":"xjeiN435FRXPWLFI","mode":"list","cachedResultUrl":"/workflow/xjeiN435FRXPWLFI","cachedResultName":"[WA] Refresh Cached WhatsApp Chat History and Time Zone"},"workflowInputs":{"mappingMode":"defineBelow","value":{"whatsAppId":"={{ $('WhatsApp Trigger').item.json.messages[0].from }}","userId":"={{ $('Find User by WhatsApp ID').item.json.get_whatsapp_user.user_id }}"},"matchingColumns":[],"schema":[{"id":"whatsAppId","displayName":"whatsAppId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"userId","displayName":"userId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2640,-128],"id":"c9bfae2d-a8a8-4bfa-95ea-482712467e01","name":"Refresh Caches"},{"parameters":{"workflowId":{"__rl":true,"value":"d7PDXuxH12xsDziS","mode":"list","cachedResultUrl":"/workflow/d7PDXuxH12xsDziS","cachedResultName":"[WA] Get WhatsApp Time Zone [TO-DO]"},"workflowInputs":{"mappingMode":"defineBelow","value":{"userId":"={{ $('Find User by WhatsApp ID').item.json.get_whatsapp_user.user_id }}"},"matchingColumns":["userId"],"schema":[{"id":"userId","displayName":"userId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1520,-224],"id":"4aea8ade-2612-4094-ab7a-322f5be32e69","name":"Get Time Zone"},{"parameters":{"assignments":{"assignments":[{"id":"994defb3-f232-4a03-a0c8-248ff454b522","name":"timetampUTC","value":"={{ $('WhatsApp Trigger').item.json.messages[0].timestamp.toDateTime('s').toUTC().toISO() }}","type":"string"},{"id":"59998172-9c6b-483c-aa57-c2a4911ac059","name":"tomoWhatsAppId","value":"15551366684","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[848,-128],"id":"fd18cdf7-662a-44fd-a8c3-d577a4047957","name":"Parse Timestamp from Inbound WhatsApp message"},{"parameters":{"workflowId":{"__rl":true,"value":"eLqQcZieFefTtfBC","mode":"list","cachedResultUrl":"/workflow/eLqQcZieFefTtfBC","cachedResultName":"[WA] Get Cached User by WhatsApp ID"},"workflowInputs":{"mappingMode":"defineBelow","value":{"whatsAppId":"={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}"},"matchingColumns":["message_from_id"],"schema":[{"id":"whatsAppId","displayName":"whatsAppId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1072,-224],"name":"Get Cached User by WhatsApp ID","id":"47db3aa5-d25d-4546-9d5c-b3c1754682d7"},{"parameters":{"workflowId":{"__rl":true,"value":"apdLhNBw1CpdN88e","mode":"list","cachedResultUrl":"/workflow/apdLhNBw1CpdN88e","cachedResultName":"[WA] Send WhatsApp Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{"message":"={{ $json.response }}","toolActivity":"={{ $json.toolActivity ?? [] }}","whatsAppId":"={{ $('WhatsApp Trigger').item.json.messages[0].from }}"},"matchingColumns":[],"schema":[{"id":"whatsAppId","displayName":"whatsAppId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"toolActivity","displayName":"toolActivity","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2416,-128],"id":"51c20e90-6195-492a-ad08-c6cee02c49f1","name":"Send WhatsApp Message","onError":"continueRegularOutput"}],"connections":{"WhatsApp Trigger":{"main":[[{"node":"Ignore?","type":"main","index":0}]]},"Find User by WhatsApp ID":{"main":[[{"node":"Found?","type":"main","index":0}]]},"Found?":{"main":[[{"node":"Parse Timestamp from Inbound WhatsApp message","type":"main","index":0}],[{"node":"Send Sign Up URL","type":"main","index":0}]]},"Ignore?":{"main":[[],[{"node":"Find User by WhatsApp ID","type":"main","index":0}]]},"Send Sign Up URL":{"main":[[]]},"Save Message":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Get Chat History":{"main":[[{"node":"Get Time Zone","type":"main","index":0}]]},"Filter Chat History":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Send to Agent":{"main":[[{"node":"Send WhatsApp Message","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Send to Agent","type":"main","index":0}]]},"Get Time Zone":{"main":[[{"node":"Filter Chat History","type":"main","index":0}]]},"Parse Timestamp from Inbound WhatsApp message":{"main":[[{"node":"Get Cached User by WhatsApp ID","type":"main","index":0},{"node":"Save Message","type":"main","index":0}]]},"Get Cached User by WhatsApp ID":{"main":[[{"node":"Get Chat History","type":"main","index":0}]]},"Send WhatsApp Message":{"main":[[{"node":"Refresh Caches","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false,"errorWorkflow":"63JMaA3ATIsJVc6Y"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"WhatsApp Trigger":[{"json":{"messaging_product":"whatsapp","metadata":{"display_phone_number":"15551366684","phone_number_id":"749915891538765"},"contacts":[{"profile":{"name":"AM III ðŸ‘‘"},"wa_id":"573195884149"}],"messages":[{"from":"573195884149","id":"wamid.HBgMNTczMTk1ODg0MTQ5FQIAEhggQUM3QzU4MDI0NjU2MDYwOEE0RkNFNDBFMEQwMEI2MDUA","timestamp":"1761065958","text":{"body":"Hello?"},"type":"text"}],"field":"messages"}}]},"versionId":"42ff3f3e-ff8d-4325-bac0-82f9923c61a7","triggerCount":1,"shared":[{"updatedAt":"2025-10-14T22:21:22.998Z","createdAt":"2025-10-14T22:21:22.998Z","role":"workflow:owner","workflowId":"NOs8uISgMND4NjBf","projectId":"8nyfoRCh3nEYWaKJ"}],"tags":[]}