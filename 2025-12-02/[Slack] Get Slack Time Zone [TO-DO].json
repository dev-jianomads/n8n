{"updatedAt":"2025-11-25T21:17:38.471Z","createdAt":"2025-11-22T21:52:03.830Z","id":"NSHJ7N5HuSWzl9c0","name":"[Slack] Get Slack Time Zone [TO-DO]","active":false,"isArchived":false,"nodes":[{"parameters":{"workflowInputs":{"values":[{"name":"userId"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-2720,512],"id":"57731cc6-c932-4c02-9912-6e1656c0f892","name":"When Executed by Another Workflow"},{"parameters":{"workflowId":{"__rl":true,"value":"pE2lsrstziYiLtF8","mode":"list","cachedResultUrl":"/workflow/pE2lsrstziYiLtF8","cachedResultName":"[TG] Get Token for TG Integration"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('When Executed by Another Workflow').first().json.userId }}"},"matchingColumns":["user_id"],"schema":[{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-880,560],"id":"d5c42c77-d8be-4130-ae52-9b26f535a2a6","name":"Get Token"},{"parameters":{"url":"https://www.googleapis.com/calendar/v3/calendars/primary","sendQuery":true,"queryParameters":{"parameters":[{"name":"fields","value":"timeZone"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('Get Token').first().json.accessToken }}"},{"name":"Content-Type","value":"application/json"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-656,560],"id":"d9a09ace-7218-4921-bb6a-5d4d84934b82","name":"Get Time Zone from Primary Calendar","retryOnFail":true,"alwaysOutputData":false,"onError":"continueErrorOutput"},{"parameters":{"jsonSchemaExample":"{\n  \"time_zone\": \"Europe/Paris\",\n  \"confidence\": 0.9,\n  \"present_like\": true,\n  \"reason\": \"Reason\"\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-1472,208],"id":"4e38b434-ca4e-4e70-9a5f-9219f6c238df","name":"Structured Output Parser"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1","mode":"list","cachedResultName":"gpt-4.1"},"options":{"temperature":0}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1392,416],"id":"f87ccc05-98a6-490c-9d46-a38af1145783","name":"4.1","credentials":{"openAiApi":{"id":"JNBPFneOXwzjzSKh","name":"OpenAI account"}}},{"parameters":{"promptType":"define","text":"=Last messages (newest first): {{ JSON.stringify($('Messages?').first().json.messages) }}","hasOutputParser":true,"options":{"systemMessage":"=**You are a Time Zone Extractor.** Determine the user's CURRENT time zone from chat history.\n\n  **Current Date**: {{ $now.toUTC().format('yyyy-MM-dd HH:mm:ss') }}\n\n**Valid Location Signals:**\n\n**Strong (high confidence):**\n- Explicit present: \"I'm in [city]\", \"here in [city]\", \"just landed in [city]\", \"currently in [city]\"\n- Direct timezone mention: \"my time zone is [zone]\"\n- Scheduled events for TODAY: \"meeting on Oct 30 in [city]\" when current date is Oct 30\n\n**Weak (only valid with prior location context):**\n- Implicit present: \"it's hot here\", \"at this coffee shop\", \"my local time is...\"\n\n**Always Reject:**\n- Future plans: \"going to [city]\", \"traveling to [city] next week\", \"will be in [city]\"\n- Past references: \"I was in [city]\", \"visited [city]\"\n- Planning/hypotheticals: \"let's meet in [city]\", \"want to go to [city]\"\n\n**Reasoning Guidelines:**\n- **Recency matters**: More recent location statements override older ones\n- **Temporal logic**: If user mentioned \"meeting tomorrow in Tokyo\" and tomorrow is now today, they're in Tokyo\n- **Confidence**: Explicit recent statements = high confidence. Older or inferred = lower confidence. Very old or ambiguous = null\n- **Context helps**: Use surrounding messages to disambiguate (e.g., local landmarks, weather mentions)\n\n**Output JSON only:**\n```json\n{\n  \"time_zone\": \"America/New_York or null\",\n  \"confidence\": 0.0-1.0,\n  \"reason\": \"Brief explanation\"\n}\n```"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[-1568,-16],"id":"e91ffe5d-a8bc-456b-9b7d-57c29b9839e5","name":"LLM Verifier"},{"parameters":{"operation":"executeQuery","query":"insert into public.tz_presence_cache\n  (user_id, tz, source, strength, observed_at, committed_at, last_checked_at, evidence_message_id, evidence_text, updated_at)\nvalues\n  ($1::text, $2::text, 'chat_explicit', $3::numeric, now(), now(), now(), null, $4::text, now())\non conflict (user_id) do update set\n  tz = excluded.tz,\n  source = excluded.source,\n  strength = excluded.strength,\n  observed_at = excluded.observed_at,\n  committed_at = excluded.committed_at,\n  last_checked_at = excluded.last_checked_at,\n  evidence_message_id = excluded.evidence_message_id,\n  evidence_text = excluded.evidence_text,\n  updated_at = now();\n","options":{"queryReplacement":"={{ [$('When Executed by Another Workflow').item.json.userId, $json.output.time_zone, $json.output.confidence, $json.output.reason] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-880,144],"id":"71d83298-9033-4e6f-803d-70ccedfcda87","name":"Upsert (Chat)","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"time_zone\": \"{{ $('Confident Output?').item.json.output.time_zone }}\",\n  \"confidence\": {{ $('Confident Output?').item.json.output.confidence }},\n  \"source\": \"chat_explicit\",\n  \"reason\": \"{{ $('Confident Output?').item.json.output.reason }}\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-656,144],"id":"4e31229f-5b6b-4c1e-9307-e2b61900d5ad","name":"Set (Chat)"},{"parameters":{"operation":"executeQuery","query":"insert into public.tz_presence_cache\n  (user_id, tz, source, strength, observed_at, committed_at, last_checked_at, updated_at)\nvalues\n  ($1::text, $2::text, 'calendar_setting', 0.6, now(), now(), now(), now())\non conflict (user_id) do update set\n  tz = excluded.tz,\n  source = excluded.source,\n  strength = excluded.strength,\n  observed_at = excluded.observed_at,\n  committed_at = excluded.committed_at,\n  last_checked_at = excluded.last_checked_at,\n  updated_at = now();","options":{"queryReplacement":"={{ [$('When Executed by Another Workflow').item.json.userId, $json.timeZone] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-432,464],"id":"c7c8bfe7-63bb-4899-b558-6342486d8a3c","name":"Upsert (Calendar Settings)","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_user_slack_messages('{{ $(\"When Executed by Another Workflow\").item.json.userId }}', 10, 'inbound');","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2496,512],"id":"2307d139-42be-4413-8bcb-b1ee065ab69f","name":"Get Last N Messages","alwaysOutputData":true,"retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"operation":"executeQuery","query":"select tz, strength, observed_at\nfrom public.tz_presence_cache\nwhere user_id = '{{ $('When Executed by Another Workflow').item.json.userId }}';\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2048,392],"id":"6b004abc-2589-4e8f-99ba-cc8b91ae9932","name":"Get Cache","alwaysOutputData":true,"retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c3f6ba0e-a006-42c1-b766-70b5aba9026a","leftValue":"={{ $json.isNotEmpty() && $json.strength >= 0.6 && (Math.abs($json.observed_at.toDateTime().diffToNow('hours'))) <= 24 }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1824,392],"id":"c68c28c3-fac2-419d-8c37-021894a69fd3","name":"Use Cache?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d59c2e2-5e56-4fab-a8df-791763632dfb","leftValue":"={{ $json.isNotEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2272,512],"id":"4e63a74b-91a7-450b-8057-868d4dfb668f","name":"Messages?"},{"parameters":{"operation":"executeQuery","query":"select tz, strength, observed_at\nfrom public.tz_presence_cache\nwhere user_id = '{{ $('When Executed by Another Workflow').item.json.userId }}';\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2048,784],"id":"176cbf98-c847-4467-a333-f8c36eb28fcf","name":"Get Cache [No Messages]","alwaysOutputData":true,"retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c3f6ba0e-a006-42c1-b766-70b5aba9026a","leftValue":"={{ $json.isNotEmpty() && $json.strength >= 0.6 && (Math.abs($json.observed_at.toDateTime().diffToNow('hours'))) <= 24 }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1824,784],"id":"7b7c5e27-2d3c-4dc6-bb6a-20fbb6fadb92","name":"Use Cache? [No Messages]"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"time_zone\": \"{{ $json.tz }}\",\n  \"confidence\": {{ $json.strength }},\n  \"source\": \"cache\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1456,592],"id":"49e0f268-6e0d-414c-b461-af3ec5fb4435","name":"Set (Cache)"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"043ca09e-4f59-4993-ad99-c2252254e300","leftValue":"={{ $json.output.present_like && $json.output.time_zone && $json.output.confidence >= 0.75}}","rightValue":0,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1104,192],"id":"dba91368-8f7e-44e5-a951-75b44229183d","name":"Confident Output?"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"time_zone\": \"{{$('Get Time Zone from Primary Calendar').item.json.timeZone}}\",\n  \"confidence\": 0.6,\n  \"source\": \"calendar_setting\",\n  \"reason\": \"Falling back to Google Calendar account setting.\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-208,464],"id":"c28fb576-6211-440d-9e28-6af5178fb17e","name":"Set (Calendar Settings)"},{"parameters":{"model":"anthropic/claude-sonnet-4.5","options":{"temperature":0.5}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-1600,208],"id":"44eed15d-22ee-49e2-aa59-c67085d8c012","name":"Claude 4.5","credentials":{"openRouterApi":{"id":"SeBKTiKFu0nP1GsL","name":"OpenRouter account"}}},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"time_zone\": \"Etc/UTC\",\n  \"confidence\": 0.1,\n  \"source\": \"default\",\n  \"reason\": \"All other methods failed. Defaulting to UTC\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-432,656],"id":"e9d48341-782c-4fe8-9fd6-d3d9ba37bab2","name":"Set (UTC Default)1"}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Get Last N Messages","type":"main","index":0}]]},"Get Token":{"main":[[{"node":"Get Time Zone from Primary Calendar","type":"main","index":0}]]},"Get Time Zone from Primary Calendar":{"main":[[{"node":"Upsert (Calendar Settings)","type":"main","index":0}],[{"node":"Set (UTC Default)1","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"LLM Verifier","type":"ai_outputParser","index":0}]]},"4.1":{"ai_languageModel":[[{"node":"Structured Output Parser","type":"ai_languageModel","index":0}]]},"LLM Verifier":{"main":[[{"node":"Confident Output?","type":"main","index":0}]]},"Upsert (Chat)":{"main":[[{"node":"Set (Chat)","type":"main","index":0}]]},"Upsert (Calendar Settings)":{"main":[[{"node":"Set (Calendar Settings)","type":"main","index":0}]]},"Get Last N Messages":{"main":[[{"node":"Messages?","type":"main","index":0}]]},"Get Cache":{"main":[[{"node":"Use Cache?","type":"main","index":0}]]},"Use Cache?":{"main":[[{"node":"Set (Cache)","type":"main","index":0}],[{"node":"LLM Verifier","type":"main","index":0}]]},"Messages?":{"main":[[{"node":"Get Cache","type":"main","index":0}],[{"node":"Get Cache [No Messages]","type":"main","index":0}]]},"Get Cache [No Messages]":{"main":[[{"node":"Use Cache? [No Messages]","type":"main","index":0}]]},"Use Cache? [No Messages]":{"main":[[{"node":"Set (Cache)","type":"main","index":0}],[{"node":"Get Token","type":"main","index":0}]]},"Confident Output?":{"main":[[{"node":"Upsert (Chat)","type":"main","index":0}],[{"node":"Get Token","type":"main","index":0}]]},"Claude 4.5":{"ai_languageModel":[[{"node":"LLM Verifier","type":"ai_languageModel","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"When Executed by Another Workflow":[{"json":{"userId":"t07ZDdtiVLduDE3RuRHGKowoSd0f"}}]},"versionId":"ce7e57f1-7a65-4d90-a928-bb5d7dd8b8c6","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-11-22T21:52:03.830Z","createdAt":"2025-11-22T21:52:03.830Z","role":"workflow:owner","workflowId":"NSHJ7N5HuSWzl9c0","projectId":"8nyfoRCh3nEYWaKJ"}],"activeVersion":null,"tags":[]}