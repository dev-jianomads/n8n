{"updatedAt":"2025-10-28T16:12:32.514Z","createdAt":"2025-07-16T21:35:33.884Z","id":"pE2lsrstziYiLtF8","name":"[TG] Get Token for Telegram Integration","active":false,"isArchived":false,"nodes":[{"parameters":{"workflowInputs":{"values":[{"name":"user_id"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-624,408],"id":"72694c80-6750-495c-a126-9e1dcf4bae4a","name":"When Executed by Another Workflow"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"05a3655d-1a5c-407e-abd9-b77305dc158a","leftValue":"={{ ($json.result === null || $json.result === undefined) ||  $json.result.is_expired }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-176,408],"id":"617d3043-169d-4fe1-9f78-3cf4010591fe","name":"Expired Token?"},{"parameters":{"assignments":{"assignments":[{"id":"cb8984ad-464a-45b8-9d96-89e6c213699e","name":"accessToken","value":"={{ $('Expired Token?').item.json.result.token }}","type":"string"},{"id":"c2055894-db45-4a28-8375-2472fde8585c","name":"user","value":"={{ $json.user }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[272,624],"id":"cb52d88e-f90c-4d83-b2ee-e7df78fc29bb","name":"Return Token and User"},{"parameters":{"assignments":{"assignments":[{"id":"ae218e7e-2994-42cf-82d0-81bd7deea876","name":"accessToken","value":"={{ $('Get New Token').item.json.body.access_token }}","type":"string"},{"id":"8d144ce4-10cf-4da7-9a48-3be19ea43eda","name":"user","value":"={{ $json.user }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[944,192],"id":"59cfe990-e4fb-44ff-8ee6-aa8dd7d3603d","name":"Return Refreshed Token & User"},{"parameters":{"method":"POST","url":"https://oauth2.googleapis.com/token","sendQuery":true,"queryParameters":{"parameters":[{"name":"client_id","value":"={{ $json.result.client_id }}"},{"name":"client_secret","value":"={{ $json.result.client_secret }}"},{"name":"refresh_token","value":"={{ $json.result.refresh_token }}"},{"name":"grant_type","value":"refresh_token"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[272,240],"id":"e7328c6b-8395-4051-949f-bbe7fc3b982a","name":"Get New Token","onError":"continueErrorOutput"},{"parameters":{"errorMessage":"Could not refresh token."},"type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[1168,408],"id":"ffbc2182-3f58-479b-b3ca-7b9d5b4fdf5e","name":"Stop and Error"},{"parameters":{"operation":"executeQuery","query":"SELECT public.update_calendar_token('{{ $('When Executed by Another Workflow').item.json.user_id }}', '{{ $json.body.access_token }}', {{ $json.body.expires_in }}) as result;\n","options":{"connectionTimeout":3}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[496,192],"id":"eea1054c-7235-4598-bd42-e0ae3256d7fd","name":"Store Token","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}},"onError":"continueErrorOutput"},{"parameters":{"operation":"executeQuery","query":"SELECT public.expire_calendar_refresh_token('{{ $('When Executed by Another Workflow').item.json.user_id }}') as result;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[496,408],"id":"9ede1388-3493-4547-a2bd-f8174d26ff9e","name":"Mark Token as Expired","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_calendar_token('{{ $json.user_id }}') as result;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-400,408],"id":"bb3b116a-f152-427f-affd-c54ba7fa2734","name":"Get Current Token","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_user_with_integrations('{{ $json.result.user_id }}') as user;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[720,192],"id":"281f91f7-7807-4978-811e-f5148ae900b1","name":"Get User with Integrations","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_user_with_integrations('{{ $('When Executed by Another Workflow').item.json.user_id }}') as user;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[48,624],"id":"8351ae86-15e9-4fbd-9b80-ed98a699bfde","name":"Get User & Integrations","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"operation":"executeQuery","query":"SELECT public.get_telegram_id('{{ $('When Executed by Another Workflow').item.json.user_id }}') as telegram_id;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[720,408],"id":"174faf44-0a42-468b-a59a-3c7625caf441","name":"Get User's Telegram ID","retryOnFail":true,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"workflowId":{"__rl":true,"value":"B4R5PCXZUaCSSdbV","mode":"list","cachedResultUrl":"/workflow/B4R5PCXZUaCSSdbV","cachedResultName":"[TG] Send Telegram Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{"telegramId":"={{ $('Get User\\'s Telegram ID').item.json.telegram_id }}","chatId":"={{ $('Get User\\'s Telegram ID').item.json.telegram_id }}","message":"=It seems we're having issues connecting to your Google Services. \n\nPlease log in again here: https://cal.hellotomo.ai?reauth=true&user_id={{$('When Executed by Another Workflow').first().json.user_id}}","toolActivity":"={{ [] }}"},"matchingColumns":[],"schema":[{"id":"telegramId","displayName":"telegramId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"chatId","displayName":"chatId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"toolActivity","displayName":"toolActivity","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[944,408],"id":"7dea841d-fa95-40fc-8e4f-b51b8d391389","name":"Call '[TG] Send Telegram Message'"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d474e458-1cd6-4100-bef8-d6140230d6ac","leftValue":"={{ $json.result.refresh_expired }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"b75175ba-2f5e-4a63-a278-5702d55fe642","leftValue":"={{ $json.result.refresh_expired }}","rightValue":"","operator":{"type":"boolean","operation":"empty","singleValue":true}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[48,312],"id":"3ae20f6b-e2b8-40c8-9a83-7fbf3f19cd70","name":"Refresh Active?"}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Get Current Token","type":"main","index":0}]]},"Expired Token?":{"main":[[{"node":"Refresh Active?","type":"main","index":0}],[{"node":"Get User & Integrations","type":"main","index":0}]]},"Get New Token":{"main":[[{"node":"Store Token","type":"main","index":0}],[{"node":"Mark Token as Expired","type":"main","index":0}]]},"Store Token":{"main":[[{"node":"Get User with Integrations","type":"main","index":0}]]},"Mark Token as Expired":{"main":[[{"node":"Get User's Telegram ID","type":"main","index":0}]]},"Get Current Token":{"main":[[{"node":"Expired Token?","type":"main","index":0}]]},"Get User with Integrations":{"main":[[{"node":"Return Refreshed Token & User","type":"main","index":0}]]},"Get User & Integrations":{"main":[[{"node":"Return Token and User","type":"main","index":0}]]},"Get User's Telegram ID":{"main":[[{"node":"Call '[TG] Send Telegram Message'","type":"main","index":0}]]},"Call '[TG] Send Telegram Message'":{"main":[[{"node":"Stop and Error","type":"main","index":0}]]},"Refresh Active?":{"main":[[{"node":"Get New Token","type":"main","index":0}],[{"node":"Mark Token as Expired","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"63JMaA3ATIsJVc6Y"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"user_id":"1IUzo3Dc3BdIwXUaaxxS4XlmKgn1"}}]},"versionId":"7afa1f88-8e64-4d05-9abc-343868b2768e","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-07-16T21:35:33.884Z","createdAt":"2025-07-16T21:35:33.884Z","role":"workflow:owner","workflowId":"pE2lsrstziYiLtF8","projectId":"8nyfoRCh3nEYWaKJ"}],"activeVersion":null,"tags":[]}