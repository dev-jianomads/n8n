{"createdAt":"2025-07-30T17:52:21.766Z","updatedAt":"2025-08-05T22:23:42.593Z","id":"dg1kGitTpEIxf9qr","name":"[TG] Vectorize Single User Contacts","active":false,"isArchived":false,"nodes":[{"parameters":{"workflowId":{"__rl":true,"value":"OH9PUovRKlvZel5e","mode":"list","cachedResultName":"[TG] Get Token for Telegram Integration"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $json.user_id }}"},"matchingColumns":["user_id"],"schema":[{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"mode":"each","options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-320,-288],"id":"eb299e3d-cfe7-4568-ab48-c2bd6f1fe037","name":"Get Token"},{"parameters":{"url":"=https://people.googleapis.com/v1/otherContacts","sendQuery":true,"queryParameters":{"parameters":[{"name":"readMask","value":"names,emailAddresses"},{"name":"pageSize","value":"500"},{"name":"pageToken"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.accessToken }}"},{"name":"Content-Type","value":"application/json"}]},"options":{"pagination":{"pagination":{"parameters":{"parameters":[{"name":"pageToken","value":"={{ $response.body[\"nextPageToken\"] }}"}]},"paginationCompleteWhen":"other","completeExpression":"={{ $response.body[\"nextPageToken\"] === undefined || $response.body[\"nextPageToken\"] === null }}","requestInterval":30000}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-96,-288],"id":"f774c8bb-d047-46f4-9e58-5421db089578","name":"Search Other Contacts","retryOnFail":true,"alwaysOutputData":false,"onError":"continueErrorOutput"},{"parameters":{"mode":"insert","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[1264,-288],"id":"ae2c6825-c191-4984-8ec4-a8dfadff3dd8","name":"Postgres PGVector Store","retryOnFail":true,"waitBetweenTries":5000,"maxTries":5,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}}},{"parameters":{"options":{"stripNewLines":true}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[1248,-64],"id":"b606f739-b3b2-43a6-9d5c-a7b38f55a410","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"JNBPFneOXwzjzSKh","name":"OpenAI account"}}},{"parameters":{"jsonMode":"expressionData","jsonData":"=Names:\n{{ JSON.stringify($json.names ?? []) }}\n\nEmails:\n{{ JSON.stringify($json.emailAddresses ?? []) }}","textSplittingMode":"custom","options":{"metadata":{"metadataValues":[{"name":"user_id","value":"={{ $('Code').item.json.userId }}"}]}}},"type":"@n8n/n8n-nodes-langchain.documentDefaultDataLoader","typeVersion":1.1,"position":[1376,-64],"id":"38e19109-7833-4321-8f18-6a7e8234e155","name":"Default Data Loader"},{"parameters":{"chunkOverlap":20,"options":{}},"type":"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter","typeVersion":1,"position":[1472,160],"id":"13c405aa-90d4-4fb1-a40c-bba3ef27d669","name":"Recursive Character Text Splitter"},{"parameters":{"aggregate":"aggregateAllItemData","include":"specifiedFields","fieldsToInclude":"otherContacts","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[128,-288],"id":"c48c7da6-91f0-4faf-9ae4-d109e3db14d8","name":"Aggregate"},{"parameters":{"jsCode":"\nlet contacts = []\nfor (const item of $input.first().json.data) {\n  contacts = contacts.concat(item.otherContacts);\n}\n\nreturn {\n  json: {\n    contacts,\n    userId: $('Get Token').first().json.user.id\n  }\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[352,-288],"id":"ef9aba3d-f42f-438c-95e7-76784f82cf58","name":"Code"},{"parameters":{"fieldToSplitOut":"contacts","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[576,-288],"id":"17153bc9-393d-4e96-83d6-18262d3db4d7","name":"Split Out"},{"parameters":{"operation":"executeQuery","query":"DELETE FROM n8n_vectors\nWHERE metadata->>'user_id' = '{{ $('Code').item.json.userId }}'","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[800,-352],"id":"69421000-34c1-423b-87e9-cf36a1b275a9","name":"Delete Vectors","retryOnFail":true,"maxTries":5,"waitBetweenTries":5000,"credentials":{"postgres":{"id":"hcrXy03eb7cfXzVe","name":"Supabase TX Pooler"}},"onError":"continueErrorOutput"},{"parameters":{"workflowInputs":{"values":[{"name":"user_id"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-544,-288],"id":"272a4e0d-ee56-42c0-8eb9-13777a9aed56","name":"When Executed by Another Workflow"},{"parameters":{"mode":"chooseBranch","useDataOfInput":2},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1024,-288],"id":"7bbef61a-e4f8-4e7e-9336-597bc3a6475b","name":"Merge"}],"connections":{"Get Token":{"main":[[{"node":"Search Other Contacts","type":"main","index":0}]]},"Search Other Contacts":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Postgres PGVector Store","type":"ai_embedding","index":0}]]},"Default Data Loader":{"ai_document":[[{"node":"Postgres PGVector Store","type":"ai_document","index":0}]]},"Recursive Character Text Splitter":{"ai_textSplitter":[[{"node":"Default Data Loader","type":"ai_textSplitter","index":0}]]},"Aggregate":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"Delete Vectors","type":"main","index":0},{"node":"Merge","type":"main","index":1}]]},"Delete Vectors":{"main":[[{"node":"Merge","type":"main","index":0}]]},"When Executed by Another Workflow":{"main":[[{"node":"Get Token","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Postgres PGVector Store","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"When Executed by Another Workflow":[{"json":{"name":"First item","code":1}},{"json":{"name":"Second item","code":2}}]},"versionId":"898a6cba-53fe-48ec-83d2-ed090b2a9b27","triggerCount":0,"shared":[{"createdAt":"2025-07-30T17:52:21.766Z","updatedAt":"2025-07-30T17:52:21.766Z","role":"workflow:owner","workflowId":"dg1kGitTpEIxf9qr","projectId":"8nyfoRCh3nEYWaKJ"}],"tags":[]}